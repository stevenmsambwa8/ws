<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Keli Admin</title>
<link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
--bg: #f5f6fa;
--bg2: #eef0f6;
--white: #ffffff;
--border: #e3e6ef;
--border2: #d0d5e8;
--text: #141928;
--text2: #4a5074;
--text3: #8b93b8;
--indigo: #4f46e5;
--indigo-l: #ede9fe;
--indigo-m: #c4b5fd;
--violet: #7c3aed;
--emerald: #059669;
--emerald-l: #d1fae5;
--amber: #d97706;
--amber-l: #fef3c7;
--rose: #e11d48;
--rose-l: #ffe4e6;
--grad: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
--shadow-xs: 0 1px 3px rgba(20,25,40,0.06);
--shadow-sm: 0 2px 8px rgba(20,25,40,0.08);
--shadow-md: 0 4px 16px rgba(20,25,40,0.10);
--shadow-lg: 0 8px 32px rgba(20,25,40,0.14);
--r-sm: 8px;
--r: 12px;
--r-lg: 16px;
--r-xl: 20px;
--header-h: 56px;
--tab-h: 48px;
--sidebar-w: 220px;
}

/* ─── DARK MODE ─── */
[data-theme="dark"] {
--bg: #08090d;
--bg2: #0f1117;
--white: #13161f;
--border: #1e2235;
--border2: #272d42;
--text: #e4e7f5;
--text2: #8891b8;
--text3: #454e72;
--indigo-l: rgba(79,70,229,0.12);
--indigo-m: rgba(79,70,229,0.3);
--emerald-l: rgba(5,150,105,0.12);
--amber-l: rgba(217,119,6,0.12);
--rose-l: rgba(225,29,72,0.12);
--shadow-xs: 0 1px 3px rgba(0,0,0,0.5);
--shadow-sm: 0 2px 8px rgba(0,0,0,0.5);
--shadow-md: 0 4px 16px rgba(0,0,0,0.6);
--shadow-lg: 0 8px 32px rgba(0,0,0,0.7);
}
/* Force dark backgrounds on elements that use hardcoded colors */
[data-theme="dark"] body { background: #08090d; }
[data-theme="dark"] .modal-sheet { background: #13161f; }
[data-theme="dark"] .cmd-box { background: #13161f; }
[data-theme="dark"] #profileDrawer { background: #13161f; }
[data-theme="dark"] .modal-footer { background: #0f1117; }
[data-theme="dark"] #loadingOverlay { background: #08090d; }
[data-theme="dark"] .sidebar { background: #0f1117; border-right-color: #1e2235; }
[data-theme="dark"] .header { background: #0f1117; border-bottom-color: #1e2235; }
[data-theme="dark"] .tabs-wrap { background: #0f1117; border-bottom-color: #1e2235; }
[data-theme="dark"] .toolbar { background: #08090d; }
[data-theme="dark"] .data-table thead { background: #0f1117; }
[data-theme="dark"] .data-table tbody tr:hover { background: #0f1117; }
[data-theme="dark"] .form-grp textarea,
[data-theme="dark"] .form-grp input[type="text"],
[data-theme="dark"] .form-grp input[type="email"],
[data-theme="dark"] .form-grp input[type="number"],
[data-theme="dark"] .form-grp select { background: #0f1117; border-color: #1e2235; color: #e4e7f5; }
[data-theme="dark"] .search-bar input { background: #13161f; border-color: #1e2235; color: #e4e7f5; }
[data-theme="dark"] .count-input-wrap input { background: #0f1117; border-color: #1e2235; color: #e4e7f5; }
[data-theme="dark"] .ucheck { color: #e4e7f5; }
[data-theme="dark"] .toggle-row { background: #0f1117; border-color: #1e2235; }
[data-theme="dark"] .rmode-btn { background: #0f1117; border-color: #1e2235; color: #8891b8; }
[data-theme="dark"] .role-chip { background: #0f1117; border-color: #1e2235; }
[data-theme="dark"] .count-control-row { background: #0f1117; border-color: #1e2235; }
[data-theme="dark"] .preview-box { background: #0f1117; border-color: #1e2235; }
[data-theme="dark"] .toast { background: #1e2235; }
[data-theme="dark"] .close-btn { background: #0f1117; border-color: #1e2235; color: #8891b8; }
[data-theme="dark"] .act-btn:hover { background: #0f1117; }
[data-theme="dark"] .act-btn.view:hover { background: rgba(79,70,229,0.12); }
[data-theme="dark"] .act-btn.edit:hover { background: rgba(217,119,6,0.12); }
[data-theme="dark"] .act-btn.promote:hover { background: rgba(5,150,105,0.12); }
[data-theme="dark"] .act-btn.del:hover { background: rgba(225,29,72,0.12); }
[data-theme="dark"] .profile-hero { background: linear-gradient(180deg, #0f1117 0%, #08090d 100%); }
[data-theme="dark"] .chart-card { background: #13161f; border-color: #1e2235; }
[data-theme="dark"] .panel { background: #13161f; border-color: #1e2235; }
[data-theme="dark"] .stat-card { background: #13161f; border-color: #1e2235; }
[data-theme="dark"] .qaction { background: #13161f; border-color: #1e2235; }
[data-theme="dark"] .tab { color: #454e72; }
[data-theme="dark"] .tab:hover { color: #8891b8; }
[data-theme="dark"] .tab.active { color: var(--indigo); }
[data-theme="dark"] .nav-item { color: #454e72; }
[data-theme="dark"] .nav-item:hover { background: #0f1117; color: #8891b8; }
[data-theme="dark"] .nav-item.active { background: rgba(79,70,229,0.12); color: var(--indigo); }
[data-theme="dark"] .link-input-row { background: #0f1117; border-color: #1e2235; }
[data-theme="dark"] .link-input-row input { background: #13161f; border-color: #1e2235; color: #e4e7f5; }
[data-theme="dark"] .btn-secondary { background: #13161f; border-color: #1e2235; }
[data-theme="dark"] .btn-export { background: #0f1117; border-color: #1e2235; }
[data-theme="dark"] .cmd-item { color: #e4e7f5; }
[data-theme="dark"] .cmd-item:hover, [data-theme="dark"] .cmd-item.selected { background: rgba(79,70,229,0.12); }
[data-theme="dark"] .cmd-input-row { border-bottom-color: #1e2235; }
[data-theme="dark"] .cmd-input-row input { color: #e4e7f5; }
[data-theme="dark"] .count-adj-btn { background: #13161f; border-color: #1e2235; color: #8891b8; }
[data-theme="dark"] .link-toolbar-btn { background: #0f1117; border-color: #1e2235; color: #8891b8; }
[data-theme="dark"] .sidebar-footer-btn { color: #8891b8; }
[data-theme="dark"] .sidebar-footer-btn:hover { background: #0f1117; }
[data-theme="dark"] .profile-section { border-bottom-color: #1e2235; }
[data-theme="dark"] .leaderboard-item { border-bottom-color: #1e2235; }
[data-theme="dark"] .health-row { border-bottom-color: #1e2235; }
[data-theme="dark"] .notif-row { border-bottom-color: #1e2235; }
[data-theme="dark"] .activity-item { border-bottom-color: #1e2235; }
[data-theme="dark"] .modal-hdr { border-bottom-color: #1e2235; }
[data-theme="dark"] .section-label { border-bottom-color: #1e2235; }
[data-theme="dark"] .collapse-section { border-bottom-color: #1e2235; }
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);line-height:1.55;-webkit-font-smoothing:antialiased;overflow-x:hidden;min-height:100vh;}

/* ─── LOADING ─── */
#loadingOverlay{position:fixed;inset:0;background:white;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:18px;transition:opacity 0.35s;}
[data-theme="dark"] #loadingOverlay{background:#0f1117;}
.load-logo{font-size:28px;font-weight:800;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-0.04em;}
.load-ring{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--indigo);border-radius:50%;animation:spin 0.75s linear infinite;}
.load-msg{font-size:13px;color:var(--text3);font-weight:500;}
@keyframes spin{to{transform:rotate(360deg);}}

/* ─── LAYOUT ─── */
#app{display:flex;flex-direction:column;min-height:100vh;}
.app-body{display:flex;flex:1;}

/* ─── SIDEBAR ─── */
.sidebar{width:var(--sidebar-w);background:var(--white);border-right:1px solid var(--border);display:flex;flex-direction:column;position:sticky;top:0;height:100vh;flex-shrink:0;overflow-y:auto;transition:width 0.25s,transform 0.25s;box-shadow:var(--shadow-xs);z-index:200;}
.sidebar-logo-row{padding:16px 14px 12px;display:flex;align-items:center;gap:10px;border-bottom:1px solid var(--border);}
.sidebar-logo{font-size:20px;font-weight:800;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-0.04em;}
.sidebar-chip{background:var(--indigo-l);color:var(--indigo);font-size:10px;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;padding:3px 8px;border-radius:999px;}
.sidebar-admin{padding:10px 14px;border-bottom:1px solid var(--border);}
.sidebar-admin-name{font-size:13px;font-weight:700;color:var(--text);}
.sidebar-admin-sub{font-size:11px;color:var(--text3);margin-top:1px;}
.sidebar-nav{padding:8px 8px;flex:1;}
.sidebar-section-label{font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.08em;padding:6px 8px 4px;}
.nav-item{display:flex;align-items:center;gap:10px;padding:9px 10px;border-radius:var(--r);cursor:pointer;color:var(--text2);font-size:13px;font-weight:600;transition:all 0.15s;border:none;background:none;font-family:inherit;width:100%;text-align:left;-webkit-tap-highlight-color:transparent;position:relative;}
.nav-item i{font-size:16px;flex-shrink:0;width:20px;text-align:center;}
.nav-item:hover{background:var(--bg);color:var(--text);}
.nav-item.active{background:var(--indigo-l);color:var(--indigo);font-weight:700;}
.nav-item.active i{color:var(--indigo);}
.nav-badge{margin-left:auto;background:var(--indigo);color:white;font-size:10px;font-weight:700;padding:2px 7px;border-radius:999px;min-width:20px;text-align:center;}
.sidebar-footer{padding:10px 8px;border-top:1px solid var(--border);display:flex;flex-direction:column;gap:4px;}
.sidebar-footer-btn{display:flex;align-items:center;gap:9px;padding:9px 10px;border-radius:var(--r);cursor:pointer;color:var(--text2);font-size:13px;font-weight:600;transition:all 0.15s;border:none;background:none;font-family:inherit;width:100%;text-align:left;}
.sidebar-footer-btn:hover{background:var(--bg);}
.sidebar-footer-btn.danger:hover{background:var(--rose-l);color:var(--rose);}
.sidebar-footer-btn i{font-size:16px;width:20px;text-align:center;flex-shrink:0;}

/* ─── MOBILE HEADER (replaces old header on mobile) ─── */
.header{height:var(--header-h);position:sticky;top:0;z-index:300;background:var(--white);border-bottom:1px solid var(--border);box-shadow:var(--shadow-xs);display:flex;align-items:center;padding:0 16px;gap:10px;}
.header-logo{font-size:20px;font-weight:800;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-0.04em;flex-shrink:0;}
.header-chip{background:var(--indigo-l);color:var(--indigo);font-size:10px;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;padding:3px 8px;border-radius:999px;flex-shrink:0;}
.header-spacer{flex:1;}
#adminName{font-size:12px;color:var(--text3);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:110px;}
.logout-btn{background:none;border:1px solid var(--border2);color:var(--text2);padding:7px 13px;border-radius:999px;cursor:pointer;font-size:13px;font-family:inherit;font-weight:600;display:flex;align-items:center;gap:6px;flex-shrink:0;transition:all 0.2s;white-space:nowrap;}
.logout-btn:hover{border-color:var(--rose);color:var(--rose);background:var(--rose-l);}
.menu-toggle-btn{display:none;background:none;border:1px solid var(--border2);color:var(--text2);width:36px;height:36px;border-radius:var(--r-sm);cursor:pointer;font-size:16px;align-items:center;justify-content:center;}
.dark-toggle{background:none;border:1px solid var(--border2);color:var(--text2);width:36px;height:36px;border-radius:var(--r-sm);cursor:pointer;font-size:16px;display:flex;align-items:center;justify-content:center;transition:all 0.2s;flex-shrink:0;}
.dark-toggle:hover{background:var(--indigo-l);color:var(--indigo);border-color:var(--indigo-m);}

/* ─── MAIN CONTENT AREA ─── */
.main-content{flex:1;min-width:0;overflow-x:hidden;}
.page-header{padding:14px 20px 0;display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap;}
.page-title{font-size:20px;font-weight:800;color:var(--text);letter-spacing:-0.03em;}
.page-title span{color:var(--indigo);}
.page-subtitle{font-size:13px;color:var(--text3);margin-top:2px;font-weight:500;}

/* ─── COMMAND PALETTE ─── */
#cmdOverlay{position:fixed;inset:0;background:rgba(10,12,30,0.6);backdrop-filter:blur(6px);z-index:2000;display:none;align-items:flex-start;justify-content:center;padding-top:15vh;}
#cmdOverlay.open{display:flex;animation:fadeIn 0.15s ease;}
.cmd-box{background:var(--white);border-radius:16px;width:100%;max-width:560px;box-shadow:0 20px 60px rgba(0,0,0,0.2),0 0 0 1px var(--border);overflow:hidden;}
.cmd-input-row{display:flex;align-items:center;gap:10px;padding:14px 16px;border-bottom:1px solid var(--border);}
.cmd-input-row i{font-size:18px;color:var(--text3);}
.cmd-input-row input{flex:1;background:none;border:none;outline:none;font-size:15px;color:var(--text);font-family:inherit;font-weight:500;}
.cmd-input-row input::placeholder{color:var(--text3);}
.cmd-kbd{font-size:11px;font-weight:700;color:var(--text3);background:var(--bg);border:1px solid var(--border);border-radius:5px;padding:2px 6px;font-family:'JetBrains Mono',monospace;}
.cmd-results{max-height:380px;overflow-y:auto;}
.cmd-group-label{font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.08em;padding:10px 16px 5px;}
.cmd-item{display:flex;align-items:center;gap:12px;padding:10px 16px;cursor:pointer;transition:background 0.1s;border:none;background:none;width:100%;font-family:inherit;text-align:left;}
.cmd-item:hover,.cmd-item.selected{background:var(--indigo-l);}
.cmd-item i{font-size:17px;color:var(--indigo);background:var(--indigo-l);padding:7px;border-radius:9px;flex-shrink:0;}
.cmd-item:hover i,.cmd-item.selected i{background:var(--indigo);color:white;}
.cmd-item-title{font-size:13px;font-weight:700;color:var(--text);}
.cmd-item-sub{font-size:11px;color:var(--text3);margin-top:1px;}
.cmd-item-kbd{margin-left:auto;font-size:11px;color:var(--text3);background:var(--bg);border:1px solid var(--border);border-radius:4px;padding:2px 5px;font-family:'JetBrains Mono',monospace;}
.cmd-empty{padding:32px 16px;text-align:center;color:var(--text3);font-size:13px;}

/* ─── BULK ACTIONS ─── */
.bulk-bar{display:none;align-items:center;gap:8px;padding:8px 12px;background:var(--indigo-l);border:1px solid var(--indigo-m);border-radius:var(--r);margin:0 14px 10px;animation:slideDown 0.2s ease;}
.bulk-bar.visible{display:flex;}
@keyframes slideDown{from{opacity:0;transform:translateY(-6px);}to{opacity:1;transform:translateY(0);}}
.bulk-count{font-size:13px;font-weight:700;color:var(--indigo);flex:1;}
.bulk-btn{padding:6px 12px;border-radius:999px;font-size:12px;font-weight:700;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:5px;font-family:inherit;transition:all 0.15s;}
.bulk-btn-del{background:var(--rose);color:white;}
.bulk-btn-del:hover{background:#c81d42;}
.bulk-btn-cancel{background:var(--white);border:1px solid var(--border2);color:var(--text2);}
.bulk-btn-cancel:hover{background:var(--bg);}

/* ─── EXPORT BTN ─── */
.btn-export{background:var(--bg);border:1px solid var(--border2);color:var(--text2);padding:9px 14px;border-radius:999px;font-weight:700;font-size:13px;cursor:pointer;display:inline-flex;align-items:center;gap:6px;font-family:inherit;transition:all 0.18s;white-space:nowrap;}
.btn-export:hover{border-color:var(--emerald);color:var(--emerald);background:var(--emerald-l);}

/* ─── CHARTS ─── */
.dashboard-grid{display:grid;grid-template-columns:1fr;gap:14px;padding:14px;}
@media(min-width:900px){.dashboard-grid{grid-template-columns:1.6fr 1fr;}}
.chart-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r-lg);padding:16px;box-shadow:var(--shadow-xs);}
.chart-card-hdr{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px;}
.chart-card-title{font-size:14px;font-weight:700;color:var(--text);}
.chart-card-sub{font-size:12px;color:var(--text3);margin-top:2px;}
canvas#activityChart{max-height:200px;}

/* ─── TOP USERS LEADERBOARD ─── */
.leaderboard-item{display:flex;align-items:center;gap:10px;padding:9px 0;border-bottom:1px solid var(--border);}
.leaderboard-item:last-child{border-bottom:none;}
.lb-rank{width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:11px;font-weight:800;flex-shrink:0;}
.lb-rank-1{background:linear-gradient(135deg,#f59e0b,#fbbf24);color:white;}
.lb-rank-2{background:linear-gradient(135deg,#94a3b8,#cbd5e1);color:white;}
.lb-rank-3{background:linear-gradient(135deg,#cd7c2b,#d97706);color:white;}
.lb-rank-n{background:var(--bg2);color:var(--text3);}
.lb-name{font-size:13px;font-weight:700;color:var(--text);}
.lb-sub{font-size:11px;color:var(--text3);margin-top:1px;}
.lb-score{margin-left:auto;font-size:13px;font-weight:800;color:var(--indigo);}
.lb-bar-wrap{width:60px;height:5px;background:var(--bg2);border-radius:3px;margin-top:3px;}
.lb-bar{height:5px;background:var(--grad);border-radius:3px;transition:width 0.6s cubic-bezier(0.34,1.04,0.64,1);}

/* ─── PLATFORM HEALTH ─── */
.health-row{display:flex;align-items:center;gap:12px;padding:9px 0;border-bottom:1px solid var(--border);}
.health-row:last-child{border-bottom:none;}
.health-icon{width:32px;height:32px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}
.health-label{font-size:13px;font-weight:600;color:var(--text);flex:1;}
.health-value{font-size:13px;font-weight:800;color:var(--text);}
.health-status{width:8px;height:8px;border-radius:50%;flex-shrink:0;}
.status-ok{background:var(--emerald);box-shadow:0 0 0 3px var(--emerald-l);}
.status-warn{background:var(--amber);box-shadow:0 0 0 3px var(--amber-l);}

/* ─── ANIMATED STAT COUNTERS ─── */
.stat-value{font-size:26px;font-weight:800;letter-spacing:-0.04em;color:var(--text);line-height:1.1;transition:color 0.3s;}
.stat-trend{display:inline-flex;align-items:center;gap:3px;font-size:11px;font-weight:700;padding:2px 6px;border-radius:999px;margin-top:4px;}
.trend-up{color:var(--emerald);background:var(--emerald-l);}
.trend-down{color:var(--rose);background:var(--rose-l);}
.trend-flat{color:var(--text3);background:var(--bg2);}

/* ─── FAB ─── */
.fab{position:fixed;bottom:24px;right:20px;z-index:500;width:52px;height:52px;border-radius:50%;background:var(--grad);color:white;border:none;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:22px;box-shadow:0 4px 18px rgba(79,70,229,0.4);transition:all 0.2s;-webkit-tap-highlight-color:transparent;}
.fab:hover{transform:scale(1.1);box-shadow:0 6px 24px rgba(79,70,229,0.5);}
.fab:active{transform:scale(0.95);}

/* ─── USER PROFILE QUICK-VIEW ─── */
#profileDrawer{position:fixed;top:0;right:0;height:100%;width:320px;max-width:100%;background:var(--white);border-left:1px solid var(--border);box-shadow:var(--shadow-lg);z-index:1500;transform:translateX(100%);transition:transform 0.3s cubic-bezier(0.34,1.04,0.64,1);overflow-y:auto;}
#profileDrawer.open{transform:translateX(0);}
.profile-drawer-hdr{padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;position:sticky;top:0;background:var(--white);z-index:1;}
.profile-drawer-hdr h3{font-size:15px;font-weight:700;flex:1;}
.profile-hero{padding:20px 16px;text-align:center;border-bottom:1px solid var(--border);background:var(--bg);}
.profile-hero img{width:64px;height:64px;border-radius:50%;object-fit:cover;border:3px solid var(--border);margin-bottom:8px;}
.profile-hero-name{font-size:17px;font-weight:800;color:var(--text);}
.profile-hero-email{font-size:12px;color:var(--text3);margin-top:2px;}
.profile-hero-badges{margin-top:8px;display:flex;justify-content:center;gap:6px;flex-wrap:wrap;}

/* Collapsible section */
.collapse-section{border-bottom:1px solid var(--border);}
.collapse-trigger{display:flex;align-items:center;gap:8px;padding:11px 16px;cursor:pointer;background:none;border:none;width:100%;font-family:inherit;font-size:13px;font-weight:700;color:var(--text2);text-align:left;transition:background 0.12s;-webkit-tap-highlight-color:transparent;}
.collapse-trigger:hover{background:var(--bg);}
.collapse-trigger i.section-icon{font-size:15px;color:var(--indigo);background:var(--indigo-l);padding:5px;border-radius:7px;}
.collapse-trigger .chevron{margin-left:auto;font-size:14px;color:var(--text3);transition:transform 0.2s;}
.collapse-section.open .chevron{transform:rotate(180deg);}
.collapse-body{display:none;padding:4px 16px 12px;}
.collapse-section.open .collapse-body{display:block;}
.profile-kv{display:flex;justify-content:space-between;align-items:center;padding:5px 0;border-bottom:1px solid var(--border);gap:8px;}
.profile-kv:last-child{border-bottom:none;}
.profile-kv-key{font-size:12px;color:var(--text3);font-weight:600;flex-shrink:0;}
.profile-kv-val{font-size:12px;font-weight:700;color:var(--text);text-align:right;}
.profile-drawer-actions{padding:12px 16px;display:flex;flex-direction:column;gap:7px;border-top:1px solid var(--border);}
[data-theme="dark"] .profile-drawer-hdr{background:#13161f;}

/* ─── SIDEBAR OVERLAY (mobile) ─── */
.sidebar-overlay{display:none;position:fixed;inset:0;background:rgba(10,12,30,0.5);z-index:199;}
.sidebar-overlay.open{display:block;}

/* ─── RESPONSIVE LAYOUT ─── */
@media(max-width:768px){
  .sidebar{position:fixed;top:0;left:0;height:100%;transform:translateX(-100%);z-index:400;}
  .sidebar.open{transform:translateX(0);box-shadow:var(--shadow-lg);}
  .menu-toggle-btn{display:flex;}
  .tabs-wrap{display:none !important;}
}
@media(min-width:769px){
  .header .header-logo,.header .header-chip,.header .menu-toggle-btn{display:none;}
  #adminName,.logout-btn{display:none;}
}

/* ─── CHECKBOX FOR BULK SELECT ─── */
.row-check{width:16px;height:16px;accent-color:var(--indigo);cursor:pointer;}
th.check-th,td.check-td{width:40px;padding-left:14px !important;}

/* ─── COMMAND CENTER BANNER ─── */
.cmd-center{background:linear-gradient(135deg,#1a0533 0%,#0d0d1a 40%,#001a33 100%);border-bottom:1px solid rgba(79,70,229,0.3);padding:16px 20px;display:flex;align-items:center;gap:16px;flex-wrap:wrap;position:relative;overflow:hidden;}
.cmd-center::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at 30% 50%,rgba(79,70,229,0.15) 0%,transparent 70%),radial-gradient(ellipse at 70% 50%,rgba(124,58,237,0.1) 0%,transparent 70%);pointer-events:none;}
.cmd-center-left{display:flex;align-items:center;gap:14px;flex:1;min-width:200px;}
.cmd-center-avatar{width:42px;height:42px;border-radius:50%;border:2px solid rgba(79,70,229,0.6);background:linear-gradient(135deg,#4f46e5,#7c3aed);display:flex;align-items:center;justify-content:center;font-size:18px;color:white;flex-shrink:0;box-shadow:0 0 16px rgba(79,70,229,0.4);}
.cmd-center-name{font-size:15px;font-weight:800;color:white;letter-spacing:-0.02em;}
.cmd-center-role{display:flex;align-items:center;gap:6px;margin-top:3px;}
.admin-badge{background:linear-gradient(90deg,#4f46e5,#7c3aed);color:white;font-size:10px;font-weight:800;letter-spacing:0.08em;text-transform:uppercase;padding:3px 9px;border-radius:999px;display:inline-flex;align-items:center;gap:4px;}
.admin-badge i{font-size:11px;}
.live-dot{width:7px;height:7px;border-radius:50%;background:#10b981;box-shadow:0 0 0 2px rgba(16,185,129,0.3);animation:livePulse 2s ease-in-out infinite;flex-shrink:0;}
@keyframes livePulse{0%,100%{box-shadow:0 0 0 2px rgba(16,185,129,0.3);}50%{box-shadow:0 0 0 6px rgba(16,185,129,0.1);}}
.cmd-center-right{display:flex;flex-direction:column;align-items:flex-end;gap:4px;}
.live-clock{font-family:'JetBrains Mono',monospace;font-size:22px;font-weight:700;color:white;letter-spacing:0.05em;line-height:1;}
.live-date{font-size:11px;color:rgba(255,255,255,0.4);font-weight:500;}
.session-timer{font-size:11px;color:rgba(255,255,255,0.35);font-family:'JetBrains Mono',monospace;}

/* ─── STAT CARDS — POWER REDESIGN ─── */
.stat-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r-lg);padding:16px;box-shadow:var(--shadow-xs);position:relative;overflow:hidden;transition:box-shadow 0.2s,transform 0.15s;cursor:default;}
.stat-card:hover{box-shadow:var(--shadow-md);transform:translateY(-2px);}
.stat-card::before{content:'';position:absolute;top:-20px;right:-20px;width:80px;height:80px;border-radius:50%;opacity:0.06;}
.s-indigo::before{background:var(--indigo);}
.s-emerald::before{background:var(--emerald);}
.s-amber::before{background:var(--amber);}
.s-rose::before{background:var(--rose);}
.stat-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;}
.s-indigo::after{background:linear-gradient(90deg,#4f46e5,#7c3aed);}
.s-emerald::after{background:linear-gradient(90deg,#059669,#10b981);}
.s-amber::after{background:linear-gradient(90deg,#d97706,#f59e0b);}
.s-rose::after{background:linear-gradient(90deg,#e11d48,#f43f5e);}
.stat-icon{width:38px;height:38px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:18px;margin-bottom:12px;}
.stat-value{font-size:30px;font-weight:800;letter-spacing:-0.05em;color:var(--text);line-height:1;}
.stat-label{font-size:10px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:0.08em;margin-bottom:4px;}
.stat-sub{font-size:11px;color:var(--text3);margin-top:4px;font-weight:500;}

/* ─── POWER ACTIONS GRID ─── */
.power-actions{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:14px;}
@media(min-width:600px){.power-actions{grid-template-columns:repeat(4,1fr);}}
.paction{background:var(--white);border:1px solid var(--border);border-radius:var(--r-lg);padding:14px 12px;display:flex;flex-direction:column;align-items:flex-start;gap:8px;cursor:pointer;transition:all 0.2s;position:relative;overflow:hidden;}
.paction::before{content:'';position:absolute;inset:0;opacity:0;transition:opacity 0.2s;}
.paction:hover::before{opacity:1;}
.paction:hover{transform:translateY(-2px);box-shadow:var(--shadow-md);}
.paction-icon{width:36px;height:36px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:17px;flex-shrink:0;transition:transform 0.2s;}
.paction:hover .paction-icon{transform:scale(1.1);}
.paction-title{font-size:13px;font-weight:800;color:var(--text);line-height:1.2;position:relative;}
.paction-sub{font-size:11px;color:var(--text3);margin-top:1px;position:relative;}
/* Action color variants */
.pa-indigo{border-color:var(--indigo-m);}
.pa-indigo::before{background:linear-gradient(135deg,rgba(79,70,229,0.05),rgba(124,58,237,0.05));}
.pa-indigo:hover{border-color:var(--indigo);}
.pa-indigo .paction-icon{background:var(--indigo-l);color:var(--indigo);}
.pa-emerald{border-color:rgba(5,150,105,0.2);}
.pa-emerald::before{background:linear-gradient(135deg,rgba(5,150,105,0.05),rgba(16,185,129,0.05));}
.pa-emerald:hover{border-color:var(--emerald);}
.pa-emerald .paction-icon{background:var(--emerald-l);color:var(--emerald);}
.pa-amber{border-color:rgba(217,119,6,0.2);}
.pa-amber::before{background:linear-gradient(135deg,rgba(217,119,6,0.05),rgba(245,158,11,0.05));}
.pa-amber:hover{border-color:var(--amber);}
.pa-amber .paction-icon{background:var(--amber-l);color:var(--amber);}
.pa-rose{border-color:rgba(225,29,72,0.2);}
.pa-rose::before{background:linear-gradient(135deg,rgba(225,29,72,0.05),rgba(244,63,94,0.05));}
.pa-rose:hover{border-color:var(--rose);}
.pa-rose .paction-icon{background:var(--rose-l);color:var(--rose);}

/* ─── DANGER ZONE MODAL ─── */
#dangerModal .modal-sheet{border-top:3px solid var(--rose);}
.danger-confirm-input{width:100%;background:var(--bg);border:2px solid var(--rose);border-radius:var(--r-sm);padding:11px 13px;color:var(--text);font-size:14px;font-family:'JetBrains Mono',monospace;font-weight:500;outline:none;margin-top:8px;transition:box-shadow 0.2s;}
.danger-confirm-input:focus{box-shadow:0 0 0 3px rgba(225,29,72,0.15);}
.danger-warning{background:var(--rose-l);border:1px solid rgba(225,29,72,0.2);border-radius:var(--r-sm);padding:12px 14px;font-size:13px;color:var(--rose);font-weight:600;display:flex;gap:10px;align-items:flex-start;line-height:1.5;}

/* ─── REALTIME INDICATOR ─── */
.realtime-pill{display:inline-flex;align-items:center;gap:6px;background:rgba(16,185,129,0.1);border:1px solid rgba(16,185,129,0.25);border-radius:999px;padding:4px 10px;font-size:11px;font-weight:700;color:#10b981;white-space:nowrap;}

/* ─── DARK OVERRIDES for new elements ─── */
[data-theme="dark"] .cmd-center{background:linear-gradient(135deg,#0d0015 0%,#060608 40%,#00060f 100%);}
[data-theme="dark"] .paction{background:#13161f;border-color:#1e2235;}
[data-theme="dark"] .pa-indigo:hover,[data-theme="dark"] .pa-emerald:hover,[data-theme="dark"] .pa-amber:hover,[data-theme="dark"] .pa-rose:hover{background:#0f1117;}
.stat-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r-lg);padding:14px;box-shadow:var(--shadow-xs);position:relative;overflow:hidden;transition:box-shadow 0.2s,transform 0.15s;}
.stat-card:hover{box-shadow:var(--shadow-md);transform:translateY(-1px);}
.stat-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;}
.s-indigo::after{background:var(--indigo);}.s-emerald::after{background:var(--emerald);}.s-amber::after{background:var(--amber);}.s-rose::after{background:var(--rose);}
.stat-icon{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px;margin-bottom:10px;}
.s-indigo .stat-icon{background:var(--indigo-l);color:var(--indigo);}
.s-emerald .stat-icon{background:var(--emerald-l);color:var(--emerald);}
.s-amber .stat-icon{background:var(--amber-l);color:var(--amber);}
.s-rose .stat-icon{background:var(--rose-l);color:var(--rose);}
.stat-label{font-size:10px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:2px;}
.stat-value{font-size:26px;font-weight:800;letter-spacing:-0.04em;color:var(--text);line-height:1.1;}
.stat-sub{font-size:11px;color:var(--text3);margin-top:2px;font-weight:500;}

/* ─── QUICK ACTIONS ─── */
.quick-actions{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;padding:12px 14px;}
.qaction{background:var(--white);border:1px solid var(--border);border-radius:var(--r-lg);padding:13px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:all 0.2s;}
.qaction:hover{border-color:var(--indigo-m);box-shadow:var(--shadow-sm);transform:translateY(-1px);}
.qaction i{font-size:18px;color:var(--indigo);background:var(--indigo-l);padding:8px;border-radius:9px;flex-shrink:0;}
.qa-title{font-size:13px;font-weight:700;color:var(--text);line-height:1.2;}
.qa-sub{font-size:11px;color:var(--text3);margin-top:1px;}

/* ─── TABS ─── */
.tabs-wrap{background:var(--white);border-bottom:1px solid var(--border);box-shadow:var(--shadow-xs);position:sticky;top:var(--header-h);z-index:200;}
.tabs{display:flex;overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none;padding:0 10px;}
.tabs::-webkit-scrollbar{display:none;}
.tab{height:var(--tab-h);padding:0 14px;background:none;border:none;border-bottom:3px solid transparent;color:var(--text3);font-size:13px;font-weight:700;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:7px;white-space:nowrap;font-family:inherit;flex-shrink:0;margin-bottom:-1px;-webkit-tap-highlight-color:transparent;}
.tab:hover{color:var(--text2);}
.tab.active{color:var(--indigo);border-bottom-color:var(--indigo);}
.tab i{font-size:15px;}

/* ─── CONTENT ─── */
.tab-content{display:none;}
.tab-content.active{display:block;}
.panel{background:var(--white);border:1px solid var(--border);border-radius:var(--r-lg);margin:12px 14px;overflow:hidden;box-shadow:var(--shadow-xs);}

/* ─── TOOLBAR ─── */
.toolbar{padding:10px 12px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;border-bottom:1px solid var(--border);background:var(--bg);}
.search-bar{flex:1;min-width:160px;}
.search-bar input{width:100%;background:var(--white);border:1px solid var(--border2);border-radius:999px;padding:9px 14px;color:var(--text);font-size:13px;font-family:inherit;font-weight:500;outline:none;transition:all 0.2s;}
.search-bar input:focus{border-color:var(--indigo);box-shadow:0 0 0 3px rgba(79,70,229,0.1);}
.search-bar input::placeholder{color:var(--text3);}

/* ─── BUTTONS ─── */
.btn{padding:9px 16px;border-radius:999px;font-weight:700;font-size:13px;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:6px;font-family:inherit;transition:all 0.18s;white-space:nowrap;-webkit-tap-highlight-color:transparent;}
.btn:active{transform:scale(0.96);}
.btn-primary{background:var(--grad);color:white;box-shadow:0 2px 8px rgba(79,70,229,0.25);}
.btn-primary:hover{box-shadow:0 4px 14px rgba(79,70,229,0.35);transform:translateY(-1px);}
.btn-secondary{background:var(--white);border:1px solid var(--border2);color:var(--text2);}
.btn-secondary:hover{border-color:var(--indigo);color:var(--indigo);background:var(--indigo-l);}
.btn-sm{padding:6px 12px;font-size:12px;}

/* ─── TABLE ─── */
.table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
.data-table{width:100%;border-collapse:collapse;min-width:460px;}
.data-table thead{background:var(--bg);}
.data-table th{padding:10px 14px;text-align:left;color:var(--text3);font-size:10px;text-transform:uppercase;font-weight:700;letter-spacing:0.07em;border-bottom:1px solid var(--border);white-space:nowrap;}
.data-table td{padding:12px 14px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:middle;color:var(--text2);}
.data-table tbody tr{transition:background 0.12s;}
.data-table tbody tr:hover{background:var(--bg);}
.data-table tbody tr:last-child td{border-bottom:none;}

/* Mobile card layout */
@media(max-width:520px){
.data-table{min-width:unset;}
.data-table thead{display:none;}
.data-table,.data-table tbody,.data-table tr,.data-table td{display:block;width:100%;}
.data-table tr{border-bottom:1px solid var(--border);padding:10px 0;}
.data-table td{border-bottom:none;padding:4px 14px;display:flex;align-items:flex-start;gap:8px;min-height:28px;}
.data-table td::before{content:attr(data-label);font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;min-width:68px;flex-shrink:0;padding-top:1px;}
.data-table td.no-label::before{display:none;}
.data-table td.no-label{padding-top:8px;}
}

/* ─── USER CELL ─── */
.user-cell{display:flex;align-items:center;gap:9px;}
.user-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid var(--border);background:var(--bg2);flex-shrink:0;}
.user-name{font-weight:700;color:var(--text);font-size:13px;}
.user-sub{font-size:11px;color:var(--text3);}

/* ─── BADGES ─── */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:999px;font-size:10px;font-weight:700;letter-spacing:0.04em;text-transform:uppercase;white-space:nowrap;}
.badge-admin{background:var(--indigo-l);color:var(--indigo);}
.badge-user{background:var(--bg2);color:var(--text3);}
.badge-active{background:var(--emerald-l);color:var(--emerald);}
.badge-amber{background:var(--amber-l);color:var(--amber);}

/* ─── ACTION BUTTONS ─── */
.act-group{display:flex;align-items:center;gap:3px;flex-wrap:wrap;}
.act-btn{background:none;border:1px solid transparent;color:var(--text3);cursor:pointer;font-size:15px;width:34px;height:34px;min-width:34px;display:inline-flex;align-items:center;justify-content:center;border-radius:var(--r-sm);transition:all 0.15s;font-family:inherit;-webkit-tap-highlight-color:transparent;}
.act-btn:hover{background:var(--bg);border-color:var(--border2);}
.act-btn.view:hover{color:var(--indigo);background:var(--indigo-l);border-color:var(--indigo-m);}
.act-btn.edit:hover{color:var(--amber);background:var(--amber-l);border-color:#fde68a;}
.act-btn.promote:hover{color:var(--emerald);background:var(--emerald-l);border-color:#a7f3d0;}
.act-btn.del:hover{color:var(--rose);background:var(--rose-l);border-color:#fecdd3;}

/* ─── MODALS ─── */
.modal{display:none;position:fixed;inset:0;background:rgba(20,25,40,0.45);backdrop-filter:blur(4px);z-index:1000;align-items:flex-end;justify-content:center;}
.modal.active{display:flex;animation:fadeIn 0.2s ease;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
.modal-sheet{background:var(--white);border-radius:22px 22px 0 0;width:100%;max-width:640px;max-height:96vh;overflow-y:auto;animation:sheetUp 0.3s cubic-bezier(0.34,1.04,0.64,1);padding-bottom:env(safe-area-inset-bottom,16px);box-shadow:0 -4px 40px rgba(20,25,40,0.15);}
@keyframes sheetUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.modal-handle{width:40px;height:4px;background:var(--border2);border-radius:2px;margin:10px auto 14px;}
.modal-hdr{padding:0 16px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.modal-hdr h3{font-size:16px;font-weight:700;flex:1;color:var(--text);}
.modal-icon{font-size:20px;color:var(--indigo);}
.close-btn{width:32px;height:32px;border-radius:50%;background:var(--bg2);border:1px solid var(--border);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;transition:all 0.15s;flex-shrink:0;font-family:inherit;}
.close-btn:hover{background:var(--rose-l);border-color:#fecdd3;color:var(--rose);}
.form-grp{padding:14px 16px;}
.form-grp+.form-grp{padding-top:0;}
.form-grp label{display:block;font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:7px;}
.form-grp textarea,.form-grp input[type="text"],.form-grp input[type="email"],.form-grp input[type="number"]{width:100%;background:var(--bg);border:1px solid var(--border2);border-radius:var(--r-sm);padding:11px 13px;color:var(--text);font-size:14px;font-family:inherit;font-weight:500;resize:vertical;outline:none;transition:all 0.2s;}
.form-grp textarea:focus,.form-grp input:focus{border-color:var(--indigo);box-shadow:0 0 0 3px rgba(79,70,229,0.1);}
.form-grp textarea{min-height:90px;}
.form-grp select{width:100%;background:var(--bg);border:1px solid var(--border2);border-radius:var(--r-sm);padding:11px 13px;color:var(--text);font-size:14px;font-family:inherit;font-weight:500;outline:none;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%238b93b8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:36px;}
.form-grp select:focus{border-color:var(--indigo);box-shadow:0 0 0 3px rgba(79,70,229,0.1);}
.modal-footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;background:var(--bg);position:sticky;bottom:0;}
.toggle-row{display:flex;align-items:center;gap:12px;padding:11px 13px;background:var(--bg);border:1px solid var(--border2);border-radius:var(--r-sm);cursor:pointer;}
.toggle-row label{font-size:13px;font-weight:600;color:var(--text);cursor:pointer;flex:1;}
.toggle-row input[type="checkbox"]{width:18px;height:18px;accent-color:var(--indigo);cursor:pointer;flex-shrink:0;}

/* ─── CHECKBOXES ─── */
#userCheckboxes{max-height:340px;overflow-y:auto;background:var(--bg);border:1px solid var(--border2);border-radius:var(--r-sm);padding:6px;display:flex;flex-direction:column;gap:2px;}
.ucheck{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:7px;cursor:pointer;transition:background 0.12s;}
.ucheck:hover{background:var(--indigo-l);}
.ucheck input[type="checkbox"]{width:16px;height:16px;accent-color:var(--indigo);flex-shrink:0;}
.ucheck label{font-size:13px;font-weight:600;color:var(--text);cursor:pointer;flex:1;}
.ucheck .user-role-tag{font-size:10px;color:var(--text3);font-weight:600;background:var(--bg2);padding:2px 7px;border-radius:999px;text-transform:uppercase;flex-shrink:0;}
#selectAllBtn{font-size:12px;font-weight:700;color:var(--indigo);background:none;border:none;cursor:pointer;text-align:right;padding:4px 0;font-family:inherit;display:block;width:100%;}

/* ─── BROADCAST MODAL ENHANCEMENTS ─── */
.recipient-mode-tabs{display:flex;gap:6px;margin-bottom:10px;}
.rmode-btn{flex:1;padding:9px;border:1px solid var(--border2);border-radius:var(--r-sm);background:var(--bg);color:var(--text2);font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;transition:all 0.15s;text-align:center;}
.rmode-btn.active{background:var(--indigo-l);border-color:var(--indigo-m);color:var(--indigo);}
.rmode-btn:hover:not(.active){border-color:var(--border);background:var(--bg2);}

.role-filter-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px;margin-bottom:10px;}
@media(min-width:420px){.role-filter-grid{grid-template-columns:repeat(4,1fr);}}
.role-chip{border:1.5px solid var(--border2);border-radius:var(--r-sm);padding:8px 10px;cursor:pointer;background:var(--bg);transition:all 0.15s;text-align:center;user-select:none;}
.role-chip:hover{border-color:var(--indigo-m);background:var(--indigo-l);}
.role-chip.selected{border-color:var(--indigo);background:var(--indigo-l);}
.role-chip .rc-icon{font-size:18px;display:block;margin-bottom:4px;}
.role-chip .rc-label{font-size:11px;font-weight:700;color:var(--text2);}
.role-chip.selected .rc-label{color:var(--indigo);}
.role-chip .rc-count{font-size:10px;color:var(--text3);margin-top:2px;}

.count-control-row{display:flex;align-items:center;gap:10px;background:var(--bg);border:1px solid var(--border2);border-radius:var(--r-sm);padding:10px 13px;}
.count-control-row .cc-label{flex:1;font-size:13px;font-weight:600;color:var(--text);}
.count-control-row .cc-sub{font-size:11px;color:var(--text3);}
.count-input-wrap{display:flex;align-items:center;gap:6px;}
.count-input-wrap input[type="number"]{width:70px;text-align:center;padding:7px 10px;font-size:13px;border-radius:var(--r-sm);border:1px solid var(--border2);background:var(--white);color:var(--text);font-family:inherit;font-weight:700;outline:none;}
.count-input-wrap input:focus{border-color:var(--indigo);box-shadow:0 0 0 3px rgba(79,70,229,0.1);}
.count-adj-btn{width:28px;height:28px;border-radius:7px;border:1px solid var(--border2);background:var(--white);color:var(--text2);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center;font-weight:700;transition:all 0.15s;font-family:inherit;line-height:1;}
.count-adj-btn:hover{border-color:var(--indigo);color:var(--indigo);background:var(--indigo-l);}

.recipient-summary{background:var(--indigo-l);border:1px solid var(--indigo-m);border-radius:var(--r-sm);padding:10px 13px;display:flex;align-items:center;gap:8px;font-size:13px;font-weight:600;color:var(--indigo);}
.recipient-summary i{font-size:16px;}

/* ─── LINK BUILDER ─── */
.link-toolbar{display:flex;gap:6px;margin-bottom:8px;flex-wrap:wrap;}
.link-toolbar-btn{padding:6px 11px;border:1px solid var(--border2);border-radius:var(--r-sm);background:var(--bg);color:var(--text2);font-size:12px;font-weight:700;cursor:pointer;font-family:inherit;transition:all 0.15s;display:flex;align-items:center;gap:5px;}
.link-toolbar-btn:hover{border-color:var(--indigo-m);color:var(--indigo);background:var(--indigo-l);}
.link-toolbar-btn i{font-size:14px;}

.link-input-row{display:flex;gap:6px;align-items:center;padding:8px;background:var(--bg2);border:1px solid var(--border2);border-radius:var(--r-sm);margin-bottom:8px;}
.link-input-row input{flex:1;background:var(--white);border:1px solid var(--border2);border-radius:6px;padding:7px 10px;font-size:13px;font-family:inherit;color:var(--text);outline:none;}
.link-input-row input:focus{border-color:var(--indigo);}
.link-input-row input::placeholder{color:var(--text3);}

/* ─── CONTENT PREVIEW ─── */
.preview-box{background:var(--bg);border:1px solid var(--border2);border-radius:var(--r-sm);padding:13px;font-size:13px;color:var(--text2);line-height:1.7;word-break:break-word;max-height:220px;overflow-y:auto;}
.preview-box a{color:var(--brand,var(--indigo));text-decoration:underline;font-weight:800;word-break:break-all;}
.preview-box a:hover{opacity:0.75;}

/* Announcement message with link rendering */
.ann-msg-rendered{font-size:13px;color:var(--text2);line-height:1.7;word-break:break-word;}
.ann-msg-rendered a{color:var(--brand,var(--indigo));text-decoration:underline;font-weight:800;}

/* ─── ACTIVITY ─── */
.activity-item{display:flex;gap:11px;align-items:flex-start;padding:12px 16px;border-bottom:1px solid var(--border);}
.activity-item:last-child{border-bottom:none;}
.act-dot{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}
.act-text{font-size:13px;color:var(--text2);font-weight:500;line-height:1.5;}
.act-time{font-size:11px;color:var(--text3);margin-top:2px;font-family:'JetBrains Mono',monospace;}

/* ─── NOTIF ROWS ─── */
.notif-row{display:flex;gap:10px;align-items:flex-start;padding:12px 14px;border-bottom:1px solid var(--border);}
.notif-row:last-child{border-bottom:none;}
.notif-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:5px;}
.notif-body{flex:1;min-width:0;}
.notif-who{font-size:12px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.notif-msg{font-size:13px;color:var(--text2);margin-top:2px;}
.notif-time{font-size:11px;color:var(--text3);margin-top:3px;font-family:'JetBrains Mono',monospace;}

/* ─── FORM GRIDS ─── */
.form-grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.form-grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
@media(max-width:480px){.form-grid2{grid-template-columns:1fr;}.form-grid3{grid-template-columns:1fr 1fr;}}
.section-label{font-size:11px;font-weight:800;color:var(--indigo);text-transform:uppercase;letter-spacing:0.08em;display:flex;align-items:center;gap:6px;padding:4px 0 2px;border-bottom:1px solid var(--border);margin-bottom:2px;}
.section-label i{font-size:13px;}

/* ─── TOAST ─── */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--text);color:white;padding:11px 18px;border-radius:10px;display:flex;align-items:center;gap:9px;z-index:9999;box-shadow:var(--shadow-lg);animation:toastIn 0.3s cubic-bezier(0.34,1.04,0.64,1);max-width:calc(100vw - 32px);font-size:13px;font-weight:600;}
@keyframes toastIn{from{transform:translate(-50%,20px);opacity:0;}to{transform:translate(-50%,0);opacity:1;}}

/* ─── STATES ─── */
.empty-state{padding:44px 20px;text-align:center;}
.empty-state i{font-size:36px;color:var(--text3);display:block;margin-bottom:10px;opacity:0.5;}
.empty-state p{font-size:13px;color:var(--text3);font-weight:500;}
.loading-inner{padding:36px 20px;text-align:center;}
.spinner{width:30px;height:30px;border:2px solid var(--border2);border-top-color:var(--indigo);border-radius:50%;animation:spin 0.75s linear infinite;margin:0 auto 10px;}
.loading-inner p{font-size:13px;color:var(--text3);font-weight:500;}

/* ─── RESPONSIVE ─── */
@media(max-width:380px){
.header-logo{font-size:17px;}
#adminName{display:none;}
.logout-btn span{display:none;}
.logout-btn{padding:8px 10px;}
.stat-value{font-size:22px;}
.quick-actions{grid-template-columns:1fr;}
}
@media(min-width:768px){
.stats-grid{padding:18px 20px 0;gap:14px;}
.quick-actions{padding:14px 20px;gap:12px;}
.panel{margin:14px 20px;}
.tabs{padding:0 14px;}
.header{padding:0 20px;}
}
</style>
</head>
<body>

<div id="loadingOverlay">
<div class="load-logo">Keli</div>
<div class="load-ring"></div>
<p class="load-msg">Verifying admin access…</p>
</div>

<div id="app" style="display:none;">

<!-- COMMAND PALETTE -->
<div id="cmdOverlay" onclick="closeCmdPalette(event)">
<div class="cmd-box" onclick="event.stopPropagation()">
  <div class="cmd-input-row">
    <i class="ri-search-line"></i>
    <input type="text" id="cmdInput" placeholder="Search commands, users, settings…" oninput="filterCmdItems(this.value)" onkeydown="handleCmdKey(event)">
    <span class="cmd-kbd">ESC</span>
  </div>
  <div class="cmd-results" id="cmdResults"></div>
</div>
</div>

<!-- SIDEBAR OVERLAY (mobile) -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="closeSidebar()"></div>

<!-- PROFILE DRAWER -->
<div id="profileDrawer">
<div class="profile-drawer-hdr">
  <i class="ri-user-line" style="color:var(--indigo);font-size:18px;"></i>
  <h3>User Profile</h3>
  <button class="close-btn" onclick="closeProfileDrawer()">✕</button>
</div>
<div id="profileDrawerContent"></div>
</div>

<!-- HEADER (mobile only) -->
<header class="header">
<button class="menu-toggle-btn" onclick="toggleSidebar()"><i class="ri-menu-line"></i></button>
<span class="header-logo">Keli</span>
<span class="header-chip">Admin</span>
<span class="header-spacer"></span>
<span id="adminName">Loading…</span>
<button class="dark-toggle" onclick="toggleDarkMode()" title="Toggle dark mode"><i class="ri-moon-line" id="darkIcon"></i></button>
<button class="logout-btn" onclick="handleLogout()">
<i class="ri-logout-box-line"></i><span>Logout</span>
</button>
</header>

<div class="app-body">
<!-- SIDEBAR -->
<aside class="sidebar" id="sidebar">
  <div class="sidebar-logo-row">
    <span class="sidebar-logo">Keli</span>
    <span class="sidebar-chip">Admin</span>
  </div>
  <div class="sidebar-admin">
    <div class="sidebar-admin-name" id="sidebarAdminName">Loading…</div>
    <div class="sidebar-admin-sub">Administrator</div>
  </div>
  <nav class="sidebar-nav">
    <div class="sidebar-section-label">Overview</div>
    <button class="nav-item active" data-tab="dashboard" onclick="switchTab('dashboard')"><i class="ri-dashboard-line"></i>Dashboard</button>
    <div class="sidebar-section-label" style="margin-top:6px;">Content</div>
    <button class="nav-item" data-tab="users" onclick="switchTab('users')"><i class="ri-user-line"></i>Users <span class="nav-badge" id="navBadgeUsers" style="display:none;"></span></button>
    <button class="nav-item" data-tab="posts" onclick="switchTab('posts')"><i class="ri-article-line"></i>Posts</button>
    <button class="nav-item" data-tab="comments" onclick="switchTab('comments')"><i class="ri-chat-3-line"></i>Comments</button>
    <div class="sidebar-section-label" style="margin-top:6px;">Communication</div>
    <button class="nav-item" data-tab="announcements" onclick="switchTab('announcements')"><i class="ri-megaphone-line"></i>Announcements</button>
    <button class="nav-item" data-tab="notifications" onclick="switchTab('notifications')"><i class="ri-bell-line"></i>Notifications</button>
    <div class="sidebar-section-label" style="margin-top:6px;">Quick Actions</div>
    <button class="nav-item" onclick="openBroadcastModal()"><i class="ri-send-plane-line"></i>Broadcast</button>
    <button class="nav-item" onclick="openCmdPalette()"><i class="ri-command-line"></i>Command <span class="cmd-kbd" style="margin-left:auto;font-size:10px;">⌘K</span></button>
    <div class="sidebar-section-label" style="margin-top:6px;color:var(--rose);opacity:0.7;">Danger</div>
    <button class="nav-item" onclick="openDangerZone()" style="color:var(--rose);"><i class="ri-error-warning-line" style="color:var(--rose);"></i>Danger Zone</button>
  </nav>
  <div class="sidebar-footer">
    <button class="sidebar-footer-btn" onclick="toggleDarkMode()"><i class="ri-moon-line" id="darkIconSidebar"></i><span id="darkLabel">Dark Mode</span></button>
    <button class="sidebar-footer-btn danger" onclick="handleLogout()"><i class="ri-logout-box-line"></i>Logout</button>
  </div>
</aside>

<!-- MAIN CONTENT -->
<div class="main-content">

<!-- COMMAND CENTER BANNER -->
<div class="cmd-center">
  <div class="cmd-center-left">
    <div class="cmd-center-avatar" id="ccAvatar"><i class="ri-shield-star-line"></i></div>
    <div>
      <div class="cmd-center-name" id="ccName">Admin Panel</div>
      <div class="cmd-center-role">
        <span class="admin-badge"><i class="ri-shield-check-line"></i>Full Access</span>
        <div class="live-dot" title="Live — real-time connected"></div>
        <span class="realtime-pill"><i class="ri-wifi-line"></i>Live</span>
      </div>
    </div>
  </div>
  <div class="cmd-center-right">
    <div class="live-clock" id="liveClock">--:--:--</div>
    <div class="live-date" id="liveDate">Loading…</div>
    <div class="session-timer" id="sessionTimer">Session: 0:00</div>
  </div>
</div>

<div class="stats-grid">
<div class="stat-card s-indigo">
<div class="stat-icon"><i class="ri-user-3-line"></i></div>
<div class="stat-label">Users</div>
<div class="stat-value" id="totalUsers">—</div>
<div class="stat-sub" id="userSub">Loading…</div>
<div id="userTrend"></div>
</div>
<div class="stat-card s-emerald">
<div class="stat-icon"><i class="ri-article-line"></i></div>
<div class="stat-label">Posts</div>
<div class="stat-value" id="totalPosts">—</div>
<div class="stat-sub" id="postSub">Loading…</div>
<div id="postTrend"></div>
</div>
<div class="stat-card s-amber">
<div class="stat-icon"><i class="ri-chat-3-line"></i></div>
<div class="stat-label">Comments</div>
<div class="stat-value" id="totalComments">—</div>
<div class="stat-sub" id="commentSub">Loading…</div>
<div id="commentTrend"></div>
</div>
<div class="stat-card s-rose">
<div class="stat-icon"><i class="ri-heart-3-line"></i></div>
<div class="stat-label">Likes</div>
<div class="stat-value" id="totalLikes">—</div>
<div class="stat-sub" id="likeSub">Loading…</div>
<div id="likeTrend"></div>
</div>
</div>

<div class="power-actions">
<div class="paction pa-indigo" onclick="openBroadcastModal()">
  <div class="paction-icon"><i class="ri-megaphone-line"></i></div>
  <div class="paction-title">Broadcast</div>
  <div class="paction-sub">Send to all users</div>
</div>
<div class="paction pa-emerald" onclick="switchTab('users')">
  <div class="paction-icon"><i class="ri-user-settings-line"></i></div>
  <div class="paction-title">Users</div>
  <div class="paction-sub">Manage accounts</div>
</div>
<div class="paction pa-amber" onclick="switchTab('posts')">
  <div class="paction-icon"><i class="ri-article-line"></i></div>
  <div class="paction-title">Content</div>
  <div class="paction-sub">Posts & comments</div>
</div>
<div class="paction pa-rose" onclick="openDangerZone()">
  <div class="paction-icon"><i class="ri-error-warning-line"></i></div>
  <div class="paction-title">Danger Zone</div>
  <div class="paction-sub">Nuclear options</div>
</div>
</div>

<div class="tabs-wrap">
<div class="tabs">
<button class="tab active" data-tab="dashboard" onclick="switchTab('dashboard')"><i class="ri-dashboard-line"></i>Dashboard</button>
<button class="tab" data-tab="users" onclick="switchTab('users')"><i class="ri-user-line"></i>Users</button>
<button class="tab" data-tab="posts" onclick="switchTab('posts')"><i class="ri-article-line"></i>Posts</button>
<button class="tab" data-tab="comments" onclick="switchTab('comments')"><i class="ri-chat-3-line"></i>Comments</button>
<button class="tab" data-tab="announcements" onclick="switchTab('announcements')"><i class="ri-megaphone-line"></i>Announce</button>
<button class="tab" data-tab="notifications" onclick="switchTab('notifications')"><i class="ri-bell-line"></i>Notifications</button>
</div>
</div>

<div id="dashboard-tab" class="tab-content active">
<!-- Dashboard grid: activity chart + leaderboard -->
<div class="dashboard-grid">
  <div class="chart-card">
    <div class="chart-card-hdr">
      <div>
        <div class="chart-card-title">Recent Activity</div>
        <div class="chart-card-sub">Posts, comments & signups over time</div>
      </div>
    </div>
    <canvas id="activityChart"></canvas>
    <div id="activityLogList" style="margin-top:14px;border-top:1px solid var(--border);"></div>
  </div>
  <div style="display:flex;flex-direction:column;gap:14px;">
    <div class="chart-card">
      <div class="chart-card-hdr">
        <div>
          <div class="chart-card-title">🏆 Top Users</div>
          <div class="chart-card-sub">By score</div>
        </div>
      </div>
      <div id="leaderboardList"></div>
    </div>
    <div class="chart-card">
      <div class="chart-card-hdr">
        <div>
          <div class="chart-card-title">Platform Health</div>
          <div class="chart-card-sub">Live status</div>
        </div>
      </div>
      <div id="platformHealth"></div>
    </div>
  </div>
</div>
</div>

<div id="users-tab" class="tab-content">
<div class="panel">
<div class="toolbar">
<div class="search-bar"><input type="text" id="userSearch" placeholder="🔍 Search users…"></div>
<button class="btn-export" onclick="exportUsersCSV()"><i class="ri-download-line"></i>Export CSV</button>
<button class="btn btn-secondary" onclick="loadUsers()"><i class="ri-refresh-line"></i>Refresh</button>
</div>
<div class="bulk-bar" id="userBulkBar">
  <span class="bulk-count" id="userBulkCount">0 selected</span>
  <button class="bulk-btn bulk-btn-del" onclick="bulkDeleteUsers()"><i class="ri-delete-bin-line"></i>Delete Selected</button>
  <button class="bulk-btn bulk-btn-cancel" onclick="clearUserSelection()">Cancel</button>
</div>
<div class="table-wrap"><div id="usersContainer"><div class="loading-inner"><div class="spinner"></div><p>Loading…</p></div></div></div>
</div>
</div>

<div id="posts-tab" class="tab-content">
<div class="panel">
<div class="toolbar">
<div class="search-bar"><input type="text" id="postSearch" placeholder="🔍 Search posts…"></div>
<button class="btn-export" onclick="exportPostsCSV()"><i class="ri-download-line"></i>Export CSV</button>
<button class="btn btn-secondary" onclick="loadPosts()"><i class="ri-refresh-line"></i>Refresh</button>
</div>
<div class="bulk-bar" id="postBulkBar">
  <span class="bulk-count" id="postBulkCount">0 selected</span>
  <button class="bulk-btn bulk-btn-del" onclick="bulkDeletePosts()"><i class="ri-delete-bin-line"></i>Delete Selected</button>
  <button class="bulk-btn bulk-btn-cancel" onclick="clearPostSelection()">Cancel</button>
</div>
<div class="table-wrap"><div id="postsContainer"><div class="loading-inner"><div class="spinner"></div><p>Loading…</p></div></div></div>
</div>
</div>

<div id="comments-tab" class="tab-content">
<div class="panel">
<div class="toolbar">
<div class="search-bar"><input type="text" id="commentSearch" placeholder="🔍 Search comments…"></div>
<button class="btn btn-secondary" onclick="loadComments()"><i class="ri-refresh-line"></i>Refresh</button>
</div>
<div class="table-wrap"><div id="commentsContainer"><div class="loading-inner"><div class="spinner"></div><p>Loading…</p></div></div></div>
</div>
</div>

<div id="announcements-tab" class="tab-content">
<div class="panel">
<div class="toolbar">
<button class="btn btn-primary" onclick="openBroadcastModal()"><i class="ri-add-line"></i>New</button>
<button class="btn btn-secondary" onclick="loadAnnouncements()"><i class="ri-refresh-line"></i>Refresh</button>
</div>
<div id="announcementsContainer"><div class="loading-inner"><div class="spinner"></div><p>Loading…</p></div></div>
</div>
</div>

<div id="notifications-tab" class="tab-content">
<div class="panel">
<div class="toolbar">
<div class="search-bar"><input type="text" id="notificationSearch" placeholder="🔍 Search notifications…"></div>
<button class="btn btn-secondary" onclick="loadAllNotifications()"><i class="ri-refresh-line"></i>Refresh</button>
</div>
<div id="notificationsContainer"><div class="loading-inner"><div class="spinner"></div><p>Loading…</p></div></div>
</div>
</div>

</div><!-- /main-content -->
</div><!-- /app-body -->

<!-- Floating Action Button -->
<button class="fab" onclick="openBroadcastModal()" title="New Announcement"><i class="ri-megaphone-line"></i></button>

<!-- DANGER ZONE MODAL -->
<div id="dangerModal" class="modal">
<div class="modal-sheet">
  <div class="modal-handle"></div>
  <div class="modal-hdr"><i class="ri-error-warning-line modal-icon" style="color:var(--rose);"></i><h3 style="color:var(--rose);">Danger Zone</h3><button class="close-btn" onclick="closeDangerZone()">✕</button></div>
  <div class="form-grp">
    <div class="danger-warning"><i class="ri-error-warning-fill" style="font-size:18px;flex-shrink:0;margin-top:1px;"></i>These are irreversible, platform-wide actions. Proceed only if you know what you are doing.</div>
  </div>
  <div class="form-grp" style="display:flex;flex-direction:column;gap:10px;padding-top:0;">
    <div style="background:var(--bg);border:1px solid var(--border2);border-radius:var(--r);padding:14px;">
      <div style="font-size:13px;font-weight:800;color:var(--text);margin-bottom:4px;"><i class="ri-delete-bin-line" style="color:var(--rose);"></i> Purge All Posts</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:10px;">Permanently deletes every post and all associated comments, likes, and bookmarks from the platform.</div>
      <button class="btn" style="background:var(--rose);color:white;width:100%;justify-content:center;" onclick="dangerPurgeAllPosts()"><i class="ri-delete-bin-line"></i>Purge All Posts</button>
    </div>
    <div style="background:var(--bg);border:1px solid var(--border2);border-radius:var(--r);padding:14px;">
      <div style="font-size:13px;font-weight:800;color:var(--text);margin-bottom:4px;"><i class="ri-notification-off-line" style="color:var(--amber);"></i> Clear All Notifications</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:10px;">Deletes all notifications and announcements for every user on the platform.</div>
      <button class="btn" style="background:var(--amber);color:white;width:100%;justify-content:center;" onclick="dangerClearAllNotifications()"><i class="ri-notification-off-line"></i>Clear All Notifications</button>
    </div>
    <div style="background:var(--bg);border:1px solid var(--border2);border-radius:var(--r);padding:14px;">
      <div style="font-size:13px;font-weight:800;color:var(--text);margin-bottom:4px;"><i class="ri-user-unfollow-line" style="color:var(--rose);"></i> Revoke All Admin Access</div>
      <div style="font-size:12px;color:var(--text3);margin-bottom:10px;">Sets <code style="background:var(--bg2);padding:1px 5px;border-radius:4px;font-size:11px;">is_admin = false</code> for every user except yourself.</div>
      <button class="btn" style="background:var(--rose);color:white;width:100%;justify-content:center;" onclick="dangerRevokeAllAdmins()"><i class="ri-user-unfollow-line"></i>Revoke All Admin Access</button>
    </div>
  </div>
  <div class="modal-footer"><button class="btn btn-secondary" onclick="closeDangerZone()">Close</button></div>
</div>
</div>

<!-- ══════════════════════════════════════════
     BROADCAST MODAL (Enhanced)
══════════════════════════════════════════ -->
<div id="broadcastModal" class="modal">
<div class="modal-sheet">
<div class="modal-handle"></div>
<div class="modal-hdr">
<i class="ri-megaphone-line modal-icon"></i>
<h3>Post Announcement</h3>
<button class="close-btn" onclick="closeBroadcastModal()">✕</button>
</div>

<!-- Message with link toolbar -->
<div class="form-grp">
<label>Message</label>
<div class="link-toolbar">
<button class="link-toolbar-btn" onclick="toggleLinkPanel()" id="linkToggleBtn">
<i class="ri-link"></i> Add Link
</button>
<button class="link-toolbar-btn" onclick="previewAnnouncement()">
<i class="ri-eye-line"></i> Preview
</button>
</div>

<!-- Link builder panel (hidden by default) -->
<div id="linkPanel" style="display:none;">
<div class="link-input-row">
<input type="text" id="linkText" placeholder="Link label (e.g. Click here)">
<input type="text" id="linkUrl" placeholder="https://…">
<button class="btn btn-primary btn-sm" onclick="insertLink()">Insert</button>
</div>
</div>

<textarea id="broadcastContent" placeholder="Write your announcement… Links will be clickable when received." style="min-height:110px;"></textarea>
</div>

<!-- Preview box (hidden until toggled) -->
<div id="previewPane" style="display:none;" class="form-grp" style="padding-top:0;">
<label>Preview</label>
<div id="previewContent" class="preview-box"></div>
</div>

<!-- Recipient Mode Tabs -->
<div class="form-grp" style="padding-top:0;">
<label>Send To</label>
<div class="recipient-mode-tabs">
<button class="rmode-btn active" id="modeByRole" onclick="setRecipientMode('role')">
<i class="ri-group-line"></i> By Role / Type
</button>
<button class="rmode-btn" id="modeByUser" onclick="setRecipientMode('user')">
<i class="ri-user-search-line"></i> Pick Users
</button>
<button class="rmode-btn" id="modeAll" onclick="setRecipientMode('all')">
<i class="ri-broadcast-line"></i> Everyone
</button>
</div>

<!-- MODE: By Role -->
<div id="recipientByRole">
<p style="font-size:12px;color:var(--text3);margin-bottom:10px;font-weight:500;">Select which roles/types receive this announcement:</p>
<div class="role-filter-grid" id="roleChips">
<!-- populated by JS -->
</div>
<!-- Per-role count controls -->
<div id="roleCountControls" style="display:flex;flex-direction:column;gap:8px;margin-top:10px;">
<!-- populated by JS -->
</div>
</div>

<!-- MODE: Pick Users -->
<div id="recipientByUser" style="display:none;">
<div style="display:flex;align-items:center;gap:8px;margin-bottom:8px;">
  <div class="search-bar" style="flex:1;"><input type="text" placeholder="🔍 Filter users…" oninput="renderBroadcastUserList(this.value)" style="width:100%;"></div>
  <button id="selectAllBtn" class="btn btn-secondary btn-sm" onclick="toggleSelectAll()">Select All</button>
</div>
<p style="font-size:11px;color:var(--text3);margin-bottom:6px;">All users checked by default. Uncheck to exclude.</p>
<div id="userCheckboxes" style="margin-top:2px;"></div>
</div>

<!-- MODE: Everyone -->
<div id="recipientAll" style="display:none;">
<div class="recipient-summary">
<i class="ri-broadcast-line"></i>
<span id="everyoneCount">This will send to all users.</span>
</div>
</div>
</div>

<!-- Recipient summary -->
<div class="form-grp" style="padding-top:0;">
<div class="recipient-summary" id="recipientSummary">
<i class="ri-user-3-line"></i>
<span id="summaryText">Select recipients above</span>
</div>
</div>

<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeBroadcastModal()">Cancel</button>
<button class="btn btn-primary" onclick="postAnnouncement()"><i class="ri-send-plane-line"></i>Send</button>
</div>
</div>
</div>

<!-- VIEW MODAL -->
<div id="viewModal" class="modal">
<div class="modal-sheet">
<div class="modal-handle"></div>
<div class="modal-hdr"><i class="ri-eye-line modal-icon"></i><h3 id="viewModalTitle">Preview</h3><button class="close-btn" onclick="closeViewModal()">✕</button></div>
<div class="form-grp"><div id="viewModalContent" class="preview-box"></div></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeViewModal()">Close</button></div>
</div>
</div>

<!-- EDIT USER MODAL -->
<div id="editUserModal" class="modal">
<div class="modal-sheet" style="max-width:680px;">
<div class="modal-handle"></div>
<div class="modal-hdr"><i class="ri-user-settings-line modal-icon"></i><h3>Edit User</h3><button class="close-btn" onclick="closeEditUserModal()">✕</button></div>
<input type="hidden" id="editUserId">
<div style="padding:12px 16px 4px;"><p class="section-label"><i class="ri-user-line"></i> Identity</p></div>
<div class="form-grp form-grid2">
<div><label>Stage Name</label><input type="text" id="editStageName" placeholder="Stage name"></div>
<div><label>Email</label><input type="email" id="editEmail" placeholder="Email"></div>
</div>
<div class="form-grp form-grid2" style="padding-top:0;">
<div><label>User Type</label>
<input type="text" id="editUserType" placeholder="e.g. User, Artist, Admin">
</div>
<div><label>Role</label>
<input type="text" id="editRole" placeholder="e.g. user, artist, admin, moderator">
</div>
</div>
<div class="form-grp" style="padding-top:0;"><label>Bio</label><textarea id="editBio" placeholder="User bio…" style="min-height:70px;"></textarea></div>
<div class="form-grp form-grid2" style="padding-top:0;">
<div><label>Profile Picture URL</label><input type="text" id="editProfilePicture" placeholder="https://…"></div>
<div><label>Search Key</label><input type="text" id="editSearchKey" placeholder="search_key"></div>
</div>
<div class="form-grp" style="padding-top:0;"><label>Status Badge</label><input type="text" id="editStatusBadge" placeholder="e.g. 🎤 Verified Artist"></div>
<div style="padding:12px 16px 4px;"><p class="section-label"><i class="ri-vip-crown-line"></i> Tier & Payments</p></div>
<div class="form-grp form-grid2">
<div><label>Tier</label><select id="editTier"><option value="basic">basic</option><option value="pro">pro</option><option value="premium">premium</option></select></div>
<div><label>Payment ID</label><input type="text" id="editPaymentId" placeholder="payment_id"></div>
</div>
<div class="form-grp form-grid2" style="padding-top:0;">
<div><label>Coins</label><input type="number" id="editCoins" placeholder="0" min="0"></div>
<div><label>Score</label><input type="number" id="editScore" placeholder="0" min="0"></div>
</div>
<div class="form-grp" style="padding-top:0;"><label>Upgraded At</label><input type="datetime-local" id="editUpgradedAt"></div>
<div style="padding:12px 16px 4px;"><p class="section-label"><i class="ri-settings-3-line"></i> Limits & Counts</p></div>
<div class="form-grp form-grid3">
<div><label>Max Audio Previews</label><input type="number" id="editMaxAudioPreviews" min="0"></div>
<div><label>Max Releases</label><input type="number" id="editMaxReleases" min="0"></div>
<div><label>Max Edits</label><input type="number" id="editMaxEdits" min="0"></div>
</div>
<div class="form-grp form-grid3" style="padding-top:0;">
<div><label>Current Audio Count</label><input type="number" id="editCurrentAudioCount" min="0"></div>
<div><label>Current Release Count</label><input type="number" id="editCurrentReleaseCount" min="0"></div>
<div><label>Edits Remaining</label><input type="number" id="editEditsRemaining" min="0"></div>
</div>
<div class="form-grp form-grid3" style="padding-top:0;">
<div><label>Track Count</label><input type="number" id="editTrackCount" min="0"></div>
<div><label>Collab Count</label><input type="number" id="editCollabCount" min="0"></div>
<div><label>Invite Count</label><input type="number" id="editInviteCount" min="0"></div>
</div>
<div class="form-grp form-grid2" style="padding-top:0;">
<div><label>Invite Pro</label><input type="number" id="editInvitePro" min="0" placeholder="0"></div>
<div><label>Invite Code</label><input type="text" id="editInviteCode" placeholder="invite_code"></div>
</div>
<div class="form-grp" style="padding-top:0;"><label>Invited By Code</label><input type="text" id="editInvitedByCode" placeholder="Code used at signup"></div>
<div style="padding:12px 16px 4px;"><p class="section-label"><i class="ri-shield-check-line"></i> Access Flags</p></div>
<div class="form-grp" style="display:flex;flex-direction:column;gap:8px;">
<div class="toggle-row" onclick="document.getElementById('editIsAdmin').click()">
<label for="editIsAdmin">Admin access (is_admin)</label>
<input type="checkbox" id="editIsAdmin">
</div>
<div class="toggle-row" onclick="document.getElementById('editCanSeeInvite').click()">
<label for="editCanSeeInvite">Can see invite page (can_see_invite)</label>
<input type="checkbox" id="editCanSeeInvite">
</div>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeEditUserModal()">Cancel</button>
<button class="btn btn-primary" onclick="saveUserEdit()"><i class="ri-save-line"></i>Save Changes</button>
</div>
</div>
</div>

<!-- EDIT POST MODAL -->
<div id="editPostModal" class="modal">
<div class="modal-sheet">
<div class="modal-handle"></div>
<div class="modal-hdr"><i class="ri-edit-line modal-icon"></i><h3>Edit Post</h3><button class="close-btn" onclick="closeEditPostModal()">✕</button></div>
<input type="hidden" id="editPostId">
<div class="form-grp"><label>Content</label><textarea id="editPostContent" placeholder="Post content…" style="min-height:130px;"></textarea></div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeEditPostModal()">Cancel</button>
<button class="btn btn-primary" onclick="savePostEdit()"><i class="ri-save-line"></i>Save</button>
</div>
</div>
</div>

<!-- EDIT COMMENT MODAL -->
<div id="editCommentModal" class="modal">
<div class="modal-sheet">
<div class="modal-handle"></div>
<div class="modal-hdr"><i class="ri-edit-line modal-icon"></i><h3>Edit Comment</h3><button class="close-btn" onclick="closeEditCommentModal()">✕</button></div>
<input type="hidden" id="editCommentId">
<div class="form-grp"><label>Content</label><textarea id="editCommentContent" placeholder="Comment content…"></textarea></div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeEditCommentModal()">Cancel</button>
<button class="btn btn-primary" onclick="saveCommentEdit()"><i class="ri-save-line"></i>Save</button>
</div>
</div>
</div>

<!-- ADMIN COMMENT MODAL -->
<div id="adminCommentModal" class="modal">
<div class="modal-sheet">
<div class="modal-handle"></div>
<div class="modal-hdr"><i class="ri-shield-star-line modal-icon"></i><h3>Comment as Admin</h3><button class="close-btn" onclick="closeAdminCommentModal()">✕</button></div>
<div id="postCommentsContainer" style="max-height:200px;overflow-y:auto;border-bottom:1px solid var(--border);"><div class="loading-inner" style="padding:16px;"><div class="spinner" style="width:22px;height:22px;border-width:2px;"></div></div></div>
<div class="form-grp"><label>Your Comment</label><textarea id="adminCommentText" placeholder="Write your comment…"></textarea></div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeAdminCommentModal()">Cancel</button>
<button class="btn btn-primary" onclick="postAdminComment()"><i class="ri-send-plane-line"></i>Post</button>
</div>
</div>
</div>

<!-- VIEW ANNOUNCEMENT MODAL -->
<div id="announcementModal" class="modal">
<div class="modal-sheet">
<div class="modal-handle"></div>
<div class="modal-hdr"><i class="ri-megaphone-line modal-icon"></i><h3>Announcement</h3><button class="close-btn" onclick="closeAnnouncementModal()">✕</button></div>
<div class="form-grp" id="announcementModalContent"></div>
<div class="modal-footer"><button class="btn btn-secondary" onclick="closeAnnouncementModal()">Close</button></div>
</div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = 'https://xaudpqhyyxburjazfips.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhdWRwcWh5eXhidXJqYXpmaXBzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMTY1NDUsImV4cCI6MjA3Nzg5MjU0NX0.LxRbfT0TsxJ38dwTQyKhn_Hi1cuZXZ6tpE04YPatGkQ';
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
window.supabase = supabase;

let currentAdmin = null, currentPostForComment = null;
let allUsers = [], allPosts = [], allComments = [], allNotifications = [];
let recipientMode = 'role'; // 'role' | 'user' | 'all'

// Role & UserType definitions for the broadcast modal
const ROLES = [
  { key: 'user',      label: 'User',      icon: 'ri-user-line',        field: 'role' },
  { key: 'artist',    label: 'Artist',    icon: 'ri-music-line',       field: 'role' },
  { key: 'admin',     label: 'Admin',     icon: 'ri-shield-star-line', field: 'role' },
  { key: 'moderator', label: 'Moderator', icon: 'ri-eye-line',         field: 'role' },
];
const USER_TYPES = [
  { key: 'User',   label: 'User',   icon: 'ri-user-3-line',    field: 'user_type' },
  { key: 'Artist', label: 'Artist', icon: 'ri-mic-line',       field: 'user_type' },
  { key: 'Admin',  label: 'Admin',  icon: 'ri-admin-line',     field: 'user_type' },
];

// Combined chips for role selector (roles + user types, deduplicated by display)
const ALL_CHIPS = [
  { key: 'role:user',       label: 'Role: User',       icon: 'ri-user-line',        field: 'role',      value: 'user' },
  { key: 'role:artist',     label: 'Role: Artist',     icon: 'ri-music-line',       field: 'role',      value: 'artist' },
  { key: 'role:admin',      label: 'Role: Admin',      icon: 'ri-shield-star-line', field: 'role',      value: 'admin' },
  { key: 'role:moderator',  label: 'Role: Moderator',  icon: 'ri-eye-line',         field: 'role',      value: 'moderator' },
  { key: 'type:User',       label: 'Type: User',       icon: 'ri-user-3-line',      field: 'user_type', value: 'User' },
  { key: 'type:Artist',     label: 'Type: Artist',     icon: 'ri-mic-line',         field: 'user_type', value: 'Artist' },
  { key: 'type:Admin',      label: 'Type: Admin',      icon: 'ri-admin-line',       field: 'user_type', value: 'Admin' },
];

let selectedChips = new Set(); // keys of selected chips
let chipCounts = {};            // key → { max, chosen }
let broadcastUsers = [];        // all users loaded for broadcast

/* ──────────────────────────────────────────
   AUTH
────────────────────────────────────────── */
async function checkAdmin() {
  const { data:{session} } = await supabase.auth.getSession();
  if (!session) { window.location.href='login.html'; return false; }
  const { data:p, error } = await supabase.from('profiles').select('*').eq('id',session.user.id).single();
  if (error||!p) { showToast('Error loading profile','rose'); return false; }
  currentAdmin = p;
  const nameText = `Hi, ${p.stage_name||'Admin'}`;
  document.getElementById('adminName').textContent = nameText;
  const sn=document.getElementById('sidebarAdminName'); if(sn) sn.textContent=nameText;
  if (p.user_type!=='Admin' && !p.is_admin) { showToast('Access denied','rose'); setTimeout(()=>window.location.href='home.html',2000); return false; }
  return true;
}

/* ──────────────────────────────────────────
   STATS
────────────────────────────────────────── */
let prevStats = {};
function animateCount(el, to) {
  const from = parseInt(el.textContent)||0;
  if(from===to) return;
  const step = Math.ceil(Math.abs(to-from)/20);
  let cur = from;
  const timer = setInterval(()=>{
    cur = cur<to ? Math.min(cur+step,to) : Math.max(cur-step,to);
    el.textContent=cur.toLocaleString();
    if(cur===to) clearInterval(timer);
  },30);
}
async function loadStats() {
  try {
    const [u,po,c,l] = await Promise.all([
      supabase.from('profiles').select('id',{count:'exact',head:true}),
      supabase.from('posts').select('id',{count:'exact',head:true}),
      supabase.from('comments').select('id',{count:'exact',head:true}),
      supabase.from('post_likes').select('id',{count:'exact',head:true})
    ]);
    const stats = {u:u.count??0,po:po.count??0,c:c.count??0,l:l.count??0};
    const renderTrend=(id,cur,prev)=>{
      const el=document.getElementById(id); if(!el) return;
      if(prev===undefined){el.innerHTML='';return;}
      const diff=cur-prev;
      if(diff===0){el.innerHTML=`<span class="stat-trend trend-flat"><i class="ri-subtract-line"></i>No change</span>`;return;}
      const cls=diff>0?'trend-up':'trend-down';
      const ico=diff>0?'ri-arrow-up-line':'ri-arrow-down-line';
      el.innerHTML=`<span class="stat-trend ${cls}"><i class="${ico}"></i>${diff>0?'+':''}${diff}</span>`;
    };
    animateCount(document.getElementById('totalUsers'),stats.u);
    animateCount(document.getElementById('totalPosts'),stats.po);
    animateCount(document.getElementById('totalComments'),stats.c);
    animateCount(document.getElementById('totalLikes'),stats.l);
    renderTrend('userTrend',stats.u,prevStats.u);
    renderTrend('postTrend',stats.po,prevStats.po);
    renderTrend('commentTrend',stats.c,prevStats.c);
    renderTrend('likeTrend',stats.l,prevStats.l);
    document.getElementById('userSub').textContent=`${stats.u} registered`;
    document.getElementById('postSub').textContent=`${stats.po} published`;
    document.getElementById('commentSub').textContent=`${stats.c} total`;
    document.getElementById('likeSub').textContent=`${stats.l} total`;
    prevStats = stats;
  } catch(e){console.error(e);}
}

/* ──────────────────────────────────────────
   ACTIVITY + DASHBOARD
────────────────────────────────────────── */
async function loadActivityLog() {
  const el = document.getElementById('activityLogList');
  try {
    const [{data:posts},{data:comments},{data:users}] = await Promise.all([
      supabase.from('posts').select('*,profiles(stage_name)').order('created_at',{ascending:false}).limit(6),
      supabase.from('comments').select('*,profiles(stage_name)').order('created_at',{ascending:false}).limit(6),
      supabase.from('profiles').select('*').order('created_at',{ascending:false}).limit(5)
    ]);
    const items = [
      ...(posts||[]).map(p=>({type:'post',name:p.profiles?.stage_name||'User',time:p.created_at})),
      ...(comments||[]).map(c=>({type:'comment',name:c.profiles?.stage_name||'User',time:c.created_at})),
      ...(users||[]).map(u=>({type:'user',name:u.stage_name||'Someone',time:u.created_at}))
    ].sort((a,b)=>new Date(b.time)-new Date(a.time)).slice(0,12);
    if(!items.length){if(el)el.innerHTML='<div class="empty-state"><i class="ri-inbox-line"></i><p>No activity yet</p></div>';return;}
    if(el) el.innerHTML=items.map(a=>{
      const [ico,bg,clr,lbl]=a.type==='post'?['ri-article-line','var(--emerald-l)','var(--emerald)','created a post']:
        a.type==='comment'?['ri-chat-3-line','var(--amber-l)','var(--amber)','posted a comment']:
        ['ri-user-add-line','var(--indigo-l)','var(--indigo)','just joined'];
      return `<div class="activity-item"><div class="act-dot" style="background:${bg};color:${clr};"><i class="${ico}"></i></div><div><div class="act-text"><strong>${a.name}</strong> ${lbl}</div><div class="act-time">${timeAgo(a.time)}</div></div></div>`;
    }).join('');
    // Build chart
    buildActivityChart(posts||[], comments||[], users||[]);
    // Top users
    await loadLeaderboard();
    // Platform health
    renderPlatformHealth();
  } catch(e){if(el)el.innerHTML='<div class="empty-state"><p>Error loading activity</p></div>';}
}

function buildActivityChart(posts, comments, users) {
  const canvas = document.getElementById('activityChart');
  if(!canvas) return;
  const ctx = canvas.getContext('2d');
  // Generate last 7 days labels
  const days = [];
  const postCounts = [], commentCounts = [], userCounts = [];
  for(let i=6;i>=0;i--) {
    const d = new Date(); d.setDate(d.getDate()-i); d.setHours(0,0,0,0);
    const next = new Date(d); next.setDate(next.getDate()+1);
    days.push(d.toLocaleDateString('en',{weekday:'short'}));
    postCounts.push(posts.filter(p=>new Date(p.created_at)>=d&&new Date(p.created_at)<next).length);
    commentCounts.push(comments.filter(c=>new Date(c.created_at)>=d&&new Date(c.created_at)<next).length);
    userCounts.push(users.filter(u=>new Date(u.created_at)>=d&&new Date(u.created_at)<next).length);
  }
  const isDark = document.documentElement.getAttribute('data-theme')==='dark';
  const gridColor = isDark ? 'rgba(255,255,255,0.06)' : 'rgba(0,0,0,0.06)';
  const textColor = isDark ? '#555e88' : '#8b93b8';
  // Simple canvas chart
  const W = canvas.offsetWidth || 500, H = 180;
  canvas.width = W * devicePixelRatio; canvas.height = H * devicePixelRatio;
  canvas.style.width = W+'px'; canvas.style.height = H+'px';
  ctx.scale(devicePixelRatio, devicePixelRatio);
  const allVals = [...postCounts,...commentCounts,...userCounts];
  const maxV = Math.max(...allVals, 1);
  const pad = {t:10,r:10,b:30,l:30};
  const cW = W-pad.l-pad.r, cH = H-pad.t-pad.b;
  ctx.clearRect(0,0,W,H);
  // Grid lines
  for(let i=0;i<=4;i++){
    const y=pad.t+cH*(1-i/4);
    ctx.strokeStyle=gridColor; ctx.lineWidth=1;
    ctx.beginPath(); ctx.moveTo(pad.l,y); ctx.lineTo(pad.l+cW,y); ctx.stroke();
    ctx.fillStyle=textColor; ctx.font='10px JetBrains Mono,monospace'; ctx.textAlign='right';
    ctx.fillText(Math.round(maxV*i/4),pad.l-4,y+3);
  }
  // X labels
  days.forEach((d,i)=>{
    const x=pad.l+cW*i/(days.length-1);
    ctx.fillStyle=textColor; ctx.font='10px Plus Jakarta Sans,sans-serif'; ctx.textAlign='center';
    ctx.fillText(d,x,H-6);
  });
  // Draw lines
  const drawLine = (data, color) => {
    ctx.strokeStyle=color; ctx.lineWidth=2.5; ctx.lineJoin='round'; ctx.lineCap='round';
    ctx.beginPath();
    data.forEach((v,i)=>{
      const x=pad.l+cW*i/(data.length-1), y=pad.t+cH*(1-v/maxV);
      i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
    });
    ctx.stroke();
    // Dots
    data.forEach((v,i)=>{
      const x=pad.l+cW*i/(data.length-1), y=pad.t+cH*(1-v/maxV);
      if(v>0){ctx.fillStyle=color;ctx.beginPath();ctx.arc(x,y,3.5,0,Math.PI*2);ctx.fill();}
    });
  };
  drawLine(postCounts,'#059669');
  drawLine(commentCounts,'#d97706');
  drawLine(userCounts,'#4f46e5');
  // Legend
  const legend=[['Posts','#059669'],['Comments','#d97706'],['Signups','#4f46e5']];
  legend.forEach(([label,color],i)=>{
    const lx=pad.l+i*80, ly=pad.t-2;
    ctx.fillStyle=color; ctx.beginPath(); ctx.arc(lx+5,ly,5,0,Math.PI*2); ctx.fill();
    ctx.fillStyle=textColor; ctx.font='10px Plus Jakarta Sans,sans-serif'; ctx.textAlign='left';
    ctx.fillText(label,lx+14,ly+4);
  });
}

async function loadLeaderboard() {
  const el = document.getElementById('leaderboardList');
  if(!el) return;
  const {data} = await supabase.from('profiles').select('id,stage_name,score,profile_picture,tier').order('score',{ascending:false}).limit(7);
  if(!data?.length){el.innerHTML='<p style="color:var(--text3);font-size:13px;padding:8px 0;">No users yet</p>';return;}
  const maxScore = data[0].score||1;
  el.innerHTML = data.map((u,i)=>{
    const rankClass=i===0?'lb-rank-1':i===1?'lb-rank-2':i===2?'lb-rank-3':'lb-rank-n';
    const barPct=Math.round(((u.score||0)/maxScore)*100);
    return `<div class="leaderboard-item">
      <div class="lb-rank ${rankClass}">${i+1}</div>
      <img src="${u.profile_picture||'user.webp'}" class="user-avatar" style="width:28px;height:28px;" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(u.stage_name||'U')}&background=4f46e5&color=fff'">
      <div>
        <div class="lb-name">${u.stage_name||'—'}</div>
        <div class="lb-bar-wrap"><div class="lb-bar" style="width:0" data-pct="${barPct}"></div></div>
      </div>
      <div class="lb-score">${u.score||0}</div>
    </div>`;
  }).join('');
  // Animate bars
  requestAnimationFrame(()=>requestAnimationFrame(()=>{
    el.querySelectorAll('.lb-bar').forEach(b=>b.style.width=b.dataset.pct+'%');
  }));
}

function renderPlatformHealth() {
  const el = document.getElementById('platformHealth');
  if(!el) return;
  const items = [
    {icon:'ri-database-2-line',bg:'var(--indigo-l)',color:'var(--indigo)',label:'Database',value:'Connected',status:'ok'},
    {icon:'ri-refresh-line',bg:'var(--emerald-l)',color:'var(--emerald)',label:'Realtime',value:'Active',status:'ok'},
    {icon:'ri-shield-check-line',bg:'var(--amber-l)',color:'var(--amber)',label:'Auth',value:'Running',status:'ok'},
  ];
  el.innerHTML = items.map(i=>`
    <div class="health-row">
      <div class="health-icon" style="background:${i.bg};color:${i.color};"><i class="${i.icon}"></i></div>
      <div class="health-label">${i.label}</div>
      <div class="health-value" style="margin-right:8px;">${i.value}</div>
      <div class="health-status status-${i.status}"></div>
    </div>`).join('');
}

/* ──────────────────────────────────────────
   USERS
────────────────────────────────────────── */
window.loadUsers = async function() {
  const c=document.getElementById('usersContainer'); c.innerHTML=loading();
  const s=(document.getElementById('userSearch')?.value||'').toLowerCase();
  const {data,error}=await supabase.from('profiles').select('*').order('created_at',{ascending:false});
  if(error){c.innerHTML=err();return;}
  allUsers=data||[];
  // Update nav badge
  const nb=document.getElementById('navBadgeUsers');
  if(nb){nb.textContent=allUsers.length;nb.style.display='inline-block';}
  let f=allUsers; if(s) f=allUsers.filter(u=>
    u.stage_name?.toLowerCase().includes(s)||
    u.email?.toLowerCase().includes(s)||
    u.user_type?.toLowerCase().includes(s)||
    u.tier?.toLowerCase().includes(s)||
    u.role?.toLowerCase().includes(s)
  );
  if(!f.length){c.innerHTML='<div class="empty-state"><i class="ri-user-line"></i><p>No users found</p></div>';return;}
  c.innerHTML=`<table class="data-table"><thead><tr>
    <th class="check-th"><input type="checkbox" class="row-check" id="checkAllUsers" onclick="toggleAllUserChecks(this)"></th>
    <th>User</th><th>Type / Role</th><th>Tier</th><th>Admin</th>
    <th>Score</th><th>Coins</th><th>Tracks</th><th>Invites</th><th>Joined</th><th>Actions</th>
  </tr></thead><tbody>${
    f.map(u=>`<tr>
      <td class="check-td"><input type="checkbox" class="row-check user-check" data-id="${u.id}" onchange="onUserCheckChange()"></td>
      <td data-label="User" class="no-label"><div class="user-cell">
        <img src="${u.profile_picture||'user.webp'}" class="user-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(u.stage_name||'U')}&background=4f46e5&color=fff'">
        <div><div class="user-name">${u.stage_name||'—'}</div><div class="user-sub">${u.email||u.id.substring(0,10)+'…'}</div></div>
      </div></td>
      <td data-label="Type/Role"><div style="display:flex;flex-direction:column;gap:3px;">
        <span class="badge ${u.user_type==='Admin'?'badge-admin':'badge-user'}">${u.user_type||'User'}</span>
        <span style="font-size:11px;color:var(--text3);">${u.role||'user'}</span>
      </div></td>
      <td data-label="Tier"><span class="badge ${u.tier==='pro'?'badge-amber':u.tier==='premium'?'badge-admin':'badge-user'}">${u.tier||'basic'}</span></td>
      <td data-label="Admin">${u.is_admin?'<span class="badge badge-active"><i class="ri-shield-check-line"></i> Yes</span>':'<span class="badge badge-user">No</span>'}</td>
      <td data-label="Score"><strong>${u.score??0}</strong></td>
      <td data-label="Coins"><strong>${u.coins??0}</strong></td>
      <td data-label="Tracks"><strong>${u.track_count??0}</strong></td>
      <td data-label="Invites"><strong>${u.invite_count??0}</strong></td>
      <td data-label="Joined">${new Date(u.created_at).toLocaleDateString()}</td>
      <td class="no-label" style="padding-top:6px;"><div class="act-group">
        <button class="act-btn view" title="Quick View" onclick="openProfileDrawer('${u.id}')"><i class="ri-eye-line"></i></button>
        <button class="act-btn edit" title="Edit" onclick="openEditUser('${u.id}')"><i class="ri-edit-line"></i></button>
        <button class="act-btn promote" title="${u.is_admin?'Revoke admin':'Make admin'}" onclick="toggleAdmin('${u.id}',${u.is_admin})"><i class="ri-${u.is_admin?'user-line':'shield-star-line'}"></i></button>
        <button class="act-btn del" title="Delete" onclick="deleteUser('${u.id}','${(u.stage_name||'').replace(/'/g,"\\'")}')"><i class="ri-delete-bin-line"></i></button>
      </div></td></tr>`).join('')
  }</tbody></table>`;
};

window.openEditUser=function(id){
  const u=allUsers.find(x=>x.id===id); if(!u) return;
  document.getElementById('editUserId').value = u.id;
  document.getElementById('editStageName').value = u.stage_name||'';
  document.getElementById('editEmail').value = u.email||'';
  document.getElementById('editUserType').value = u.user_type||'User';
  document.getElementById('editRole').value = u.role||'user';
  document.getElementById('editBio').value = u.bio||'';
  document.getElementById('editProfilePicture').value = u.profile_picture||'';
  document.getElementById('editSearchKey').value = u.search_key||'';
  document.getElementById('editStatusBadge').value = u.status_badge||'';
  document.getElementById('editTier').value = u.tier||'basic';
  document.getElementById('editPaymentId').value = u.payment_id||'';
  document.getElementById('editCoins').value = u.coins??0;
  document.getElementById('editScore').value = u.score??0;
  document.getElementById('editUpgradedAt').value = u.upgraded_at ? u.upgraded_at.substring(0,16) : '';
  document.getElementById('editMaxAudioPreviews').value = u.max_audio_previews??10;
  document.getElementById('editMaxReleases').value = u.max_releases??6;
  document.getElementById('editMaxEdits').value = u.max_edits??1;
  document.getElementById('editCurrentAudioCount').value = u.current_audio_count??0;
  document.getElementById('editCurrentReleaseCount').value= u.current_release_count??0;
  document.getElementById('editEditsRemaining').value = u.edits_remaining??1;
  document.getElementById('editTrackCount').value = u.track_count??0;
  document.getElementById('editCollabCount').value = u.collab_count??0;
  document.getElementById('editInviteCount').value = u.invite_count??0;
  document.getElementById('editInvitePro').value = u.invite_pro??0;
  document.getElementById('editInviteCode').value = u.invite_code||'';
  document.getElementById('editInvitedByCode').value = u.invited_by_code||'';
  document.getElementById('editIsAdmin').checked = !!u.is_admin;
  document.getElementById('editCanSeeInvite').checked = !!u.can_see_invite;
  document.getElementById('editUserModal').classList.add('active');
};
window.closeEditUserModal=()=>document.getElementById('editUserModal').classList.remove('active');

window.saveUserEdit=async function(){
  const id=document.getElementById('editUserId').value;
  const upgAt=document.getElementById('editUpgradedAt').value;
  const payload={
    stage_name: document.getElementById('editStageName').value,
    email: document.getElementById('editEmail').value,
    user_type: document.getElementById('editUserType').value,
    role: document.getElementById('editRole').value,
    bio: document.getElementById('editBio').value,
    profile_picture: document.getElementById('editProfilePicture').value,
    search_key: document.getElementById('editSearchKey').value,
    status_badge: document.getElementById('editStatusBadge').value,
    tier: document.getElementById('editTier').value,
    payment_id: document.getElementById('editPaymentId').value||null,
    coins: parseInt(document.getElementById('editCoins').value)||0,
    score: parseInt(document.getElementById('editScore').value)||0,
    upgraded_at: upgAt ? new Date(upgAt).toISOString() : null,
    max_audio_previews: parseInt(document.getElementById('editMaxAudioPreviews').value)||10,
    max_releases: parseInt(document.getElementById('editMaxReleases').value)||6,
    max_edits: parseInt(document.getElementById('editMaxEdits').value)||1,
    current_audio_count: parseInt(document.getElementById('editCurrentAudioCount').value)||0,
    current_release_count:parseInt(document.getElementById('editCurrentReleaseCount').value)||0,
    edits_remaining: parseInt(document.getElementById('editEditsRemaining').value)||0,
    track_count: parseInt(document.getElementById('editTrackCount').value)||0,
    collab_count: parseInt(document.getElementById('editCollabCount').value)||0,
    invite_count: parseInt(document.getElementById('editInviteCount').value)||0,
    invite_pro: parseInt(document.getElementById('editInvitePro').value)||0,
    invite_code: document.getElementById('editInviteCode').value||null,
    invited_by_code: document.getElementById('editInvitedByCode').value||null,
    is_admin: document.getElementById('editIsAdmin').checked,
    can_see_invite: document.getElementById('editCanSeeInvite').checked,
    last_profile_update: new Date().toISOString(),
  };
  const{error}=await supabase.from('profiles').update(payload).eq('id',id);
  if(error){showToast('Error: '+error.message,'rose');return;}
  showToast('User updated!','emerald');
  closeEditUserModal();
  loadUsers();
};

window.toggleAdmin=async function(id,cur){if(!confirm(`${cur?'Revoke':'Grant'} admin for this user?`))return;const{error}=await supabase.from('profiles').update({is_admin:!cur}).eq('id',id);if(error){showToast('Error: '+error.message,'rose');return;}showToast(cur?'Admin revoked':'Admin granted!',cur?'amber':'emerald');loadUsers();};
window.deleteUser=async function(id,name){if(!confirm(`Delete ${name}? This permanently removes all their data!`))return;await Promise.all([supabase.from('posts').delete().eq('user_id',id),supabase.from('comments').delete().eq('user_id',id),supabase.from('post_likes').delete().eq('user_id',id),supabase.from('post_shares').delete().eq('user_id',id),supabase.from('post_bookmarks').delete().eq('user_id',id),supabase.from('notifications').delete().eq('user_id',id)]);await supabase.from('profiles').delete().eq('id',id);showToast(`${name} deleted`,'rose');loadUsers();loadStats();};

/* ──────────────────────────────────────────
   POSTS
────────────────────────────────────────── */
window.loadPosts=async function(){const c=document.getElementById('postsContainer');c.innerHTML=loading();const s=(document.getElementById('postSearch')?.value||'').toLowerCase();const{data,error}=await supabase.from('posts').select('*,profiles(stage_name,profile_picture)').order('created_at',{ascending:false});if(error){c.innerHTML=err();return;}allPosts=data||[];let f=allPosts;if(s)f=allPosts.filter(p=>p.content?.toLowerCase().includes(s)||p.profiles?.stage_name?.toLowerCase().includes(s));if(!f.length){c.innerHTML='<div class="empty-state"><i class="ri-article-line"></i><p>No posts found</p></div>';return;}
c.innerHTML=`<table class="data-table"><thead><tr><th class="check-th"><input type="checkbox" class="row-check" id="checkAllPosts" onclick="toggleAllPostChecks(this)"></th><th>Author</th><th>Content</th><th>❤️</th><th>💬</th><th>Date</th><th>Actions</th></tr></thead><tbody>${
f.map(p=>{const prev=(p.content||'').substring(0,70)+(p.content?.length>70?'…':'');return`<tr>
<td class="check-td"><input type="checkbox" class="row-check post-check" data-id="${p.id}" onchange="onPostCheckChange()"></td>
<td class="no-label"><div class="user-cell"><img src="${p.profiles?.profile_picture||'user.webp'}" class="user-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(p.profiles?.stage_name||'U')}&background=4f46e5&color=fff'"><span class="user-name">${p.profiles?.stage_name||'—'}</span></div></td>
<td data-label="Content" style="max-width:200px;">${prev}</td>
<td data-label="Likes"><strong>${p.likes||0}</strong></td>
<td data-label="Comments"><strong>${p.comments||0}</strong></td>
<td data-label="Date">${new Date(p.created_at).toLocaleDateString()}</td>
<td class="no-label" style="padding-top:6px;"><div class="act-group">
<button class="act-btn view" title="View" onclick="viewContent('Post',\`${(p.content||'').replace(/`/g,'\\`')}\`)"><i class="ri-eye-line"></i></button>
<button class="act-btn edit" title="Edit" onclick="openEditPost('${p.id}')"><i class="ri-edit-line"></i></button>
<button class="act-btn promote" title="Admin comment" onclick="openAdminComment('${p.id}')"><i class="ri-chat-3-line"></i></button>
<button class="act-btn del" title="Delete" onclick="deletePost('${p.id}')"><i class="ri-delete-bin-line"></i></button>
</div></td></tr>`;}).join('')
}</tbody></table>`;};
window.openEditPost=function(id){const p=allPosts.find(x=>x.id===id);if(!p)return;document.getElementById('editPostId').value=p.id;document.getElementById('editPostContent').value=p.content||'';document.getElementById('editPostModal').classList.add('active');};
window.closeEditPostModal=()=>document.getElementById('editPostModal').classList.remove('active');
window.savePostEdit=async function(){const id=document.getElementById('editPostId').value;const content=document.getElementById('editPostContent').value;const{error}=await supabase.from('posts').update({content}).eq('id',id);if(error){showToast('Error: '+error.message,'rose');return;}showToast('Post updated!','emerald');closeEditPostModal();loadPosts();};
window.deletePost=async function(id){if(!confirm('Delete this post and all comments?'))return;await Promise.all([supabase.from('comments').delete().eq('post_id',id),supabase.from('post_likes').delete().eq('post_id',id),supabase.from('post_shares').delete().eq('post_id',id),supabase.from('post_bookmarks').delete().eq('post_id',id)]);await supabase.from('posts').delete().eq('id',id);showToast('Post deleted','rose');loadPosts();loadStats();};
window.openAdminComment=async function(id){currentPostForComment=id;document.getElementById('adminCommentText').value='';document.getElementById('adminCommentModal').classList.add('active');await loadPostComments(id);};
window.closeAdminCommentModal=function(){document.getElementById('adminCommentModal').classList.remove('active');currentPostForComment=null;};
async function loadPostComments(postId){const el=document.getElementById('postCommentsContainer');const{data}=await supabase.from('comments').select('*,profiles(stage_name,profile_picture,is_admin)').eq('post_id',postId).order('created_at',{ascending:false});if(!data?.length){el.innerHTML='<p style="padding:12px 16px;color:var(--text3);font-size:13px;">No comments yet.</p>';return;}el.innerHTML=data.map(cc=>`<div class="notif-row"><img src="${cc.profiles?.profile_picture||'user.webp'}" class="user-avatar" style="width:28px;height:28px;" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(cc.profiles?.stage_name||'U')}&background=4f46e5&color=fff'"><div class="notif-body"><div class="notif-who">${cc.profiles?.stage_name||'—'}${cc.profiles?.is_admin?'<span class="badge badge-admin">Admin</span>':''}</div><div class="notif-msg">${cc.content}</div><div class="notif-time">${timeAgo(cc.created_at)}</div></div></div>`).join('');}
window.postAdminComment=async function(){const content=document.getElementById('adminCommentText').value.trim();if(!content){showToast('Write something first','amber');return;}const{error}=await supabase.from('comments').insert({post_id:currentPostForComment,user_id:currentAdmin.id,content});if(error){showToast('Error: '+error.message,'rose');return;}const{data:post}=await supabase.from('posts').select('comments').eq('id',currentPostForComment).single();await supabase.from('posts').update({comments:(post?.comments||0)+1}).eq('id',currentPostForComment);showToast('Comment posted!','emerald');document.getElementById('adminCommentText').value='';await loadPostComments(currentPostForComment);loadPosts();loadStats();};

/* ──────────────────────────────────────────
   COMMENTS
────────────────────────────────────────── */
window.loadComments=async function(){const c=document.getElementById('commentsContainer');c.innerHTML=loading();const s=(document.getElementById('commentSearch')?.value||'').toLowerCase();const{data,error}=await supabase.from('comments').select('*,profiles(stage_name,profile_picture),posts(content)').order('created_at',{ascending:false}).limit(200);if(error){c.innerHTML=err();return;}allComments=data||[];let f=allComments;if(s)f=allComments.filter(x=>x.content?.toLowerCase().includes(s)||x.profiles?.stage_name?.toLowerCase().includes(s));if(!f.length){c.innerHTML='<div class="empty-state"><i class="ri-chat-3-line"></i><p>No comments found</p></div>';return;}
c.innerHTML=`<table class="data-table"><thead><tr><th>Author</th><th>Comment</th><th>Post</th><th>Date</th><th>Actions</th></tr></thead><tbody>${
f.map(x=>`<tr>
<td class="no-label"><div class="user-cell"><img src="${x.profiles?.profile_picture||'user.webp'}" class="user-avatar" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(x.profiles?.stage_name||'U')}&background=4f46e5&color=fff'"><span class="user-name">${x.profiles?.stage_name||'—'}</span></div></td>
<td data-label="Comment" style="max-width:180px;">${(x.content||'').substring(0,70)}${x.content?.length>70?'…':''}</td>
<td data-label="Post" style="max-width:120px;color:var(--text3);font-size:12px;">${(x.posts?.content||'').substring(0,40)}…</td>
<td data-label="Date">${new Date(x.created_at).toLocaleDateString()}</td>
<td class="no-label" style="padding-top:6px;"><div class="act-group">
<button class="act-btn edit" title="Edit" onclick="openEditComment('${x.id}')"><i class="ri-edit-line"></i></button>
<button class="act-btn del" title="Delete" onclick="deleteComment('${x.id}','${x.post_id}')"><i class="ri-delete-bin-line"></i></button>
</div></td></tr>`).join('')
}</tbody></table>`;};
window.openEditComment=function(id){const x=allComments.find(c=>c.id===id);if(!x)return;document.getElementById('editCommentId').value=x.id;document.getElementById('editCommentContent').value=x.content||'';document.getElementById('editCommentModal').classList.add('active');};
window.closeEditCommentModal=()=>document.getElementById('editCommentModal').classList.remove('active');
window.saveCommentEdit=async function(){const id=document.getElementById('editCommentId').value;const content=document.getElementById('editCommentContent').value;const{error}=await supabase.from('comments').update({content}).eq('id',id);if(error){showToast('Error: '+error.message,'rose');return;}showToast('Comment updated!','emerald');closeEditCommentModal();loadComments();};
window.deleteComment=async function(id,postId){if(!confirm('Delete this comment?'))return;await supabase.from('comments').delete().eq('id',id);const{data:post}=await supabase.from('posts').select('comments').eq('id',postId).single();await supabase.from('posts').update({comments:Math.max(0,(post?.comments||1)-1)}).eq('id',postId);showToast('Comment deleted','rose');loadComments();loadStats();};

/* ══════════════════════════════════════════
   ANNOUNCEMENTS — Enhanced
══════════════════════════════════════════ */

/* Open modal & load users */
window.openBroadcastModal = async function() {
  document.getElementById('broadcastContent').value = '';
  document.getElementById('broadcastModal').classList.add('active');
  document.getElementById('linkPanel').style.display = 'none';
  document.getElementById('previewPane').style.display = 'none';
  document.getElementById('linkToggleBtn').innerHTML = '<i class="ri-link"></i> Add Link';
  selectedChips.clear();
  chipCounts = {};

  // Load all users
  const { data } = await supabase.from('profiles').select('id,stage_name,role,user_type').order('stage_name');
  broadcastUsers = (data || []).filter(u => u.id !== currentAdmin?.id);

  // Build role chips
  buildRoleChips();
  // Default to 'role' mode
  setRecipientMode('role');
};

window.closeBroadcastModal = () => document.getElementById('broadcastModal').classList.remove('active');

/* Build clickable role/type chips */
function buildRoleChips() {
  const grid = document.getElementById('roleChips');
  grid.innerHTML = ALL_CHIPS.map(chip => {
    const count = broadcastUsers.filter(u => u[chip.field] === chip.value).length;
    return `<div class="role-chip" id="chip_${chip.key}" onclick="toggleChip('${chip.key}')">
      <i class="${chip.icon} rc-icon"></i>
      <div class="rc-label">${chip.label}</div>
      <div class="rc-count">${count} user${count!==1?'s':''}</div>
    </div>`;
  }).join('');
}

/* Toggle a role chip on/off */
window.toggleChip = function(key) {
  const chip = ALL_CHIPS.find(c => c.key === key);
  if (!chip) return;
  if (selectedChips.has(key)) {
    selectedChips.delete(key);
    document.getElementById('chip_'+key)?.classList.remove('selected');
  } else {
    selectedChips.add(key);
    document.getElementById('chip_'+key)?.classList.add('selected');
    // Init count for this chip
    const maxCount = broadcastUsers.filter(u => u[chip.field] === chip.value).length;
    if (!chipCounts[key]) chipCounts[key] = { max: maxCount, chosen: maxCount };
    else chipCounts[key].max = maxCount;
  }
  renderCountControls();
  updateSummary();
};

/* Render per-role count controls */
function renderCountControls() {
  const container = document.getElementById('roleCountControls');
  if (selectedChips.size === 0) { container.innerHTML = ''; return; }

  container.innerHTML = [...selectedChips].map(key => {
    const chip = ALL_CHIPS.find(c => c.key === key);
    if (!chip) return '';
    const maxCount = broadcastUsers.filter(u => u[chip.field] === chip.value).length;
    chipCounts[key] = chipCounts[key] || { max: maxCount, chosen: maxCount };
    const chosen = chipCounts[key].chosen;
    return `<div class="count-control-row">
      <div>
        <div class="cc-label"><i class="${chip.icon}" style="font-size:14px;vertical-align:middle;margin-right:4px;"></i>${chip.label}</div>
        <div class="cc-sub">${maxCount} available · send to how many?</div>
      </div>
      <div class="count-input-wrap">
        <button class="count-adj-btn" onclick="adjustCount('${key}',-1)">−</button>
        <input type="number" min="0" max="${maxCount}" value="${chosen}" id="countInput_${key}"
          oninput="onCountInput('${key}',this.value)" style="width:70px;text-align:center;padding:7px 10px;font-size:13px;border-radius:var(--r-sm);border:1px solid var(--border2);background:var(--white);color:var(--text);font-family:inherit;font-weight:700;outline:none;">
        <button class="count-adj-btn" onclick="adjustCount('${key}',1)">+</button>
      </div>
    </div>`;
  }).join('');
}

window.adjustCount = function(key, delta) {
  if (!chipCounts[key]) return;
  const max = chipCounts[key].max;
  chipCounts[key].chosen = Math.max(0, Math.min(max, chipCounts[key].chosen + delta));
  const input = document.getElementById('countInput_' + key);
  if (input) input.value = chipCounts[key].chosen;
  updateSummary();
};

window.onCountInput = function(key, val) {
  if (!chipCounts[key]) return;
  const parsed = parseInt(val) || 0;
  chipCounts[key].chosen = Math.max(0, Math.min(chipCounts[key].max, parsed));
  updateSummary();
};

/* Update the recipient summary line */
function updateSummary() {
  const el = document.getElementById('summaryText');
  if (recipientMode === 'all') {
    const total = broadcastUsers.length;
    el.textContent = `Will send to all ${total} users`;
    return;
  }
  if (recipientMode === 'user') {
    const checked = document.querySelectorAll('#userCheckboxes input:checked').length;
    el.textContent = checked > 0 ? `${checked} user${checked!==1?'s':''} selected` : 'No users selected';
    return;
  }
  // role mode — compute resolved unique recipients
  const ids = resolveRoleRecipients().size;
  if (ids === 0) {
    el.textContent = 'Select at least one role above';
  } else {
    const parts = [...selectedChips].map(key => {
      const chip = ALL_CHIPS.find(c => c.key === key);
      const n = chipCounts[key]?.chosen ?? 0;
      return `${n} ${chip?.label || key}`;
    });
    el.textContent = `${ids} recipient${ids!==1?'s':''} · ${parts.join(', ')}`;
  }
}

/* Resolve the set of user IDs for 'role' mode */
function resolveRoleRecipients() {
  const idSet = new Set();
  for (const key of selectedChips) {
    const chip = ALL_CHIPS.find(c => c.key === key);
    if (!chip) continue;
    const matching = broadcastUsers.filter(u => u[chip.field] === chip.value);
    const count = chipCounts[key]?.chosen ?? matching.length;
    matching.slice(0, count).forEach(u => idSet.add(u.id));
  }
  return idSet;
}

/* Switch recipient mode */
window.setRecipientMode = function(mode) {
  recipientMode = mode;
  ['role','user','all'].forEach(m => {
    document.getElementById('recipientBy' + m.charAt(0).toUpperCase() + m.slice(1)).style.display = m === mode ? 'block' : 'none';
    document.getElementById('mode' + m.charAt(0).toUpperCase() + m.slice(1)).classList.toggle('active', m === mode);
  });

  // Populate user list for 'user' mode
  if (mode === 'user') {
    const box = document.getElementById('userCheckboxes');
    if (!broadcastUsers.length) { box.innerHTML = '<p style="padding:8px;font-size:12px;color:var(--text3);">No users found</p>'; }
    else {
      renderBroadcastUserList('');
    }
  }

  if (mode === 'all') {
    document.getElementById('everyoneCount').textContent =
      `This will send to all ${broadcastUsers.length} users.`;
  }

  updateSummary();
};

function renderBroadcastUserList(filter) {
  const box = document.getElementById('userCheckboxes');
  const f = filter.toLowerCase();
  const filtered = f ? broadcastUsers.filter(u => (u.stage_name||'').toLowerCase().includes(f) || (u.role||'').toLowerCase().includes(f)) : broadcastUsers;
  if (!filtered.length) { box.innerHTML = '<p style="padding:8px;font-size:12px;color:var(--text3);">No users match</p>'; return; }
  box.innerHTML = filtered.map(u => `
    <div class="ucheck">
      <input type="checkbox" id="uc_${u.id}" value="${u.id}" checked onchange="updateSummary()">
      <label for="uc_${u.id}">${u.stage_name || u.id}</label>
      <span class="user-role-tag">${u.role || 'user'}</span>
    </div>`).join('');
  updateSummary();
}

/* Select / Deselect All (user mode) */
window.toggleSelectAll = function() {
  const all = [...document.querySelectorAll('#userCheckboxes input[type="checkbox"]')];
  const allChecked = all.every(c => c.checked);
  all.forEach(c => c.checked = !allChecked);
  document.getElementById('selectAllBtn').textContent = allChecked ? 'Select All' : 'Deselect All';
  updateSummary();
};

/* ─── LINK BUILDER ─── */
window.toggleLinkPanel = function() {
  const panel = document.getElementById('linkPanel');
  const btn = document.getElementById('linkToggleBtn');
  const visible = panel.style.display !== 'none';
  panel.style.display = visible ? 'none' : 'block';
  btn.innerHTML = visible ? '<i class="ri-link"></i> Add Link' : '<i class="ri-close-line"></i> Close';
};

window.insertLink = function() {
  const text = document.getElementById('linkText').value.trim();
  const url = document.getElementById('linkUrl').value.trim();
  if (!url) { showToast('Enter a URL first', 'amber'); return; }
  const label = text || url;
  const textarea = document.getElementById('broadcastContent');
  const marker = `[${label}](${url})`;
  const start = textarea.selectionStart;
  const end = textarea.selectionEnd;
  textarea.value = textarea.value.substring(0, start) + marker + textarea.value.substring(end);
  textarea.focus();
  textarea.selectionStart = textarea.selectionEnd = start + marker.length;
  document.getElementById('linkText').value = '';
  document.getElementById('linkUrl').value = '';
  showToast('Link inserted!', 'emerald');
};

/* Toggle preview pane */
window.previewAnnouncement = function() {
  const pane = document.getElementById('previewPane');
  const content = document.getElementById('broadcastContent').value;
  if (pane.style.display === 'none') {
    document.getElementById('previewContent').innerHTML = renderAnnouncementContent(content) || '<em style="color:var(--text3);">Nothing to preview yet</em>';
    pane.style.display = 'block';
  } else {
    pane.style.display = 'none';
  }
};

/* Convert markdown-style [text](url) links to real <a> tags */
function renderAnnouncementContent(text) {
  if (!text) return '';
  // Escape HTML first
  let safe = text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
  // Convert [label](url)
  safe = safe.replace(/\[([^\]]+)\]\((https?:\/\/[^\)]+)\)/g,
    (_, label, url) => `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color:var(--brand,var(--indigo));font-weight:800;text-decoration:underline;">${label}</a>`);
  // Auto-link bare URLs not already in links
  safe = safe.replace(/(?<![">])(https?:\/\/[^\s<]+)/g,
    url => `<a href="${url}" target="_blank" rel="noopener noreferrer" style="color:var(--brand,var(--indigo));font-weight:800;text-decoration:underline;">${url}</a>`);
  // Newlines → <br>
  return safe.replace(/\n/g, '<br>');
}

/* Send announcement */
window.postAnnouncement = async function() {
  const content = document.getElementById('broadcastContent').value.trim();
  if (!content) { showToast('Write a message first', 'amber'); return; }

  let ids = [];
  if (recipientMode === 'all') {
    ids = broadcastUsers.map(u => u.id);
  } else if (recipientMode === 'user') {
    ids = [...document.querySelectorAll('#userCheckboxes input:checked')].map(c => c.value);
  } else {
    ids = [...resolveRoleRecipients()];
  }

  if (!ids.length) { showToast('Select at least one recipient', 'amber'); return; }

  const { error } = await supabase.from('notifications').insert(
    ids.map(uid => ({ user_id: uid, actor_id: currentAdmin.id, type: 'announcement', content }))
  );
  if (error) { showToast('Error: ' + error.message, 'rose'); return; }
  showToast(`Sent to ${ids.length} user${ids.length!==1?'s':''}!`, 'emerald');
  closeBroadcastModal();
  if (document.getElementById('announcements-tab').classList.contains('active')) loadAnnouncements();
};

/* Load announcements list */
window.loadAnnouncements = async function() {
  const c = document.getElementById('announcementsContainer');
  c.innerHTML = loading();
  const { data, error } = await supabase.from('notifications')
    .select('id,content,created_at,actor_id')
    .eq('actor_id', currentAdmin?.id)
    .neq('user_id', currentAdmin?.id)
    .order('created_at', { ascending: false });
  if (error) { c.innerHTML = err(); return; }
  const seen = new Set();
  const unique = (data || []).filter(n => {
    const k = n.content + n.created_at;
    if (seen.has(k)) return false;
    seen.add(k); return true;
  });
  if (!unique.length) {
    c.innerHTML = '<div class="empty-state"><i class="ri-megaphone-line"></i><p>No announcements yet</p></div>';
    return;
  }
  c.innerHTML = unique.map(a => {
    const preview = (a.content || '').substring(0, 120) + (a.content?.length > 120 ? '…' : '');
    const safeId = a.id;
    const safeContent = encodeURIComponent(a.content || '');
    const safeDate = encodeURIComponent(a.created_at);
    return `<div class="notif-row">
      <div class="notif-dot" style="background:var(--indigo);margin-top:5px;"></div>
      <div class="notif-body">
        <div class="notif-who"><span class="badge badge-admin">Announcement</span></div>
        <div class="notif-msg ann-msg-rendered">${renderAnnouncementContent(preview)}</div>
        <div class="notif-time">${new Date(a.created_at).toLocaleString()}</div>
      </div>
      <div class="act-group" style="flex-direction:column;gap:4px;">
        <button class="act-btn view" title="View" onclick="viewAnnouncement('${safeId}')"><i class="ri-eye-line"></i></button>
        <button class="act-btn del" title="Delete" onclick="deleteAnnouncement('${safeContent}','${safeDate}')"><i class="ri-delete-bin-line"></i></button>
      </div>
    </div>`;
  }).join('');
};

window.viewAnnouncement = async function(id) {
  const { data } = await supabase.from('notifications').select('content,created_at').eq('id', id).single();
  if (!data) return;
  document.getElementById('announcementModalContent').innerHTML = `
    <p style="font-size:12px;color:var(--text3);margin-bottom:10px;">Sent: ${new Date(data.created_at).toLocaleString()}</p>
    <div class="preview-box ann-msg-rendered">${renderAnnouncementContent(data.content)}</div>`;
  document.getElementById('announcementModal').classList.add('active');
};
window.closeAnnouncementModal = () => document.getElementById('announcementModal').classList.remove('active');

window.deleteAnnouncement = async function(encodedContent, encodedDate) {
  if (!confirm('Delete for all recipients?')) return;
  const content = decodeURIComponent(encodedContent);
  const createdAt = decodeURIComponent(encodedDate);
  const { error } = await supabase.from('notifications').delete()
    .eq('content', content).eq('created_at', createdAt).eq('actor_id', currentAdmin.id);
  if (error) { showToast('Error: ' + error.message, 'rose'); return; }
  showToast('Announcement deleted', 'rose');
  loadAnnouncements();
};

/* ──────────────────────────────────────────
   NOTIFICATIONS
────────────────────────────────────────── */
window.loadAllNotifications=async function(){const c=document.getElementById('notificationsContainer');c.innerHTML=loading();const s=(document.getElementById('notificationSearch')?.value||'').toLowerCase();const{data,error}=await supabase.from('notifications').select('*,profiles!notifications_user_id_fkey(stage_name)').order('created_at',{ascending:false}).limit(200);if(error){c.innerHTML=err();return;}allNotifications=data||[];let f=allNotifications;if(s)f=allNotifications.filter(n=>n.content?.toLowerCase().includes(s)||n.profiles?.stage_name?.toLowerCase().includes(s));if(!f.length){c.innerHTML='<div class="empty-state"><i class="ri-bell-line"></i><p>No notifications</p></div>';return;}c.innerHTML=f.map(n=>`<div class="notif-row"><div class="notif-dot" style="background:${n.type==='announcement'?'var(--indigo)':'var(--emerald)'};"></div><div class="notif-body"><div class="notif-who">${n.profiles?.stage_name||'—'}<span class="badge ${n.type==='announcement'?'badge-admin':'badge-active'}">${n.type||'notif'}</span></div><div class="notif-msg ann-msg-rendered">${n.type==='announcement'?renderAnnouncementContent((n.content||'').substring(0,100)):(n.content||'').substring(0,100)}${n.content?.length>100?'…':''}</div><div class="notif-time">${timeAgo(n.created_at)}</div></div><button class="act-btn del" title="Delete" onclick="deleteNotification('${n.id}')"><i class="ri-delete-bin-line"></i></button></div>`).join('');};
window.deleteNotification=async function(id){if(!confirm('Delete this notification?'))return;const{error}=await supabase.from('notifications').delete().eq('id',id);if(error){showToast('Error: '+error.message,'rose');return;}showToast('Deleted','rose');loadAllNotifications();};

/* ──────────────────────────────────────────
   GENERIC VIEW
────────────────────────────────────────── */
window.viewContent=function(title,content){document.getElementById('viewModalTitle').textContent=title;document.getElementById('viewModalContent').innerHTML=renderAnnouncementContent(content);document.getElementById('viewModal').classList.add('active');};
window.closeViewModal=()=>document.getElementById('viewModal').classList.remove('active');

/* ──────────────────────────────────────────
   TABS / NAV
────────────────────────────────────────── */
window.switchTab=function(tab){
  document.querySelectorAll('.tab,.nav-item[data-tab]').forEach(t=>t.classList.remove('active'));
  document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
  document.querySelector(`.tab[data-tab="${tab}"]`)?.classList.add('active');
  document.querySelector(`.nav-item[data-tab="${tab}"]`)?.classList.add('active');
  document.getElementById(`${tab}-tab`)?.classList.add('active');
  // Close sidebar on mobile after nav
  if(window.innerWidth<=768) closeSidebar();
  if(tab==='dashboard')loadActivityLog();
  else if(tab==='users')loadUsers();
  else if(tab==='posts')loadPosts();
  else if(tab==='comments')loadComments();
  else if(tab==='announcements')loadAnnouncements();
  else if(tab==='notifications')loadAllNotifications();
};

/* ──────────────────────────────────────────
   DARK MODE
────────────────────────────────────────── */
function applyTheme(dark) {
  document.documentElement.setAttribute('data-theme', dark?'dark':'light');
  const icon = dark?'ri-sun-line':'ri-moon-line';
  const label = dark?'Light Mode':'Dark Mode';
  document.getElementById('darkIcon').className=icon;
  const si=document.getElementById('darkIconSidebar'); if(si) si.className=icon;
  const sl=document.getElementById('darkLabel'); if(sl) sl.textContent=label;
  localStorage.setItem('keli-theme', dark?'dark':'light');
}
window.toggleDarkMode=function(){
  const isDark=document.documentElement.getAttribute('data-theme')==='dark';
  applyTheme(!isDark);
};

/* ──────────────────────────────────────────
   SIDEBAR (MOBILE)
────────────────────────────────────────── */
window.toggleSidebar=function(){
  const s=document.getElementById('sidebar'),o=document.getElementById('sidebarOverlay');
  s.classList.toggle('open');o.classList.toggle('open');
};
window.closeSidebar=function(){
  document.getElementById('sidebar')?.classList.remove('open');
  document.getElementById('sidebarOverlay')?.classList.remove('open');
};

/* ──────────────────────────────────────────
   COMMAND PALETTE
────────────────────────────────────────── */
const CMD_ITEMS = [
  {group:'Navigate',icon:'ri-dashboard-line',title:'Dashboard',sub:'Go to overview',action:()=>switchTab('dashboard')},
  {group:'Navigate',icon:'ri-user-line',title:'Users',sub:'Manage all users',action:()=>switchTab('users')},
  {group:'Navigate',icon:'ri-article-line',title:'Posts',sub:'Manage all posts',action:()=>switchTab('posts')},
  {group:'Navigate',icon:'ri-chat-3-line',title:'Comments',sub:'View comments',action:()=>switchTab('comments')},
  {group:'Navigate',icon:'ri-megaphone-line',title:'Announcements',sub:'View sent announcements',action:()=>switchTab('announcements')},
  {group:'Navigate',icon:'ri-bell-line',title:'Notifications',sub:'View all notifications',action:()=>switchTab('notifications')},
  {group:'Actions',icon:'ri-send-plane-line',title:'Broadcast Message',sub:'Send announcement to users',action:()=>openBroadcastModal()},
  {group:'Actions',icon:'ri-download-line',title:'Export Users CSV',sub:'Download user data',action:()=>exportUsersCSV()},
  {group:'Actions',icon:'ri-download-line',title:'Export Posts CSV',sub:'Download post data',action:()=>exportPostsCSV()},
  {group:'Actions',icon:'ri-refresh-line',title:'Refresh Stats',sub:'Reload platform metrics',action:()=>loadStats()},
  {group:'Settings',icon:'ri-moon-line',title:'Toggle Dark Mode',sub:'Switch theme',action:()=>toggleDarkMode()},
  {group:'Danger',icon:'ri-error-warning-line',title:'Danger Zone',sub:'Platform-wide nuclear actions',action:()=>openDangerZone()},
  {group:'Settings',icon:'ri-logout-box-line',title:'Logout',sub:'End admin session',action:()=>handleLogout()},
];
let cmdSelectedIdx = -1;
function openCmdPalette() {
  const overlay = document.getElementById('cmdOverlay');
  overlay.classList.add('open');
  document.getElementById('cmdInput').value='';
  renderCmdItems('');
  setTimeout(()=>document.getElementById('cmdInput').focus(),50);
}
function closeCmdPalette(e) {
  document.getElementById('cmdOverlay').classList.remove('open');
  cmdSelectedIdx=-1;
}
window.openCmdPalette=openCmdPalette;
function renderCmdItems(query) {
  const q=query.toLowerCase();
  const filtered=q?CMD_ITEMS.filter(i=>i.title.toLowerCase().includes(q)||i.sub.toLowerCase().includes(q)):CMD_ITEMS;
  if(!filtered.length){document.getElementById('cmdResults').innerHTML='<div class="cmd-empty">No commands found</div>';return;}
  const groups=[...new Set(filtered.map(i=>i.group))];
  document.getElementById('cmdResults').innerHTML=groups.map(g=>`
    <div class="cmd-group-label">${g}</div>
    ${filtered.filter(i=>i.group===g).map((item,idx)=>{
      const globalIdx=filtered.indexOf(item);
      return `<button class="cmd-item${globalIdx===cmdSelectedIdx?' selected':''}" onclick="runCmdItem(${CMD_ITEMS.indexOf(item)})">
        <i class="${item.icon}"></i>
        <div><div class="cmd-item-title">${item.title}</div><div class="cmd-item-sub">${item.sub}</div></div>
      </button>`;
    }).join('')}
  `).join('');
}
window.filterCmdItems=function(q){cmdSelectedIdx=-1;renderCmdItems(q);};
window.runCmdItem=function(idx){CMD_ITEMS[idx]?.action();closeCmdPalette();};
window.handleCmdKey=function(e){
  const items=document.querySelectorAll('.cmd-item');
  if(e.key==='Escape'){closeCmdPalette();}
  else if(e.key==='ArrowDown'){e.preventDefault();cmdSelectedIdx=Math.min(cmdSelectedIdx+1,items.length-1);items.forEach((el,i)=>el.classList.toggle('selected',i===cmdSelectedIdx));}
  else if(e.key==='ArrowUp'){e.preventDefault();cmdSelectedIdx=Math.max(cmdSelectedIdx-1,0);items.forEach((el,i)=>el.classList.toggle('selected',i===cmdSelectedIdx));}
  else if(e.key==='Enter'&&cmdSelectedIdx>=0){items[cmdSelectedIdx]?.click();}
};

/* ──────────────────────────────────────────
   BULK ACTIONS — USERS
────────────────────────────────────────── */
window.toggleAllUserChecks=function(masterCb){
  document.querySelectorAll('.user-check').forEach(cb=>cb.checked=masterCb.checked);
  onUserCheckChange();
};
window.onUserCheckChange=function(){
  const checked=[...document.querySelectorAll('.user-check:checked')];
  const bar=document.getElementById('userBulkBar');
  const countEl=document.getElementById('userBulkCount');
  if(checked.length>0){bar.classList.add('visible');countEl.textContent=`${checked.length} user${checked.length!==1?'s':''} selected`;}
  else{bar.classList.remove('visible');}
};
window.clearUserSelection=function(){
  document.querySelectorAll('.user-check,.row-check#checkAllUsers').forEach(cb=>cb.checked=false);
  document.getElementById('userBulkBar')?.classList.remove('visible');
};
window.bulkDeleteUsers=async function(){
  const ids=[...document.querySelectorAll('.user-check:checked')].map(cb=>cb.dataset.id);
  if(!ids.length)return;
  if(!confirm(`Delete ${ids.length} users? This is permanent!`))return;
  showToast(`Deleting ${ids.length} users…`,'amber');
  for(const id of ids){
    await Promise.all([
      supabase.from('posts').delete().eq('user_id',id),
      supabase.from('comments').delete().eq('user_id',id),
      supabase.from('post_likes').delete().eq('user_id',id),
      supabase.from('notifications').delete().eq('user_id',id),
    ]);
    await supabase.from('profiles').delete().eq('id',id);
  }
  showToast(`${ids.length} users deleted`,'rose');
  loadUsers();loadStats();
};

/* ──────────────────────────────────────────
   BULK ACTIONS — POSTS
────────────────────────────────────────── */
window.toggleAllPostChecks=function(masterCb){
  document.querySelectorAll('.post-check').forEach(cb=>cb.checked=masterCb.checked);
  onPostCheckChange();
};
window.onPostCheckChange=function(){
  const checked=[...document.querySelectorAll('.post-check:checked')];
  const bar=document.getElementById('postBulkBar');
  const countEl=document.getElementById('postBulkCount');
  if(checked.length>0){bar.classList.add('visible');countEl.textContent=`${checked.length} post${checked.length!==1?'s':''} selected`;}
  else{bar.classList.remove('visible');}
};
window.clearPostSelection=function(){
  document.querySelectorAll('.post-check,.row-check#checkAllPosts').forEach(cb=>cb.checked=false);
  document.getElementById('postBulkBar')?.classList.remove('visible');
};
window.bulkDeletePosts=async function(){
  const ids=[...document.querySelectorAll('.post-check:checked')].map(cb=>cb.dataset.id);
  if(!ids.length)return;
  if(!confirm(`Delete ${ids.length} posts?`))return;
  showToast(`Deleting ${ids.length} posts…`,'amber');
  for(const id of ids){
    await Promise.all([supabase.from('comments').delete().eq('post_id',id),supabase.from('post_likes').delete().eq('post_id',id)]);
    await supabase.from('posts').delete().eq('id',id);
  }
  showToast(`${ids.length} posts deleted`,'rose');
  loadPosts();loadStats();
};

/* ──────────────────────────────────────────
   CSV EXPORTS
────────────────────────────────────────── */
window.exportUsersCSV=function(){
  if(!allUsers.length){showToast('Load users first','amber');return;}
  const headers=['ID','Name','Email','Role','UserType','Tier','Score','Coins','Tracks','Invites','Joined'];
  const rows=allUsers.map(u=>[u.id,u.stage_name||'',u.email||'',u.role||'',u.user_type||'',u.tier||'',u.score||0,u.coins||0,u.track_count||0,u.invite_count||0,new Date(u.created_at).toLocaleDateString()]);
  downloadCSV([headers,...rows],'keli-users.csv');
  showToast(`Exported ${allUsers.length} users`,'emerald');
};
window.exportPostsCSV=function(){
  if(!allPosts.length){showToast('Load posts first','amber');return;}
  const headers=['ID','Author','Content','Likes','Comments','Date'];
  const rows=allPosts.map(p=>[p.id,p.profiles?.stage_name||'',(p.content||'').replace(/,/g,';').replace(/\n/g,' ').substring(0,200),p.likes||0,p.comments||0,new Date(p.created_at).toLocaleDateString()]);
  downloadCSV([headers,...rows],'keli-posts.csv');
  showToast(`Exported ${allPosts.length} posts`,'emerald');
};
function downloadCSV(rows, filename) {
  const csv=rows.map(r=>r.map(v=>`"${String(v).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob=new Blob([csv],{type:'text/csv'});
  const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download=filename; a.click();
}

/* ──────────────────────────────────────────
   PROFILE QUICK-VIEW DRAWER
────────────────────────────────────────── */
window.openProfileDrawer=function(id){
  const u=allUsers.find(x=>x.id===id); if(!u) return;
  const content=document.getElementById('profileDrawerContent');
  content.innerHTML=`
    <div class="profile-hero">
      <img src="${u.profile_picture||'user.webp'}" onerror="this.src='https://ui-avatars.com/api/?name=${encodeURIComponent(u.stage_name||'U')}&background=4f46e5&color=fff&size=128'">
      <div class="profile-hero-name">${u.stage_name||'—'}</div>
      <div class="profile-hero-email">${u.email||'No email'}</div>
      <div class="profile-hero-badges">
        <span class="badge ${u.user_type==='Admin'?'badge-admin':'badge-user'}">${u.user_type||'User'}</span>
        <span class="badge ${u.tier==='pro'?'badge-amber':u.tier==='premium'?'badge-admin':'badge-user'}">${u.tier||'basic'}</span>
        ${u.is_admin?'<span class="badge badge-active"><i class="ri-shield-check-line"></i> Admin</span>':''}
        ${u.role&&u.role!=='user'?`<span class="badge badge-amber">${u.role}</span>`:''}
      </div>
    </div>

    <div class="collapse-section open" id="cs-stats">
      <button class="collapse-trigger" onclick="toggleCollapse('cs-stats')">
        <i class="ri-bar-chart-line section-icon"></i> Stats
        <i class="ri-arrow-down-s-line chevron"></i>
      </button>
      <div class="collapse-body">
        <div class="profile-kv"><span class="profile-kv-key">Score</span><span class="profile-kv-val">${(u.score||0).toLocaleString()}</span></div>
        <div class="profile-kv"><span class="profile-kv-key">Coins</span><span class="profile-kv-val">${(u.coins||0).toLocaleString()}</span></div>
        <div class="profile-kv"><span class="profile-kv-key">Tracks</span><span class="profile-kv-val">${u.track_count||0}</span></div>
        <div class="profile-kv"><span class="profile-kv-key">Collabs</span><span class="profile-kv-val">${u.collab_count||0}</span></div>
        <div class="profile-kv"><span class="profile-kv-key">Invites Sent</span><span class="profile-kv-val">${u.invite_count||0}</span></div>
      </div>
    </div>

    <div class="collapse-section" id="cs-limits">
      <button class="collapse-trigger" onclick="toggleCollapse('cs-limits')">
        <i class="ri-settings-3-line section-icon"></i> Limits & Usage
        <i class="ri-arrow-down-s-line chevron"></i>
      </button>
      <div class="collapse-body">
        <div class="profile-kv"><span class="profile-kv-key">Max Releases</span><span class="profile-kv-val">${u.max_releases||0}</span></div>
        <div class="profile-kv"><span class="profile-kv-key">Current Releases</span><span class="profile-kv-val">${u.current_release_count||0}</span></div>
        <div class="profile-kv"><span class="profile-kv-key">Max Edits</span><span class="profile-kv-val">${u.max_edits||0}</span></div>
        <div class="profile-kv"><span class="profile-kv-key">Edits Remaining</span><span class="profile-kv-val">${u.edits_remaining||0}</span></div>
        <div class="profile-kv"><span class="profile-kv-key">Max Audio</span><span class="profile-kv-val">${u.max_audio_previews||0}</span></div>
        <div class="profile-kv"><span class="profile-kv-key">Audio Count</span><span class="profile-kv-val">${u.current_audio_count||0}</span></div>
      </div>
    </div>

    <div class="collapse-section" id="cs-account">
      <button class="collapse-trigger" onclick="toggleCollapse('cs-account')">
        <i class="ri-user-line section-icon"></i> Account
        <i class="ri-arrow-down-s-line chevron"></i>
      </button>
      <div class="collapse-body">
        <div class="profile-kv"><span class="profile-kv-key">Joined</span><span class="profile-kv-val">${new Date(u.created_at).toLocaleDateString()}</span></div>
        <div class="profile-kv"><span class="profile-kv-key">Payment ID</span><span class="profile-kv-val" style="font-size:11px;word-break:break-all;">${u.payment_id||'—'}</span></div>
        <div class="profile-kv"><span class="profile-kv-key">Invite Code</span><span class="profile-kv-val">${u.invite_code||'—'}</span></div>
        <div class="profile-kv"><span class="profile-kv-key">Invited By</span><span class="profile-kv-val">${u.invited_by_code||'—'}</span></div>
        <div class="profile-kv"><span class="profile-kv-key">Status Badge</span><span class="profile-kv-val">${u.status_badge||'—'}</span></div>
        <div class="profile-kv"><span class="profile-kv-key">Can See Invite</span><span class="profile-kv-val">${u.can_see_invite?'Yes':'No'}</span></div>
        ${u.bio?`<div style="margin-top:8px;font-size:12px;color:var(--text2);line-height:1.5;padding:8px;background:var(--bg);border-radius:var(--r-sm);">${u.bio}</div>`:''}
      </div>
    </div>

    <div class="profile-drawer-actions">
      <button class="btn btn-primary" onclick="openEditUser('${u.id}');closeProfileDrawer();"><i class="ri-edit-line"></i>Edit User</button>
      <button class="btn btn-secondary" onclick="toggleAdmin('${u.id}',${u.is_admin});closeProfileDrawer();">
        <i class="ri-${u.is_admin?'user-line':'shield-star-line'}"></i>${u.is_admin?'Revoke Admin':'Make Admin'}
      </button>
      <button class="btn" style="background:var(--rose-l);color:var(--rose);border:none;justify-content:center;" onclick="deleteUser('${u.id}','${(u.stage_name||'').replace(/'/g,"\\'")}');closeProfileDrawer();">
        <i class="ri-delete-bin-line"></i>Delete User
      </button>
    </div>`;
  document.getElementById('profileDrawer').classList.add('open');
};
window.closeProfileDrawer=function(){document.getElementById('profileDrawer').classList.remove('open');};
window.toggleCollapse=function(id){document.getElementById(id)?.classList.toggle('open');};

/* ──────────────────────────────────────────
   LIVE CLOCK + SESSION TIMER
────────────────────────────────────────── */
let sessionStart = Date.now();
function startClock() {
  function tick() {
    const now = new Date();
    const h=String(now.getHours()).padStart(2,'0');
    const m=String(now.getMinutes()).padStart(2,'0');
    const s=String(now.getSeconds()).padStart(2,'0');
    const cl=document.getElementById('liveClock');
    if(cl) cl.textContent=`${h}:${m}:${s}`;
    const dl=document.getElementById('liveDate');
    if(dl) dl.textContent=now.toLocaleDateString('en',{weekday:'long',month:'short',day:'numeric'});
    const elapsed=Math.floor((Date.now()-sessionStart)/1000);
    const em=Math.floor(elapsed/60), es=elapsed%60;
    const st=document.getElementById('sessionTimer');
    if(st) st.textContent=`Session: ${em}:${String(es).padStart(2,'0')}`;
  }
  tick();
  setInterval(tick, 1000);
}

/* ──────────────────────────────────────────
   DANGER ZONE
────────────────────────────────────────── */
window.openDangerZone=function(){document.getElementById('dangerModal').classList.add('active');};
window.closeDangerZone=function(){document.getElementById('dangerModal').classList.remove('active');};

window.dangerPurgeAllPosts=async function(){
  const confirm1=prompt('Type DELETE ALL POSTS to confirm. This cannot be undone.');
  if(confirm1!=='DELETE ALL POSTS'){showToast('Cancelled','amber');return;}
  showToast('Purging all posts…','rose');
  const{data:posts}=await supabase.from('posts').select('id');
  if(posts?.length){
    for(const p of posts){
      await Promise.all([
        supabase.from('comments').delete().eq('post_id',p.id),
        supabase.from('post_likes').delete().eq('post_id',p.id),
        supabase.from('post_shares').delete().eq('post_id',p.id),
        supabase.from('post_bookmarks').delete().eq('post_id',p.id),
      ]);
    }
    await supabase.from('posts').delete().neq('id','00000000-0000-0000-0000-000000000000');
  }
  showToast(`${posts?.length||0} posts purged`,'rose');
  closeDangerZone();loadStats();
};

window.dangerClearAllNotifications=async function(){
  const confirm1=prompt('Type CLEAR NOTIFICATIONS to confirm.');
  if(confirm1!=='CLEAR NOTIFICATIONS'){showToast('Cancelled','amber');return;}
  await supabase.from('notifications').delete().neq('id','00000000-0000-0000-0000-000000000000');
  showToast('All notifications cleared','rose');
  closeDangerZone();
};

window.dangerRevokeAllAdmins=async function(){
  const confirm1=prompt('Type REVOKE ALL ADMINS to confirm. You will remain admin.');
  if(confirm1!=='REVOKE ALL ADMINS'){showToast('Cancelled','amber');return;}
  await supabase.from('profiles').update({is_admin:false}).neq('id',currentAdmin.id);
  showToast('All admin access revoked','rose');
  closeDangerZone();loadUsers();
};

/* ──────────────────────────────────────────
   LOGOUT
────────────────────────────────────────── */
window.handleLogout=async function(){if(confirm('Log out?')){await supabase.auth.signOut();window.location.href='login.html';}};

/* ──────────────────────────────────────────
   TOAST
────────────────────────────────────────── */
window.showToast=function(msg,type='emerald'){const clr={emerald:'#059669',rose:'#e11d48',amber:'#d97706',indigo:'#4f46e5'};const ico={emerald:'ri-check-line',rose:'ri-error-warning-line',amber:'ri-alert-line',indigo:'ri-information-line'};const t=document.createElement('div');t.className='toast';t.style.borderLeft=`3px solid ${clr[type]||clr.emerald}`;t.innerHTML=`<i class="${ico[type]||ico.emerald}" style="color:${clr[type]||clr.emerald}"></i><span>${msg}</span>`;document.body.appendChild(t);setTimeout(()=>{t.style.opacity='0';t.style.transition='opacity 0.3s';setTimeout(()=>t.remove(),300);},3000);};

/* ──────────────────────────────────────────
   HELPERS
────────────────────────────────────────── */
function loading(){return'<div class="loading-inner"><div class="spinner"></div><p>Loading…</p></div>';}
function err(){return'<div class="empty-state"><i class="ri-error-warning-line"></i><p>Error loading data</p></div>';}
function timeAgo(d){const s=Math.floor((Date.now()-new Date(d))/1000);if(s<60)return`${s}s ago`;if(s<3600)return`${Math.floor(s/60)}m ago`;if(s<86400)return`${Math.floor(s/3600)}h ago`;if(s<2592000)return`${Math.floor(s/86400)}d ago`;return new Date(d).toLocaleDateString();}
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}

/* ──────────────────────────────────────────
   KEYBOARD SHORTCUT — ⌘K / CTRL+K
────────────────────────────────────────── */
document.addEventListener('keydown',e=>{
  if((e.metaKey||e.ctrlKey)&&e.key==='k'){e.preventDefault();openCmdPalette();}
});
/* ──────────────────────────────────────────
   REALTIME
────────────────────────────────────────── */
  supabase.channel('keli-admin')
    .on('postgres_changes',{event:'*',schema:'public',table:'profiles'},()=>{loadStats();if(document.getElementById('users-tab').classList.contains('active'))loadUsers();})
    .on('postgres_changes',{event:'*',schema:'public',table:'posts'},()=>{loadStats();if(document.getElementById('posts-tab').classList.contains('active'))loadPosts();})
    .on('postgres_changes',{event:'*',schema:'public',table:'comments'},()=>{loadStats();if(document.getElementById('comments-tab').classList.contains('active'))loadComments();})
    .on('postgres_changes',{event:'*',schema:'public',table:'notifications'},()=>{if(document.getElementById('announcements-tab').classList.contains('active'))loadAnnouncements();if(document.getElementById('notifications-tab').classList.contains('active'))loadAllNotifications();})
    .subscribe();
  setInterval(loadStats,30000);
}

/* ──────────────────────────────────────────
   INIT
────────────────────────────────────────── */
async function init(){
  // Apply saved theme
  const savedTheme=localStorage.getItem('keli-theme');
  if(savedTheme==='dark') applyTheme(true);
  const ok=await checkAdmin();
  const overlay=document.getElementById('loadingOverlay');
  if(!ok){overlay.querySelector('.load-msg').textContent='Access denied. Redirecting…';return;}
  overlay.style.opacity='0';overlay.style.transition='opacity 0.35s';
  setTimeout(()=>overlay.remove(),350);
  document.getElementById('app').style.display='block';
  // Update sidebar admin name
  if(currentAdmin){
    const sn=document.getElementById('sidebarAdminName');
    if(sn)sn.textContent=`Hi, ${currentAdmin.stage_name||'Admin'}`;
    document.getElementById('adminName').textContent=`Hi, ${currentAdmin.stage_name||'Admin'}`;
  }
  await Promise.all([loadStats(),loadActivityLog()]);
  document.getElementById('userSearch')?.addEventListener('input',debounce(loadUsers,400));
  document.getElementById('postSearch')?.addEventListener('input',debounce(loadPosts,400));
  document.getElementById('commentSearch')?.addEventListener('input',debounce(loadComments,400));
  document.getElementById('notificationSearch')?.addEventListener('input',debounce(loadAllNotifications,400));
  wireRealtime();
  startClock();
  // Populate command center banner
  if(currentAdmin){
    const n=currentAdmin.stage_name||'Admin';
    const cc=document.getElementById('ccName'); if(cc) cc.textContent=n;
    const av=document.getElementById('ccAvatar');
    if(av&&currentAdmin.profile_picture){av.innerHTML=`<img src="${currentAdmin.profile_picture}" style="width:42px;height:42px;border-radius:50%;object-fit:cover;" onerror="this.parentElement.innerHTML='<i class=\\'ri-shield-star-line\\'></i>'">`;}
  }
  showToast('Mission control ready ⚡','indigo');
}
init();
</script>
</body>
</html>
