<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Keli Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
<style>
/* --- Root Variables --- */
:root {
    --bg-black: #000000;
    --bg-card: #16181c;
    --accent: #1d9bf0;
    --border: #2f3336;
    --text-main: #e7e9ea;
    --text-dim: #71767b;
    --danger: #f4212e;
    --success: #00ba7c;
    --hover: rgba(255, 255, 255, 0.03);
}

/* --- Global Reset --- */
* { margin: 0; padding: 0; box-sizing: border-box; }

body {
    font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
    background-color: var(--bg-black);
    color: var(--text-main);
    line-height: 1.4;
}

/* --- Main Container --- */
.admin-container {
    max-width: 1300px;
    margin: 0 auto;
    border-left: 1px solid var(--border);
    border-right: 1px solid var(--border);
    min-height: 100vh;
}

/* --- Responsive Header --- */
.admin-header {
    display: flex;
    flex-direction: row-reverse;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid var(--border);
    background: rgba(0, 0, 0, 0.85);
    backdrop-filter: blur(12px);
    position: sticky;
    top: 0;
    z-index: 1000;
}

.admin-header h1 { font-size: 18px; font-weight: 800; flex: 1; }
#adminName { font-size: 12px; color: var(--text-dim); margin: 0 10px; display: block; }

.logout-btn {
    background: transparent;
    border: 1px solid var(--border);
    color: var(--text-main);
    padding: 6px 12px;
    border-radius: 99px;
    font-weight: 700;
    font-size: 13px;
}

/* --- Stats Grid: Responsive --- */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr); /* 2x2 on mobile */
    border-bottom: 1px solid var(--border);
}

.stat-card {
    padding: 16px;
    border-right: 1px solid var(--border);
    border-bottom: 1px solid var(--border);
}

.stat-card:nth-child(even) { border-right: none; }
.stat-card .stat-value { font-size: 20px; font-weight: 800; }

/* --- Quick Actions: Responsive --- */
.quick-actions {
    display: grid;
    grid-template-columns: 1fr; /* Stacked on mobile */
    border-bottom: 1px solid var(--border);
}

.action-card {
    padding: 16px;
    display: flex;
    align-items: center;
    gap: 12px;
    border-bottom: 1px solid var(--border);
}

/* --- Tabs: Scrollable --- */
.tabs {
    display: flex;
    border-bottom: 1px solid var(--border);
    overflow-x: auto;
    white-space: nowrap;
    scrollbar-width: none; /* Hide scrollbar Firefox */
}
.tabs::-webkit-scrollbar { display: none; } /* Hide scrollbar Chrome */

.tab {
    flex: 1;
    padding: 16px 20px;
    min-width: 100px;
    font-size: 14px;
}

/* --- Tables: The hardest part for mobile --- */
.data-table { width: 100%; border-collapse: collapse; }
.data-table th, .data-table td { 
    padding: 12px 8px; 
    font-size: 13px;
}

/* --- Modals: Responsive --- */
.modal-content {
    width: 95%;
    margin: 10px;
    max-height: 85vh;
}

/* ==========================================
   MOBILE & TABLET OPTIMIZATIONS
   ========================================== */
@media (max-width: 600px) {
    /* Hide non-essential table columns on phone */
    .data-table th:nth-child(2), 
    .data-table td:nth-child(2),
    .data-table th:nth-child(4), 
    .data-table td:nth-child(4) {
        display: none; 
    }

    .admin-header h1 { font-size: 16px; }
    
    /* Stats become 2x2 */
    .stats-grid { grid-template-columns: repeat(2, 1fr); }
    
    /* Toolbar (Search + Button) stacks */
    .toolbar {
        flex-direction: column;
        align-items: stretch;
    }
    
    .btn { justify-content: center; }
}

@media (min-width: 900px) {
    /* Desktop layout adjustments */
    .stats-grid { grid-template-columns: repeat(4, 1fr); }
    .stat-card:nth-child(even) { border-right: 1px solid var(--border); }
    .stat-card:last-child { border-right: none; }
    
    .quick-actions { grid-template-columns: repeat(3, 1fr); }
    .action-card { border-bottom: none; }
}

/* Utility Classes */
.loading { padding: 40px; text-align: center; }
.spinner {
    border: 3px solid var(--border);
    border-top: 3px solid var(--accent);
    border-radius: 50%;
    width: 30px; height: 30px;
    animation: spin 1s linear infinite;
    margin: 0 auto 10px;
}
@keyframes spin { 100% { transform: rotate(360deg); } }

/* Toast Responsive */
.toast {
    left: 10px;
    right: 10px;
    bottom: 10px;
    font-size: 13px;
}

</style>
</head>
<body>
    <div class="admin-container">
        <div class="admin-header">
            <button class="logout-btn" onclick="handleLogout()">
                <i class="ri-logout-box-line"></i> Logout
            </button>
            <h1><i class="ri-shield-star-line"></i> Admin Control Panel</h1>
            <p id="adminName">Loading...</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <i class="ri-user-line" style="color: #667eea;"></i>
                <h3>Total Users</h3>
                <div class="stat-value" id="totalUsers">-</div>
                <div class="stat-change" id="userChange">Loading...</div>
            </div>
            <div class="stat-card">
                <i class="ri-article-line" style="color: #10b981;"></i>
                <h3>Total Posts</h3>
                <div class="stat-value" id="totalPosts">-</div>
                <div class="stat-change" id="postChange">Loading...</div>
            </div>
            <div class="stat-card">
                <i class="ri-chat-3-line" style="color: #f59e0b;"></i>
                <h3>Total Comments</h3>
                <div class="stat-value" id="totalComments">-</div>
                <div class="stat-change" id="commentChange">Loading...</div>
            </div>
            <div class="stat-card">
                <i class="ri-heart-line" style="color: #ef4444;"></i>
                <h3>Total Likes</h3>
                <div class="stat-value" id="totalLikes">-</div>
                <div class="stat-change" id="likeChange">Loading...</div>
            </div>
        </div>

        <div class="quick-actions">
            <div class="action-card" onclick="openBroadcastModal()">
                <i class="ri-notification-3-line"></i>
                <div class="action-card-content">
                    <h3>Create Announcement</h3>
                    <p>Post as admin to all users</p>
                </div>
            </div>
            <div class="action-card" onclick="viewAllNotifications()">
                <i class="ri-mail-line"></i>
                <div class="action-card-content">
                    <h3>View Notifications</h3>
                    <p>Check all user notifications</p>
                </div>
            </div>
            <div class="action-card" onclick="switchTab('users')">
                <i class="ri-user-settings-line"></i>
                <div class="action-card-content">
                    <h3>Manage Users</h3>
                    <p>View and moderate users</p>
                </div>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">
                <i class="ri-dashboard-line"></i> Dashboard
            </button>
            <button class="tab" onclick="switchTab('users')">
                <i class="ri-user-line"></i> Users
            </button>
            <button class="tab" onclick="switchTab('posts')">
                <i class="ri-article-line"></i> Posts
            </button>
            <button class="tab" onclick="switchTab('comments')">
                <i class="ri-chat-3-line"></i> Comments
            </button>
            <button class="tab" onclick="switchTab('announcements')">
                <i class="ri-megaphone-line"></i> Announcements
            </button>  
        </div>

        <div id="dashboard-tab" class="tab-content active">
            <div class="content-card">
                <h2><i class="ri-time-line"></i> Recent Activity</h2>
                <div id="activityLog">
                    <div class="loading"><div class="spinner"></div><p>Loading activity...</p></div>
                </div>
            </div>
        </div>

        <div id="users-tab" class="tab-content">
            <div class="content-card">
                <div class="toolbar">
                    <div class="search-bar">
                        <input type="text" id="userSearch" placeholder="ðŸ” Search users...">
                    </div>
                    <button class="btn btn-primary" onclick="loadUsers()">
                        <i class="ri-refresh-line"></i> Refresh
                    </button>
                </div>
                <div id="usersContainer" class="loading">
                    <div class="spinner"></div><p>Loading users...</p>
                </div>
            </div>
        </div>

        <div id="posts-tab" class="tab-content">
            <div class="content-card">
                <div class="toolbar">
                    <div class="search-bar">
                        <input type="text" id="postSearch" placeholder="ðŸ” Search posts...">
                    </div>
                    <button class="btn btn-primary" onclick="loadPosts()">
                        <i class="ri-refresh-line"></i> Refresh
                    </button>
                </div>
                <div id="postsContainer" class="loading">
                    <div class="spinner"></div><p>Loading posts...</p>
                </div>
            </div>
        </div>

        <div id="comments-tab" class="tab-content">
            <div class="content-card">
                <div class="toolbar">
                    <div class="search-bar">
                        <input type="text" id="commentSearch" placeholder="ðŸ” Search comments...">
                    </div>
                    <button class="btn btn-primary" onclick="loadComments()">
                        <i class="ri-refresh-line"></i> Refresh
                    </button>
                </div>
                <div id="commentsContainer" class="loading">
                    <div class="spinner"></div><p>Loading comments...</p>
                </div>
            </div>
        </div>

        <div id="announcements-tab" class="tab-content">  
            <div class="content-card">  
                <div class="toolbar">  
                    <button class="btn btn-primary" onclick="loadAnnouncements()"><i class="ri-refresh-line"></i> Refresh</button>  
                </div>  
                <div id="announcementsContainer" class="loading">
                    <div class="spinner"></div><p>Loading announcements...</p>
                </div>  
            </div>  
        </div>  

        <div id="announcementModal" class="modal">  
            <div class="modal-content">  
                <div class="modal-header">  
                    <h2 id="announcementModalTitle"><i class="ri-megaphone-line"></i> Announcement</h2>  
                    <button class="close-modal" onclick="closeAnnouncementModal()">&times;</button>  
                </div>  
                <div id="announcementModalContent" class="form-group"></div>  
            </div>  
        </div>  

        <div id="adminCommentModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="ri-shield-star-line"></i> Comment as Admin</h2>
                    <button class="close-modal" onclick="closeCommentModal()">&times;</button>
                </div>
                <div class="form-group" id="postCommentsContainer" style="max-height: 300px; overflow-y: auto;">
                    <div class="loading"><div class="spinner"></div><p>Loading...</p></div>
                </div>
                <form id="adminCommentForm">
                    <div class="form-group">
                        <textarea id="adminCommentText" placeholder="Write your comment..." required></textarea>
                    </div>
                    <div class="form-actions" style="padding: 16px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px;">
                        <button type="button" class="btn btn-secondary" onclick="closeCommentModal()">Cancel</button>
                        <button type="submit" class="btn btn-primary" id="postCommentBtn">Post Comment</button>
                    </div>
                </form>
            </div>
        </div>

        <div id="broadcastModal" class="modal">  
            <div class="modal-content">  
                <div class="modal-header">  
                    <h2><i class="ri-megaphone-line"></i> Post Announcement</h2>  
                    <button class="close-modal" onclick="closeBroadcastModal()">&times;</button>  
                </div>  
                <form id="broadcastForm">  
                    <div class="form-group">  
                        <label for="broadcastContent">Announcement Content</label>  
                        <textarea id="broadcastContent" required></textarea>  
                    </div>  
                    <div class="form-group">  
                        <label>Select Users</label>  
                        <div id="userCheckboxes" style="max-height: 150px; overflow-y: auto; border: 1px solid var(--border); padding: 8px;">  
                        </div>  
                    </div>  
                    <div class="form-actions" style="padding: 16px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px;">  
                        <button type="button" class="btn btn-secondary" onclick="closeBroadcastModal()">Cancel</button>  
                        <button type="submit" class="btn btn-primary" id="postBroadcastBtn">Post Announcement</button>  
                    </div>  
                </form>  
            </div>  
        </div> 

        <div id="notificationsModal" class="modal">
            <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="ri-mail-line"></i> Notifications</h2>
                    <button class="close-modal" onclick="closeNotificationsModal()">&times;</button>
                </div>
                <div id="notificationsContainer" style="max-height: 500px; overflow-y: auto;">
                    <div class="loading"><div class="spinner"></div><p>Loading...</p></div>
                </div>
            </div>
        </div>
    </div>


<script type="module">  
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const supabaseUrl = 'https://xaudpqhyyxburjazfips.supabase.co'  
const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhdWRwcWh5eXhidXJqYXpmaXBzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMTY1NDUsImV4cCI6MjA3Nzg5MjU0NX0.LxRbfT0TsxJ38dwTQyKhn_Hi1cuZXZ6tpE04YPatGkQ'  
const supabase = createClient(supabaseUrl, supabaseKey)  

window.supabase = supabase  
let allUsers = []  
let allPosts = []  
let allComments = []  
let allNotifications = []
let currentAdminProfile = null  
let currentPostId = null  

// Show loading overlay
function showLoadingOverlay() {
    const overlay = document.createElement('div')
    overlay.id = 'adminLoadingOverlay'
    overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.95);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 99999;
    `
    overlay.innerHTML = `
        <div class="spinner" style="width: 60px; height: 60px; border: 4px solid #333; border-top-color: #667eea; border-radius: 50%; animation: spin 1s linear infinite;"></div>
        <p style="color: white; margin-top: 20px; font-size: 18px;">Verifying Admin Access...</p>
    `
    document.body.appendChild(overlay)
}

function hideLoadingOverlay() {
    const overlay = document.getElementById('adminLoadingOverlay')
    if (overlay) overlay.remove()
}

// Check admin authentication  
async function checkAdmin() {  
    const {data: {session}} = await supabase.auth.getSession()  
    if (!session) {  
        window.location.href = 'login.html'  
        return false  
    }  

    const {data: profile, error} = await supabase  
        .from('profiles')  
        .select('*')  
        .eq('id', session.user.id)  
        .single()  

    if (error) {  
        console.error('Error loading profile:', error)  
        showToast('Error loading admin profile', '#ef4444')  
        return false  
    }  

    if (!profile) {  
        showToast('Profile not found', '#ef4444')  
        return false  
    }  

    currentAdminProfile = profile  
    document.getElementById('adminName').textContent = `Welcome, ${profile.stage_name || 'Admin'}`  

    // Check if user is admin (you can add is_admin column or check user_type)  
    if (profile.user_type !== 'Admin' && !profile.is_admin) {  
        showToast('Access denied: Admin only', '#ef4444')  
        setTimeout(() => {  
            window.location.href = 'home.html'  
        }, 2000)  
        return false  
    }  

    return true  
}  

// Load statistics  
async function loadStats() {  
    try {  
        const [users, posts, comments, likes] = await Promise.all([  
            supabase.from('profiles').select('id', {count: 'exact', head: true}),  
            supabase.from('posts').select('id', {count: 'exact', head: true}),  
            supabase.from('comments').select('id', {count: 'exact', head: true}),  
            supabase.from('post_likes').select('id', {count: 'exact', head: true})  
        ])  

        document.getElementById('totalUsers').textContent = users.count || 0  
        document.getElementById('totalPosts').textContent = posts.count || 0  
        document.getElementById('totalComments').textContent = comments.count || 0  
        document.getElementById('totalLikes').textContent = likes.count || 0  

        document.getElementById('userChange').textContent = `${users.count || 0} registered`  
        document.getElementById('postChange').textContent = `${posts.count || 0} published`  
        document.getElementById('commentChange').textContent = `${comments.count || 0} total`  
        document.getElementById('likeChange').textContent = `${likes.count || 0} total`  
    } catch (err) {  
        console.error('Error loading stats:', err)  
    }  
}  

// Load activity log  
async function loadActivityLog() {  
    const container = document.getElementById('activityLog')  

    try {  
        const {data: recentPosts} = await supabase  
            .from('posts')  
            .select('*, profiles(stage_name)')  
            .order('created_at', {ascending: false})  
            .limit(5)  

        const {data: recentComments} = await supabase  
            .from('comments')  
            .select('*, profiles(stage_name)')  
            .order('created_at', {ascending: false})  
            .limit(5)  

        const {data: recentUsers} = await supabase  
            .from('profiles')  
            .select('*')  
            .order('created_at', {ascending: false})  
            .limit(5)  

        const activities = [  
            ...(recentPosts || []).map(p => ({type: 'post', data: p, time: p.created_at})),  
            ...(recentComments || []).map(c => ({type: 'comment', data: c, time: c.created_at})),  
            ...(recentUsers || []).map(u => ({type: 'user', data: u, time: u.created_at}))  
        ].sort((a, b) => new Date(b.time) - new Date(a.time)).slice(0, 15)  

        container.innerHTML = activities.map(activity => {  
            let icon, text, color  
            if (activity.type === 'post') {  
                icon = 'ri-article-line'  
                text = `${activity.data.profiles?.stage_name || 'User'} created a post`  
                color = '#10b981'  
            } else if (activity.type === 'comment') {  
                icon = 'ri-chat-3-line'  
                text = `${activity.data.profiles?.stage_name || 'User'} posted a comment`  
                color = '#f59e0b'  
            } else {  
                icon = 'ri-user-add-line'  
                text = `${activity.data.stage_name || 'Someone'} joined`  
                color = '#667eea'  
            }  

            return `  
                <div class="activity-item">  
                    <i class="${icon}" style="color: ${color};"></i>  
                    <div style="flex: 1;">  
                        <div>${text}</div>  
                        <div class="activity-time">${timeAgo(activity.time)}</div>  
                    </div>  
                </div>  
            `  
        }).join('')  
    } catch (err) {  
        console.error('Error loading activity:', err)  
        container.innerHTML = '<div class="empty-state"><p>Error loading activity</p></div>'  
    }  
}  

// Load users  
window.loadUsers = async function () {  
    const container = document.getElementById('usersContainer')  
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading users...</p></div>'  

    try {  
        const search = document.getElementById('userSearch').value.toLowerCase()  

        const {data: users, error} = await supabase  
            .from('profiles')  
            .select('*')  
            .order('created_at', {ascending: false})  

        if (error) throw error  

        allUsers = users || []  

        let filteredUsers = allUsers  
        if (search) {  
            filteredUsers = allUsers.filter(u =>  
                u.stage_name?.toLowerCase().includes(search) ||  
                u.email?.toLowerCase().includes(search) ||  
                u.user_type?.toLowerCase().includes(search)  
            )  
        }  

        if (!filteredUsers.length) {  
            container.innerHTML = '<div class="empty-state"><i class="ri-user-line"></i><p>No users found</p></div>'  
            return  
        }  

        const table = document.createElement('table')  
        table.className = 'data-table'  
        table.innerHTML = `  
                <thead>  
                    <tr>  
                        <th>User</th>  
                        <th>Email</th>  
                        <th>Type</th>  
                        <th>Joined</th>  
                        <th>Actions</th>  
                    </tr>  
                </thead>  
                <tbody></tbody>  
            `  

        const tbody = table.querySelector('tbody')  

        filteredUsers.forEach(user => {  
            const row = document.createElement('tr')  
            row.innerHTML = `  
                    <td>  
                        <div class="user-cell">  
                            <img src="${user.profile_picture || 'user.webp'}" class="user-avatar">  
                            <div>  
                                <strong>${user.stage_name || 'Unknown'}</strong>  
                            </div>  
                        </div>  
                    </td>  
                    <td>${user.email || 'N/A'}</td>  
                    <td><span class="badge badge-active">${user.user_type || 'User'}</span></td>  
                    <td>${new Date(user.created_at).toLocaleDateString()}</td>  
                    <td>  
                        <button class="action-btn btn-delete" onclick="deleteUser('${user.id}', '${user.stage_name}')">  
                            <i class="ri-delete-bin-line"></i> Delete  
                        </button>  
                    </td>  
                `  
            tbody.appendChild(row)  
        })  

        container.innerHTML = ''  
        container.appendChild(table)  
    } catch (err) {  
        console.error('Error loading users:', err)  
        container.innerHTML = '<div class="empty-state"><p>Error loading users</p></div>'  
    }  
}  

// Delete user  
window.deleteUser = async function (userId, stageName) {  
    if (!confirm(`Delete ${stageName}? This will delete all their posts and comments!`)) return  

    try {  
        await Promise.all([  
            supabase.from('posts').delete().eq('user_id', userId),  
            supabase.from('comments').delete().eq('user_id', userId),  
            supabase.from('post_likes').delete().eq('user_id', userId),  
            supabase.from('post_shares').delete().eq('user_id', userId),  
            supabase.from('post_bookmarks').delete().eq('user_id', userId),
            supabase.from('notifications').delete().eq('user_id', userId)
        ])  

        await supabase.from('profiles').delete().eq('id', userId)  

        showToast('User deleted successfully', '#ef4444')  
        loadUsers()  
        loadStats()  
    } catch (err) {  
        showToast('Error deleting user', '#ef4444')  
    }  
}  

// Load posts  
window.loadPosts = async function () {  
    const container = document.getElementById('postsContainer')  
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading posts...</p></div>'  

    try {  
        const search = document.getElementById('postSearch').value.toLowerCase()  

        const {data: posts, error} = await supabase  
            .from('posts')  
            .select('*, profiles(stage_name, profile_picture)')  
            .order('created_at', {ascending: false})  

        if (error) throw error  

        allPosts = posts || []  

        let filteredPosts = allPosts  
        if (search) {  
            filteredPosts = allPosts.filter(p =>  
                p.content?.toLowerCase().includes(search) ||  
                p.profiles?.stage_name?.toLowerCase().includes(search)  
            )  
        }  

        if (!filteredPosts.length) {  
            container.innerHTML = '<div class="empty-state"><i class="ri-article-line"></i><p>No posts found</p></div>'  
            return  
        }  

        const table = document.createElement('table')  
        table.className = 'data-table'  
        table.innerHTML = `  
                <thead>  
                    <tr>  
                        <th>Author</th>  
                        <th>Content</th>  
                        <th>Likes</th>  
                        <th>Comments</th>  
                        <th>Date</th>  
                        <th>Actions</th>  
                    </tr>  
                </thead>  
                <tbody></tbody>  
            `  

        const tbody = table.querySelector('tbody')  

        filteredPosts.forEach(post => {  
            const row = document.createElement('tr')  
            const contentPreview = post.content?.substring(0, 100) + (post.content?.length > 100 ? '...' : '')  

            row.innerHTML = `  
                    <td>  
                        <div class="user-cell">  
                            <img src="${post.profiles?.profile_picture || 'user.webp'}" class="user-avatar">  
                            <strong>${post.profiles?.stage_name || 'Unknown'}</strong>  
                        </div>  
                    </td>  
                    <td style="max-width: 300px;">${contentPreview}</td>  
                    <td><strong>${post.likes || 0}</strong></td>  
                    <td><strong>${post.comments || 0}</strong></td>  
                    <td>${new Date(post.created_at).toLocaleDateString()}</td>  
                    <td>  
                        <button class="action-btn btn-view" onclick="viewPost('${post.id}')">  
                            <i class="ri-eye-line"></i>  
                        </button>  
                        <button class="action-btn btn-view" onclick="commentOnPost('${post.id}')">  
                            <i class="ri-chat-3-line"></i> Comment  
                        </button>  
                        <button class="action-btn btn-delete" onclick="deletePost('${post.id}')">  
                            <i class="ri-delete-bin-line"></i>  
                        </button>  
                    </td>  
                `  
            tbody.appendChild(row)  
        })  

        container.innerHTML = ''  
        container.appendChild(table)  
    } catch (err) {  
        console.error('Error loading posts:', err)  
        container.innerHTML = '<div class="empty-state"><p>Error loading posts</p></div>'  
    }  
}  

// View post  
window.viewPost = function (postId) {  
    window.open(`post.html?post=${postId}`, '_blank')  
}  

// Delete post  
window.deletePost = async function (postId) {  
    if (!confirm('Delete this post? This will also delete all comments!')) return  

    try {  
        await Promise.all([  
            supabase.from('comments').delete().eq('post_id', postId),  
            supabase.from('post_likes').delete().eq('post_id', postId),  
            supabase.from('post_shares').delete().eq('post_id', postId),  
            supabase.from('post_bookmarks').delete().eq('post_id', postId)  
        ])  

        await supabase.from('posts').delete().eq('id', postId)  

        showToast('Post deleted successfully', '#ef4444')  
        loadPosts()  
        loadStats()  
    } catch (err) {  
        showToast('Error deleting post', '#ef4444')  
    }  
}  

// Load comments  
window.loadComments = async function () {  
    const container = document.getElementById('commentsContainer')  
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading comments...</p></div>'  

    try {  
        const search = document.getElementById('commentSearch').value.toLowerCase()  

        const {data: comments, error} = await supabase  
            .from('comments')  
            .select('*, profiles(stage_name, profile_picture), posts(content)')  
            .order('created_at', {ascending: false})  
            .limit(100)  

        if (error) throw error  

        allComments = comments || []  

        let filteredComments = allComments  
        if (search) {  
            filteredComments = allComments.filter(c =>  
                c.content?.toLowerCase().includes(search) ||  
                c.profiles?.stage_name?.toLowerCase().includes(search)  
            )  
        }  

        if (!filteredComments.length) {  
            container.innerHTML = '<div class="empty-state"><i class="ri-chat-3-line"></i><p>No comments found</p></div>'  
            return  
        }  

        const table = document.createElement('table')  
        table.className = 'data-table'  
        table.innerHTML = `  
                <thead>  
                    <tr>  
                        <th>Author</th>  
                        <th>Comment</th>  
                        <th>Post Preview</th>  
                        <th>Date</th>  
                        <th>Actions</th>  
                    </tr>  
                </thead>  
                <tbody></tbody>  
            `  

        const tbody = table.querySelector('tbody')  

        filteredComments.forEach(comment => {  
            const row = document.createElement('tr')  
            const commentPreview = comment.content?.substring(0, 80) + (comment.content?.length > 80 ? '...' : '')  
            const postPreview = comment.posts?.content?.substring(0, 40) + '...'  

            row.innerHTML = `  
                    <td>  
                        <div class="user-cell">  
                            <img src="${comment.profiles?.profile_picture || 'user.webp'}" class="user-avatar">  
                            <strong>${comment.profiles?.stage_name || 'Unknown'}</strong>  
                        </div>  
                    </td>  
                    <td style="max-width: 300px;">${commentPreview}</td>  
                    <td style="max-width: 200px; color: #666; font-size: 13px;">${postPreview}</td>  
                    <td>${new Date(comment.created_at).toLocaleDateString()}</td>  
                    <td>  
                        <button class="action-btn btn-view" onclick="viewPost('${comment.post_id}')">  
                            <i class="ri-eye-line"></i>  
                        </button>  
                        <button class="action-btn btn-delete" onclick="deleteComment('${comment.id}', '${comment.post_id}')">  
                            <i class="ri-delete-bin-line"></i>  
                        </button>  
                    </td>  
                `  
            tbody.appendChild(row)  
        })  

        container.innerHTML = ''  
        container.appendChild(table)  
    } catch (err) {  
        console.error('Error loading comments:', err)  
        container.innerHTML = '<div class="empty-state"><p>Error loading comments</p></div>'  
    }  
}  

// Delete comment  
window.deleteComment = async function (commentId, postId) {  
    if (!confirm('Delete this comment?')) return  

    try {  
        await supabase.from('comments').delete().eq('id', commentId)  

        const {data: post} = await supabase  
            .from('posts')  
            .select('comments')  
            .eq('id', postId)  
            .single()  

        await supabase  
            .from('posts')  
            .update({comments: Math.max(0, (post.comments || 0) - 1)})  
            .eq('id', postId)  

        showToast('Comment deleted successfully', '#ef4444')  
        loadComments()  
        loadStats()  
    } catch (err) {  
        showToast('Error deleting comment', '#ef4444')  
    }  
}  

// Comment on post as admin  
window.commentOnPost = async function (postId) {  
    if (!currentAdminProfile) {  
        showToast('Admin profile not loaded', '#ef4444')  
        return  
    }  

    currentPostId = postId  
    document.getElementById('adminCommentModal').classList.add('active')  

    // Load existing comments  
    await loadPostComments(postId)  
}  

window.closeCommentModal = function () {  
    document.getElementById('adminCommentModal').classList.remove('active')  
    document.getElementById('adminCommentText').value = ''  
    currentPostId = null  
}  

// Load post comments  
async function loadPostComments(postId) {  
    const container = document.getElementById('postCommentsContainer')  
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading comments...</p></div>'  

    try {  
        const {data: comments, error} = await supabase  
            .from('comments')  
            .select('*, profiles(id, stage_name, profile_picture, user_type, is_admin)')  
            .eq('post_id', postId)  
            .order('created_at', {ascending: false})  

        if (error) throw error  

        if (!comments || comments.length === 0) {  
            container.innerHTML = '<div class="empty-state"><p style="font-size: 14px;">No comments yet. Be the first!</p></div>'  
            return  
        }  

        container.innerHTML = comments.map(comment => {  
            const profile = comment.profiles || {}  
            const isAdmin = profile.user_type === 'Admin' || profile.is_admin === true  

            return `  
                    <div class="comment-item">  
                        <img src="${profile.profile_picture || 'user.webp'}" class="user-avatar">  
                        <div class="comment-content-wrapper">  
                            <div class="comment-header">  
                                <strong>${profile.stage_name || 'Unknown'}</strong>  
                                ${isAdmin ? '<span class="admin-badge">ADMIN</span>' : ''}  
                            </div>  
                            <div class="comment-text">${comment.content}</div>  
                            <div class="comment-meta">${timeAgo(comment.created_at)}</div>  
                        </div>  
                    `  
        }).join('')  
    } catch (err) {  
        console.error('Error loading comments:', err)  
        container.innerHTML = '<div class="empty-state"><p style="color: #ef4444;">Error loading comments</p></div>'  
    }  
}  

// Handle admin comment submission  
document.getElementById('adminCommentForm').addEventListener('submit', async (e) => {  
    e.preventDefault()  

    const content = document.getElementById('adminCommentText').value.trim()  
    const submitBtn = document.getElementById('postCommentBtn')  

    if (!content || !currentPostId) {  
        showToast('Please write a comment', '#ef4444')  
        return  
    }  

    if (!currentAdminProfile || !currentAdminProfile.id) {  
        showToast('Admin profile not loaded. Please refresh the page.', '#ef4444')  
        return  
    }  

    submitBtn.disabled = true  
    submitBtn.textContent = 'Posting...'  

    try {  
        // Insert comment  
        const {error: commentError} = await supabase  
            .from('comments')  
            .insert([{  
                post_id: currentPostId,  
                user_id: currentAdminProfile.id,  
                content: content  
            }])  

        if (commentError) throw commentError  

        // Update post comment count  
        const {data: post, error: postError} = await supabase  
            .from('posts')  
            .select('comments, user_id')  
            .eq('id', currentPostId)  
            .single()  

        if (postError) throw postError  

        await supabase  
            .from('posts')  
            .update({comments: (post.comments || 0) + 1})  
            .eq('id', currentPostId)  

        // Create notification for post owner (only if not commenting on own post)  
        if (post.user_id !== currentAdminProfile.id) {  
            try {  
                await supabase  
                    .from('notifications')  
                    .insert([{  
                        user_id: post.user_id,  
                        type: 'comment',  
                        post_id: currentPostId,  
                        actor_id: currentAdminProfile.id,  
                        content: content,  
                        read: false  
                    }])  
            } catch (notifError) {  
                console.log('Notification creation failed (may not be critical):', notifError)  
            }  
        }  

        showToast('Admin comment posted successfully!', '#10b981')  
        document.getElementById('adminCommentText').value = ''  
        await loadPostComments(currentPostId)  

        // Refresh posts if on posts tab  
        if (document.getElementById('posts-tab').classList.contains('active')) {  
            loadPosts()  
        }  
    } catch (err) {  
        console.error('Error posting comment:', err)  
        showToast('Error posting comment: ' + err.message, '#ef4444')  
    } finally {  
        submitBtn.disabled = false  
        submitBtn.innerHTML = '<i class="ri-send-plane-fill"></i> Post Comment'  
    }  
})  

// Broadcast modal  
window.openBroadcastModal = async function () {  
    if (!currentAdminProfile) {  
        showToast('Admin profile not loaded', '#ef4444')  
        return;  
    }  

    document.getElementById('broadcastModal').classList.add('active');  
    await loadUserCheckboxes();  
};  

window.closeBroadcastModal = function () {  
    document.getElementById('broadcastModal').classList.remove('active');  
    document.getElementById('broadcastContent').value = '';  
};  

// Load User Checkboxes  
async function loadUserCheckboxes() {  
    const container = document.getElementById('userCheckboxes');  
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading users...</p></div>';  

    try {  
        if (!currentAdminProfile || !currentAdminProfile.id) {
            container.innerHTML = '<div class="empty-state"><p>Admin profile not loaded</p></div>';
            return;
        }

        const {data: users, error} = await supabase  
            .from('profiles')  
            .select('id, stage_name, profile_picture')  
            .neq('id', currentAdminProfile.id)  // EXCLUDE ADMIN FROM LIST
            .order('stage_name', {ascending: true});  

        if (error) {  
            console.error('Error loading users:', error);  
            container.innerHTML = '<div class="empty-state"><p>Error loading users</p></div>';  
            return;  
        }  

        if (!users || users.length === 0) {  
            container.innerHTML = '<div class="empty-state"><p>No other users found</p></div>';  
            return;  
        }  

        // Add Select All checkbox at the top
        let html = `
            <label class="checkbox-item" style="border-bottom: 2px solid #667eea; padding-bottom: 12px; margin-bottom: 12px;">
                <input type="checkbox" id="selectAllUsers" onchange="toggleAllUsers(this)">
                <img src="user.webp" class="user-avatar" style="width: 32px; height: 32px; border-radius: 50%; margin: 0 10px;">
                <strong style="color: #667eea;">Select All Users (${users.length})</strong>
            </label>
        `;

        html += users.map(user => `  
            <label class="checkbox-item" style="display: flex; align-items: center; padding: 10px; margin: 5px 0; border-radius: 8px; transition: background 0.2s;">  
                <input type="checkbox" class="user-checkbox" value="${user.id}" style="margin-right: 10px;">
                <img src="${user.profile_picture || 'user.webp'}" class="user-avatar" style="width: 32px; height: 32px; border-radius: 50%; margin-right: 10px; object-fit: cover;">
                <span>${user.stage_name || 'Unknown User'}</span>
            </label>  
        `).join('');  

        container.innerHTML = html;
    } catch (err) {  
        console.error('Error loading user checkboxes:', err);  
        container.innerHTML = '<div class="empty-state"><p>Error loading users</p></div>';  
    }  
}

// Toggle all users selection
window.toggleAllUsers = function(checkbox) {
    const allCheckboxes = document.querySelectorAll('.user-checkbox');
    allCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
}  

document.getElementById('broadcastForm').addEventListener('submit', async (e) => {  
    e.preventDefault();  

    const content = document.getElementById('broadcastContent').value.trim();  
    const submitBtn = document.getElementById('postBroadcastBtn');  
    const selectedUsers = Array.from(document.querySelectorAll('#broadcastModal .user-checkbox:checked'))  
        .map(checkbox => checkbox.value);  

    if (!content) {  
        showToast('Please write an announcement', '#ef4444');  
        return;  
    }  

    if (selectedUsers.length === 0) {  
        showToast('Please select at least one user', '#ef4444');  
        return;  
    }  

    if (!currentAdminProfile || !currentAdminProfile.id) {  
        showToast('Admin profile not loaded. Please refresh the page.', '#ef4444');  
        return;  
    }  

    // Check authentication
    const {data: {session}} = await supabase.auth.getSession();
    if (!session) {
        showToast('Session expired. Please login again.', '#ef4444');
        window.location.href = 'index.html';
        return;
    }

    console.log('Session user ID:', session.user.id);
    console.log('Admin profile ID:', currentAdminProfile.id);
    console.log('Selected User IDs:', selectedUsers);

    submitBtn.disabled = true;  
    submitBtn.textContent = 'Posting...';  

    try {  
        // Try inserting notifications one by one
        let successCount = 0;
        let failedUsers = [];

        for (const userId of selectedUsers) {
            const notification = {
                user_id: userId,  
                type: 'mention',
                actor_id: currentAdminProfile.id,  
                content: `ðŸ“¢ Admin Announcement\n\n${content}`,  
                read: false  
            };

            console.log('Attempting to insert for user:', userId, notification);

            const {data, error} = await supabase  
                .from('notifications')  
                .insert([notification])
                .select();  

            if (error) {
                console.error('âŒ Error for user', userId, ':', error);
                console.error('Error code:', error.code);
                console.error('Error message:', error.message);
                console.error('Error details:', error.details);
                failedUsers.push(userId);
            } else {
                console.log('âœ… Success for user', userId, ':', data);
                successCount++;
            }
        }

        if (successCount > 0) {
            showToast(`Announcement sent to ${successCount} user(s) successfully!`, '#10b981');
        }

        if (failedUsers.length > 0) {
            showToast(`Failed to send to ${failedUsers.length} user(s). RLS Policy issue - check Supabase settings.`, '#ef4444');
            console.error('Failed user IDs:', failedUsers);
            console.error('Please run: ALTER TABLE notifications DISABLE ROW LEVEL SECURITY;');
        }

        if (successCount > 0) {
            closeBroadcastModal();  
            loadStats();  
            loadActivityLog();

            if (document.getElementById('announcements-tab')?.classList.contains('active')) {
                loadAnnouncements();
            }
        }
    } catch (err) {  
        console.error('ðŸ’¥ Error sending announcement:', err);
        console.error('Error details:', JSON.stringify(err, null, 2));
        showToast('Database permission error. Contact developer to fix RLS policies.', '#ef4444');
    } finally {  
        submitBtn.disabled = false;  
        submitBtn.innerHTML = '<i class="ri-megaphone-line"></i> Post Announcement';  
    }  
});  

// Load ALL notifications (from all users)
window.loadAllNotifications = async function() {  
    const container = document.getElementById('notificationsContainer')  
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading notifications...</p></div>'  

    try {  
        const search = document.getElementById('notificationSearch')?.value.toLowerCase() || ''

        const {data: notifications, error} = await supabase  
            .from('notifications')  
            .select(`  
                *,  
                user:profiles!notifications_user_id_fkey(stage_name, profile_picture),  
                actor:profiles!notifications_actor_id_fkey(stage_name, profile_picture)  
            `)  
            .order('created_at', {ascending: false})  
            .limit(200)  

        if (error) {  
            console.error('Notifications query error:', error)  
            throw error  
        }  

        allNotifications = notifications || []

        let filteredNotifications = allNotifications
        if (search) {
            filteredNotifications = allNotifications.filter(n =>
                n.content?.toLowerCase().includes(search) ||
                n.user?.stage_name?.toLowerCase().includes(search) ||
                n.actor?.stage_name?.toLowerCase().includes(search) ||
                n.type?.toLowerCase().includes(search)
            )
        }

        if (!filteredNotifications.length) {  
            container.innerHTML = '<div class="empty-state"><i class="ri-notification-3-line"></i><p>No notifications found</p></div>'  
            return  
        }  

        const table = document.createElement('table')
        table.className = 'data-table'
        table.innerHTML = `
            <thead>
                <tr>
                    <th style="width: 50px;">
                        <input type="checkbox" id="selectAllNotifications" onchange="toggleAllNotifications(this)" style="cursor: pointer;">
                    </th>
                    <th>Type</th>
                    <th>Recipient</th>
                    <th>From</th>
                    <th>Content</th>
                    <th>Status</th>
                    <th>Date</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody></tbody>
        `

        const tbody = table.querySelector('tbody')

        filteredNotifications.forEach(notif => {
            const user = notif.user || {}
            const actor = notif.actor || {}
            const typeIcon = {  
                'like': 'ri-thumb-up-fill',  
                'comment': 'ri-chat-3-fill',  
                'share': 'ri-share-fill',
                'mention': 'ri-megaphone-fill'
            }[notif.type] || 'ri-notification-3-line'  

            const contentPreview = notif.content?.substring(0, 60) + (notif.content?.length > 60 ? '...' : '')

            const row = document.createElement('tr')
            row.innerHTML = `
                <td>
                    <input type="checkbox" class="notification-checkbox" value="${notif.id}" style="cursor: pointer;">
                </td>
                <td>
                    <i class="${typeIcon}" style="color: #667eea; margin-right: 5px;"></i>
                    <span class="badge badge-active">${notif.type}</span>
                </td>
                <td>
                    <div class="user-cell">
                        <img src="${user.profile_picture || 'user.webp'}" class="user-avatar">
                        <strong>${user.stage_name || 'Unknown'}</strong>
                    </div>
                </td>
                <td>
                    <div class="user-cell">
                        <img src="${actor.profile_picture || 'user.webp'}" class="user-avatar">
                        <strong>${actor.stage_name || 'System'}</strong>
                    </div>
                </td>
                <td style="max-width: 300px;">${contentPreview}</td>
                <td>
                    <span class="badge ${notif.read ? 'badge-inactive' : 'badge-active'}">
                        ${notif.read ? 'Read' : 'Unread'}
                    </span>
                </td>
                <td>${new Date(notif.created_at).toLocaleDateString()}</td>
                <td>
                    <button class="action-btn btn-view" onclick="viewNotification('${notif.id}')">
                        <i class="ri-eye-line"></i>
                    </button>
                    <button class="action-btn btn-delete" onclick="deleteNotification('${notif.id}')">
                        <i class="ri-delete-bin-line"></i>
                    </button>
                </td>
            `
            tbody.appendChild(row)
        })

        // Add bulk delete button at the bottom
        const bulkActionsRow = document.createElement('tr')
        bulkActionsRow.innerHTML = `
            <td colspan="8" style="text-align: center; padding: 15px; background: #f5f5f5;">
                <button class="action-btn btn-delete" onclick="deleteSelectedNotifications()" style="padding: 10px 20px;">
                    <i class="ri-delete-bin-line"></i> Delete Selected
                </button>
            </td>
        `
        tbody.appendChild(bulkActionsRow)

        container.innerHTML = ''
        container.appendChild(table)
    } catch (err) {  
        console.error('Error loading notifications:', err)  
        container.innerHTML = `  
            <div class="empty-state">  
                <p style="color: #ef4444;">Error loading notifications</p>  
                <small style="color: #666;">${err.message}</small>  
            </div>  
        `  
    }  
}

// Toggle all notifications selection
window.toggleAllNotifications = function(checkbox) {
    const allCheckboxes = document.querySelectorAll('.notification-checkbox');
    allCheckboxes.forEach(cb => {
        cb.checked = checkbox.checked;
    });
}

// Delete selected notifications
window.deleteSelectedNotifications = async function() {
    const selectedCheckboxes = document.querySelectorAll('.notification-checkbox:checked');
    const selectedIds = Array.from(selectedCheckboxes).map(cb => cb.value);

    if (selectedIds.length === 0) {
        showToast('Please select notifications to delete', '#f59e0b');
        return;
    }

    if (!confirm(`Delete ${selectedIds.length} selected notification(s)?`)) return;

    try {
        const {error} = await supabase
            .from('notifications')
            .delete()
            .in('id', selectedIds);

        if (error) throw error;

        showToast(`${selectedIds.length} notification(s) deleted successfully`, '#10b981');
        loadAllNotifications();
    } catch (err) {
        console.error('Error deleting notifications:', err);
        showToast('Error deleting notifications', '#ef4444');
    }
}

// View notification details
window.viewNotification = async function(notificationId) {
    try {
        const {data: notification, error} = await supabase
            .from('notifications')
            .select(`
                *,
                user:profiles!notifications_user_id_fkey(stage_name),
                actor:profiles!notifications_actor_id_fkey(stage_name)
            `)
            .eq('id', notificationId)
            .single()

        if (error) throw error

        const modal = document.getElementById('notificationDetailModal')
        if (!modal) {
            // If modal doesn't exist, show in alert instead
            const user = notification.user || {}
            const actor = notification.actor || {}
            alert(`${notification.type.toUpperCase()} Notification\n\nTo: ${user.stage_name || 'Unknown'}\nFrom: ${actor.stage_name || 'System'}\nDate: ${new Date(notification.created_at).toLocaleString()}\nStatus: ${notification.read ? 'Read' : 'Unread'}\n\n${notification.content || 'No content'}`);
            return;
        }

        const title = document.getElementById('notificationDetailTitle')
        const content = document.getElementById('notificationDetailContent')

        if (!title || !content) {
            console.error('Modal elements not found');
            alert('Error: Modal elements missing. Notification: ' + notification.content);
            return;
        }

        const user = notification.user || {}
        const actor = notification.actor || {}

        title.textContent = `${notification.type.toUpperCase()} Notification`
        content.innerHTML = `
            <div style="margin-bottom: 15px;">
                <strong>To:</strong> ${user.stage_name || 'Unknown'}<br>
                <strong>From:</strong> ${actor.stage_name || 'System'}<br>
                <strong>Date:</strong> ${new Date(notification.created_at).toLocaleString()}<br>
                <strong>Status:</strong> ${notification.read ? 'Read' : 'Unread'}
            </div>
            <div style="padding: 15px; background: #f5f5f5; border-radius: 8px;">
                ${notification.content || 'No content'}
            </div>
        `

        modal.classList.add('active')
    } catch (err) {
        console.error('Error loading notification:', err)
        showToast('Error loading notification details', '#ef4444')
    }
}

window.closeNotificationDetailModal = function() {
    const modal = document.getElementById('notificationDetailModal')
    if (modal) {
        modal.classList.remove('active')
    }
}

// Delete notification
window.deleteNotification = async function(notificationId) {
    if (!confirm('Delete this notification?')) return

    try {
        const {error} = await supabase
            .from('notifications')
            .delete()
            .eq('id', notificationId)

        if (error) throw error

        showToast('Notification deleted successfully', '#ef4444')
        loadAllNotifications()
    } catch (err) {
        console.error('Error deleting notification:', err)
        showToast('Error deleting notification', '#ef4444')
    }
}

// Load announcements (made by admin - excluding self-sent)
window.loadAnnouncements = async function() {  
    const container = document.getElementById('announcementsContainer');  
    container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading announcements...</p></div>';  

    try {  
        const search = document.getElementById('announcementSearch')?.value.toLowerCase() || ''

        // Get announcements where admin sent to others (not to themselves)
        const {data: announcements, error} = await supabase  
            .from('notifications')  
            .select('id, content, created_at, actor_id, user_id')  
            .eq('type', 'mention')
            .eq('actor_id', currentAdminProfile.id)
            .neq('user_id', currentAdminProfile.id) // Exclude notifications sent to self
            .order('created_at', {ascending: false});  

        if (error) {  
            console.error('Error loading announcements:', error);  
            container.innerHTML = '<div class="empty-state"><p>Error loading announcements</p></div>';  
            return;  
        }  

        // Group announcements by content and created_at to avoid duplicates
        const uniqueAnnouncements = [];
        const seen = new Set();

        for (const announcement of (announcements || [])) {
            const key = `${announcement.content}-${announcement.created_at}`;
            if (!seen.has(key)) {
                seen.add(key);
                uniqueAnnouncements.push(announcement);
            }
        }

        let filteredAnnouncements = uniqueAnnouncements;
        if (search) {
            filteredAnnouncements = uniqueAnnouncements.filter(a =>
                a.content?.toLowerCase().includes(search)
            )
        }

        if (!filteredAnnouncements.length) {  
            container.innerHTML = '<div class="empty-state"><i class="ri-megaphone-line"></i><p>No announcements found</p></div>';  
            return;  
        }  

        const table = document.createElement('table');  
        table.className = 'data-table';  
        table.innerHTML = `  
            <thead>  
                <tr>  
                    <th>Content</th>  
                    <th>Date</th>  
                    <th>Recipients</th>
                    <th>Actions</th>  
                </tr>  
            </thead>  
            <tbody></tbody>  
        `;  

        const tbody = table.querySelector('tbody');  

        for (const announcement of filteredAnnouncements) {
            const row = document.createElement('tr');  
            const contentPreview = announcement.content?.substring(0, 100) + (announcement.content?.length > 100 ? '...' : '');  

            // Count recipients (excluding self)
            const {count} = await supabase
                .from('notifications')
                .select('*', {count: 'exact', head: true})
                .eq('content', announcement.content)
                .eq('created_at', announcement.created_at)
                .eq('actor_id', currentAdminProfile.id)
                .neq('user_id', currentAdminProfile.id)

            row.innerHTML = `  
                <td style="max-width: 400px;">${contentPreview}</td>  
                <td>${new Date(announcement.created_at).toLocaleDateString()}</td>
                <td><span class="badge badge-active">${count || 0} users</span></td>  
                <td>  
                    <button class="action-btn btn-view" onclick="viewAnnouncement('${announcement.id}')">  
                        <i class="ri-eye-line"></i> View  
                    </button>  
                    <button class="action-btn btn-delete" onclick="deleteAnnouncement('${announcement.id}', \`${announcement.content.replace(/`/g, '\\`')}\`, '${announcement.created_at}')">  
                        <i class="ri-delete-bin-line"></i> Delete  
                    </button>  
                </td>  
            `;  
            tbody.appendChild(row);  
        }

        container.innerHTML = '';  
        container.appendChild(table);  
    } catch (err) {  
        console.error('Error loading announcements:', err);  
        container.innerHTML = '<div class="empty-state"><p>Error loading announcements</p></div>';  
    }  
};  

// View announcement
window.viewAnnouncement = async function(announcementId) {  
    try {  
        const {data: announcement, error} = await supabase  
            .from('notifications')  
            .select('content, created_at')  
            .eq('id', announcementId)  
            .single();  

        if (error) {  
            console.error('Error loading announcement:', error);  
            showToast('Error loading announcement', '#ef4444');  
            return;  
        }  

        const modal = document.getElementById('announcementModal');
        if (!modal) {
            // If modal doesn't exist, show in alert
            alert(`Announcement\n\nSent: ${new Date(announcement.created_at).toLocaleString()}\n\n${announcement.content}`);
            return;
        }

        const title = document.getElementById('announcementModalTitle');  
        const content = document.getElementById('announcementModalContent');

        if (!title || !content) {
            alert(`Announcement\n\n${announcement.content}`);
            return;
        }

        // Get recipient count (excluding self)
        const {count} = await supabase
            .from('notifications')
            .select('*', {count: 'exact', head: true})
            .eq('content', announcement.content)
            .eq('created_at', announcement.created_at)
            .eq('actor_id', currentAdminProfile.id)
            .neq('user_id', currentAdminProfile.id)

        title.textContent = 'Announcement Details';  
        content.innerHTML = `
            <div style="margin-bottom: 15px; color: #666;">
                <strong>Sent:</strong> ${new Date(announcement.created_at).toLocaleString()}<br>
                <strong>Recipients:</strong> ${count || 0} users
            </div>
            <div style="padding: 15px; background: #f5f5f5; border-radius: 8px; line-height: 1.6;">
                ${announcement.content}
            </div>
        `;  
        modal.classList.add('active');  
    } catch (err) {  
        console.error('Error loading announcement:', err);  
        showToast('Error loading announcement', '#ef4444');  
    }  
};  

window.closeAnnouncementModal = function() {  
    const modal = document.getElementById('announcementModal');
    if (modal) {
        modal.classList.remove('active');
    }
};  

// Delete announcement (all copies to all users, excluding self)
window.deleteAnnouncement = async function(announcementId, content, createdAt) {  
    if (!confirm('Delete this announcement? This will remove it for all recipients!')) return;  

    try {  
        // Delete all notifications with same content and timestamp sent by admin (excluding self-sent)
        const {error} = await supabase  
            .from('notifications')  
            .delete()  
            .eq('content', content)
            .eq('created_at', createdAt)
            .eq('actor_id', currentAdminProfile.id)
            .neq('user_id', currentAdminProfile.id)

        if (error) {  
            console.error('Error deleting announcement:', error);  
            showToast('Error deleting announcement', '#ef4444');  
            return;  
        }  

        showToast('Announcement deleted successfully', '#10b981');  
        loadAnnouncements();
    } catch (err) {  
        console.error('Error deleting announcement:', err);  
        showToast('Error deleting announcement', '#ef4444');  
    }  
};

// View all notifications modal
window.viewAllNotifications = function () {  
    document.getElementById('notificationsModal').classList.add('active')  
    loadAllNotifications()  
}  

window.closeNotificationsModal = function () {  
    document.getElementById('notificationsModal').classList.remove('active')  
}

// Tab switching  
window.switchTab = function (tab) {  
    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'))  
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'))  

    event.target.closest('.tab').classList.add('active')  
    document.getElementById(`${tab}-tab`).classList.add('active')  

    if (tab === 'dashboard') {  
        loadActivityLog()  
    } else if (tab === 'users') {  
        loadUsers()  
    } else if (tab === 'posts') {  
        loadPosts()  
    } else if (tab === 'comments') {  
        loadComments()  
    } else if (tab === 'announcements') {  
        loadAnnouncements();  
    } else if (tab === 'notifications') {
        loadAllNotifications();
    }
}  

// Toast notifications  
window.showToast = function (message, color = '#10b981') {  
    const toast = document.createElement('div')  
    toast.className = 'toast'  
    toast.style.borderLeft = `4px solid ${color}`  

    let icon = 'ri-check-line'  
    if (color === '#ef4444') icon = 'ri-error-warning-line'  
    else if (color === '#f59e0b') icon = 'ri-alert-line'  
    else if (color === '#3b82f6') icon = 'ri-information-line'  

    toast.innerHTML = `  
        <i class="${icon}" style="color: ${color}; font-size: 20px;"></i>  
        <span>${message}</span>  
    `  
    document.body.appendChild(toast)  

    setTimeout(() => {  
        toast.style.animation = 'slideIn 0.3s ease reverse'  
        setTimeout(() => toast.remove(), 300)  
    }, 3000)  
}  

// Logout  
window.handleLogout = async function () {  
    if (confirm('Are you sure you want to logout?')) {  
        await supabase.auth.signOut()  
        window.location.href = 'index.html'  
    }  
}  

// Time ago helper  
function timeAgo(date) {  
    const seconds = Math.floor((new Date() - new Date(date)) / 1000)  

    let interval = seconds / 31536000  
    if (interval > 1) return Math.floor(interval) + " years ago"  

    interval = seconds / 2592000  
    if (interval > 1) return Math.floor(interval) + " months ago"  

    interval = seconds / 86400  
    if (interval > 1) return Math.floor(interval) + " days ago"  

    interval = seconds / 3600  
    if (interval > 1) return Math.floor(interval) + " hours ago"  

    interval = seconds / 60  
    if (interval > 1) return Math.floor(interval) + " minutes ago"  

    return Math.floor(seconds) + " seconds ago"  
}

// Initialize  
async function init() {
    // Show loading overlay
    showLoadingOverlay()

    const isAdmin = await checkAdmin()  
    if (!isAdmin) {
        hideLoadingOverlay()
        return
    }

    await loadStats()  
    await loadActivityLog()  

    // Hide loading overlay once everything is loaded
    hideLoadingOverlay()

    // Set up search listeners with debounce  
    const debounce = (func, wait) => {  
        let timeout  
        return function executedFunction(...args) {  
            const later = () => {  
                clearTimeout(timeout)  
                func(...args)  
            }  
            clearTimeout(timeout)  
            timeout = setTimeout(later, wait)  
        }  
    }  

    document.getElementById('userSearch')?.addEventListener('input', debounce(() => loadUsers(), 500))  
    document.getElementById('postSearch')?.addEventListener('input', debounce(() => loadPosts(), 500))  
    document.getElementById('commentSearch')?.addEventListener('input', debounce(() => loadComments(), 500))
    document.getElementById('notificationSearch')?.addEventListener('input', debounce(() => loadAllNotifications(), 500))
    document.getElementById('announcementSearch')?.addEventListener('input', debounce(() => loadAnnouncements(), 500))

    // Real-time updates  
    supabase.channel('admin-updates')  
        .on('postgres_changes', {event: '*', schema: 'public', table: 'profiles'}, () => {  
            loadStats()  
            if (document.getElementById('users-tab').classList.contains('active')) {  
                loadUsers()  
            }  
        })  
        .on('postgres_changes', {event: '*', schema: 'public', table: 'posts'}, () => {  
            loadStats()  
            if (document.getElementById('posts-tab').classList.contains('active')) {  
                loadPosts()  
            }  
        })  
        .on('postgres_changes', {event: '*', schema: 'public', table: 'comments'}, () => {  
            loadStats()  
            if (document.getElementById('comments-tab').classList.contains('active')) {  
                loadComments()  
            }  
        })
        .on('postgres_changes', {event: '*', schema: 'public', table: 'notifications'}, () => {  
            if (document.getElementById('notifications-tab')?.classList.contains('active')) {  
                loadAllNotifications()  
            }
            if (document.getElementById('announcements-tab')?.classList.contains('active')) {  
                loadAnnouncements()  
            }
        })
        .subscribe()  

    // Refresh stats every 30 seconds  
    setInterval(loadStats, 30000)  

    showToast('Welcome to Admin Dashboard!', '#667eea')  
}  

// Initialize the dashboard  
init()  
</script> 

</body>
</html>

