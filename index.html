<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <title>Keli Admin</title>
    <link href="https://cdn.jsdelivr.net/npm/remixicon@3.5.0/fonts/remixicon.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
:root {
    --bg:        #f5f6fa;
    --bg2:       #eef0f6;
    --white:     #ffffff;
    --border:    #e3e6ef;
    --border2:   #d0d5e8;
    --text:      #141928;
    --text2:     #4a5074;
    --text3:     #8b93b8;
    --indigo:    #4f46e5;
    --indigo-l:  #ede9fe;
    --indigo-m:  #c4b5fd;
    --violet:    #7c3aed;
    --emerald:   #059669;
    --emerald-l: #d1fae5;
    --amber:     #d97706;
    --amber-l:   #fef3c7;
    --rose:      #e11d48;
    --rose-l:    #ffe4e6;
    --grad:      linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
    --shadow-xs: 0 1px 3px rgba(20,25,40,0.06);
    --shadow-sm: 0 2px 8px rgba(20,25,40,0.08);
    --shadow-md: 0 4px 16px rgba(20,25,40,0.10);
    --shadow-lg: 0 8px 32px rgba(20,25,40,0.14);
    --r-sm:  8px;
    --r:     12px;
    --r-lg:  16px;
    --r-xl:  20px;
    --header-h: 56px;
    --tab-h:    48px;
}
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;}
html{scroll-behavior:smooth;}
body{font-family:'Plus Jakarta Sans',sans-serif;background:var(--bg);color:var(--text);line-height:1.55;-webkit-font-smoothing:antialiased;overflow-x:hidden;min-height:100vh;}

/* â”€â”€â”€ LOADING â”€â”€â”€ */
#loadingOverlay{position:fixed;inset:0;background:white;display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:18px;}
.load-logo{font-size:28px;font-weight:800;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-0.04em;}
.load-ring{width:40px;height:40px;border:3px solid var(--border);border-top-color:var(--indigo);border-radius:50%;animation:spin 0.75s linear infinite;}
.load-msg{font-size:13px;color:var(--text3);font-weight:500;}
@keyframes spin{to{transform:rotate(360deg);}}

/* â”€â”€â”€ HEADER â”€â”€â”€ */
.header{height:var(--header-h);position:sticky;top:0;z-index:300;background:var(--white);border-bottom:1px solid var(--border);box-shadow:var(--shadow-xs);display:flex;align-items:center;padding:0 16px;gap:10px;}
.header-logo{font-size:20px;font-weight:800;background:var(--grad);-webkit-background-clip:text;-webkit-text-fill-color:transparent;background-clip:text;letter-spacing:-0.04em;flex-shrink:0;}
.header-chip{background:var(--indigo-l);color:var(--indigo);font-size:10px;font-weight:700;letter-spacing:0.07em;text-transform:uppercase;padding:3px 8px;border-radius:999px;flex-shrink:0;}
.header-spacer{flex:1;}
#adminName{font-size:12px;color:var(--text3);font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:110px;}
.logout-btn{background:none;border:1px solid var(--border2);color:var(--text2);padding:7px 13px;border-radius:999px;cursor:pointer;font-size:13px;font-family:inherit;font-weight:600;display:flex;align-items:center;gap:6px;flex-shrink:0;transition:all 0.2s;white-space:nowrap;}
.logout-btn:hover{border-color:var(--rose);color:var(--rose);background:var(--rose-l);}

/* â”€â”€â”€ STATS â”€â”€â”€ */
.stats-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:14px 14px 0;}
@media(min-width:600px){.stats-grid{grid-template-columns:repeat(4,1fr);}}
.stat-card{background:var(--white);border:1px solid var(--border);border-radius:var(--r-lg);padding:14px;box-shadow:var(--shadow-xs);position:relative;overflow:hidden;transition:box-shadow 0.2s,transform 0.15s;}
.stat-card:hover{box-shadow:var(--shadow-md);transform:translateY(-1px);}
.stat-card::after{content:'';position:absolute;bottom:0;left:0;right:0;height:3px;}
.s-indigo::after{background:var(--indigo);}.s-emerald::after{background:var(--emerald);}.s-amber::after{background:var(--amber);}.s-rose::after{background:var(--rose);}
.stat-icon{width:34px;height:34px;border-radius:9px;display:flex;align-items:center;justify-content:center;font-size:17px;margin-bottom:10px;}
.s-indigo .stat-icon{background:var(--indigo-l);color:var(--indigo);}
.s-emerald .stat-icon{background:var(--emerald-l);color:var(--emerald);}
.s-amber .stat-icon{background:var(--amber-l);color:var(--amber);}
.s-rose .stat-icon{background:var(--rose-l);color:var(--rose);}
.stat-label{font-size:10px;color:var(--text3);font-weight:700;text-transform:uppercase;letter-spacing:0.07em;margin-bottom:2px;}
.stat-value{font-size:26px;font-weight:800;letter-spacing:-0.04em;color:var(--text);line-height:1.1;}
.stat-sub{font-size:11px;color:var(--text3);margin-top:2px;font-weight:500;}

/* â”€â”€â”€ QUICK ACTIONS â”€â”€â”€ */
.quick-actions{display:grid;grid-template-columns:repeat(auto-fill,minmax(150px,1fr));gap:10px;padding:12px 14px;}
.qaction{background:var(--white);border:1px solid var(--border);border-radius:var(--r-lg);padding:13px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:all 0.2s;}
.qaction:hover{border-color:var(--indigo-m);box-shadow:var(--shadow-sm);transform:translateY(-1px);}
.qaction i{font-size:18px;color:var(--indigo);background:var(--indigo-l);padding:8px;border-radius:9px;flex-shrink:0;}
.qa-title{font-size:13px;font-weight:700;color:var(--text);line-height:1.2;}
.qa-sub{font-size:11px;color:var(--text3);margin-top:1px;}

/* â”€â”€â”€ TABS â”€â”€â”€ */
.tabs-wrap{background:var(--white);border-bottom:1px solid var(--border);box-shadow:var(--shadow-xs);position:sticky;top:var(--header-h);z-index:200;}
.tabs{display:flex;overflow-x:auto;scrollbar-width:none;-ms-overflow-style:none;padding:0 10px;}
.tabs::-webkit-scrollbar{display:none;}
.tab{height:var(--tab-h);padding:0 14px;background:none;border:none;border-bottom:3px solid transparent;color:var(--text3);font-size:13px;font-weight:700;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;gap:7px;white-space:nowrap;font-family:inherit;flex-shrink:0;margin-bottom:-1px;-webkit-tap-highlight-color:transparent;}
.tab:hover{color:var(--text2);}
.tab.active{color:var(--indigo);border-bottom-color:var(--indigo);}
.tab i{font-size:15px;}

/* â”€â”€â”€ CONTENT â”€â”€â”€ */
.tab-content{display:none;}
.tab-content.active{display:block;}
.panel{background:var(--white);border:1px solid var(--border);border-radius:var(--r-lg);margin:12px 14px;overflow:hidden;box-shadow:var(--shadow-xs);}

/* â”€â”€â”€ TOOLBAR â”€â”€â”€ */
.toolbar{padding:10px 12px;display:flex;flex-wrap:wrap;gap:8px;align-items:center;border-bottom:1px solid var(--border);background:var(--bg);}
.search-bar{flex:1;min-width:160px;}
.search-bar input{width:100%;background:var(--white);border:1px solid var(--border2);border-radius:999px;padding:9px 14px;color:var(--text);font-size:13px;font-family:inherit;font-weight:500;outline:none;transition:all 0.2s;}
.search-bar input:focus{border-color:var(--indigo);box-shadow:0 0 0 3px rgba(79,70,229,0.1);}
.search-bar input::placeholder{color:var(--text3);}

/* â”€â”€â”€ BUTTONS â”€â”€â”€ */
.btn{padding:9px 16px;border-radius:999px;font-weight:700;font-size:13px;cursor:pointer;border:none;display:inline-flex;align-items:center;gap:6px;font-family:inherit;transition:all 0.18s;white-space:nowrap;-webkit-tap-highlight-color:transparent;}
.btn:active{transform:scale(0.96);}
.btn-primary{background:var(--grad);color:white;box-shadow:0 2px 8px rgba(79,70,229,0.25);}
.btn-primary:hover{box-shadow:0 4px 14px rgba(79,70,229,0.35);transform:translateY(-1px);}
.btn-secondary{background:var(--white);border:1px solid var(--border2);color:var(--text2);}
.btn-secondary:hover{border-color:var(--indigo);color:var(--indigo);background:var(--indigo-l);}

/* â”€â”€â”€ TABLE â”€â”€â”€ */
.table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;}
.data-table{width:100%;border-collapse:collapse;min-width:460px;}
.data-table thead{background:var(--bg);}
.data-table th{padding:10px 14px;text-align:left;color:var(--text3);font-size:10px;text-transform:uppercase;font-weight:700;letter-spacing:0.07em;border-bottom:1px solid var(--border);white-space:nowrap;}
.data-table td{padding:12px 14px;border-bottom:1px solid var(--border);font-size:13px;vertical-align:middle;color:var(--text2);}
.data-table tbody tr{transition:background 0.12s;}
.data-table tbody tr:hover{background:var(--bg);}
.data-table tbody tr:last-child td{border-bottom:none;}

/* Mobile card layout */
@media(max-width:520px){
    .data-table{min-width:unset;}
    .data-table thead{display:none;}
    .data-table,.data-table tbody,.data-table tr,.data-table td{display:block;width:100%;}
    .data-table tr{border-bottom:1px solid var(--border);padding:10px 0;}
    .data-table td{border-bottom:none;padding:4px 14px;display:flex;align-items:flex-start;gap:8px;min-height:28px;}
    .data-table td::before{content:attr(data-label);font-size:10px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;min-width:68px;flex-shrink:0;padding-top:1px;}
    .data-table td.no-label::before{display:none;}
    .data-table td.no-label{padding-top:8px;}
}

/* â”€â”€â”€ USER CELL â”€â”€â”€ */
.user-cell{display:flex;align-items:center;gap:9px;}
.user-avatar{width:32px;height:32px;border-radius:50%;object-fit:cover;border:2px solid var(--border);background:var(--bg2);flex-shrink:0;}
.user-name{font-weight:700;color:var(--text);font-size:13px;}
.user-sub{font-size:11px;color:var(--text3);}

/* â”€â”€â”€ BADGES â”€â”€â”€ */
.badge{display:inline-flex;align-items:center;gap:4px;padding:3px 9px;border-radius:999px;font-size:10px;font-weight:700;letter-spacing:0.04em;text-transform:uppercase;white-space:nowrap;}
.badge-admin{background:var(--indigo-l);color:var(--indigo);}
.badge-user{background:var(--bg2);color:var(--text3);}
.badge-active{background:var(--emerald-l);color:var(--emerald);}
.badge-amber{background:var(--amber-l);color:var(--amber);}

/* â”€â”€â”€ ACTION BUTTONS â”€â”€â”€ */
.act-group{display:flex;align-items:center;gap:3px;flex-wrap:wrap;}
.act-btn{background:none;border:1px solid transparent;color:var(--text3);cursor:pointer;font-size:15px;width:34px;height:34px;min-width:34px;display:inline-flex;align-items:center;justify-content:center;border-radius:var(--r-sm);transition:all 0.15s;font-family:inherit;-webkit-tap-highlight-color:transparent;}
.act-btn:hover{background:var(--bg);border-color:var(--border2);}
.act-btn.view:hover{color:var(--indigo);background:var(--indigo-l);border-color:var(--indigo-m);}
.act-btn.edit:hover{color:var(--amber);background:var(--amber-l);border-color:#fde68a;}
.act-btn.promote:hover{color:var(--emerald);background:var(--emerald-l);border-color:#a7f3d0;}
.act-btn.del:hover{color:var(--rose);background:var(--rose-l);border-color:#fecdd3;}

/* â”€â”€â”€ MODALS â”€â”€â”€ */
.modal{display:none;position:fixed;inset:0;background:rgba(20,25,40,0.45);backdrop-filter:blur(4px);z-index:1000;align-items:flex-end;justify-content:center;}
.modal.active{display:flex;animation:fadeIn 0.2s ease;}
@keyframes fadeIn{from{opacity:0;}to{opacity:1;}}
.modal-sheet{background:var(--white);border-radius:22px 22px 0 0;width:100%;max-width:640px;max-height:92vh;overflow-y:auto;animation:sheetUp 0.3s cubic-bezier(0.34,1.04,0.64,1);padding-bottom:env(safe-area-inset-bottom,16px);box-shadow:0 -4px 40px rgba(20,25,40,0.15);}
@keyframes sheetUp{from{transform:translateY(100%);}to{transform:translateY(0);}}
.modal-handle{width:40px;height:4px;background:var(--border2);border-radius:2px;margin:10px auto 14px;}
.modal-hdr{padding:0 16px 14px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;}
.modal-hdr h3{font-size:16px;font-weight:700;flex:1;color:var(--text);}
.modal-icon{font-size:20px;color:var(--indigo);}
.close-btn{width:32px;height:32px;border-radius:50%;background:var(--bg2);border:1px solid var(--border);color:var(--text2);cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:14px;font-weight:700;transition:all 0.15s;flex-shrink:0;font-family:inherit;}
.close-btn:hover{background:var(--rose-l);border-color:#fecdd3;color:var(--rose);}
.form-grp{padding:14px 16px;}
.form-grp+.form-grp{padding-top:0;}
.form-grp label{display:block;font-size:11px;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:7px;}
.form-grp textarea,.form-grp input[type="text"],.form-grp input[type="email"]{width:100%;background:var(--bg);border:1px solid var(--border2);border-radius:var(--r-sm);padding:11px 13px;color:var(--text);font-size:14px;font-family:inherit;font-weight:500;resize:vertical;outline:none;transition:all 0.2s;}
.form-grp textarea:focus,.form-grp input:focus{border-color:var(--indigo);box-shadow:0 0 0 3px rgba(79,70,229,0.1);}
.form-grp textarea{min-height:90px;}
.form-grp select{width:100%;background:var(--bg);border:1px solid var(--border2);border-radius:var(--r-sm);padding:11px 13px;color:var(--text);font-size:14px;font-family:inherit;font-weight:500;outline:none;cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' viewBox='0 0 24 24' fill='none' stroke='%238b93b8' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center;padding-right:36px;}
.form-grp select:focus{border-color:var(--indigo);box-shadow:0 0 0 3px rgba(79,70,229,0.1);}
.modal-footer{padding:12px 16px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:8px;background:var(--bg);position:sticky;bottom:0;}
.toggle-row{display:flex;align-items:center;gap:12px;padding:11px 13px;background:var(--bg);border:1px solid var(--border2);border-radius:var(--r-sm);cursor:pointer;}
.toggle-row label{font-size:13px;font-weight:600;color:var(--text);cursor:pointer;flex:1;}
.toggle-row input[type="checkbox"]{width:18px;height:18px;accent-color:var(--indigo);cursor:pointer;flex-shrink:0;}

/* â”€â”€â”€ CHECKBOXES â”€â”€â”€ */
#userCheckboxes{max-height:180px;overflow-y:auto;background:var(--bg);border:1px solid var(--border2);border-radius:var(--r-sm);padding:6px;display:flex;flex-direction:column;gap:2px;}
.ucheck{display:flex;align-items:center;gap:10px;padding:8px 10px;border-radius:7px;cursor:pointer;transition:background 0.12s;}
.ucheck:hover{background:var(--indigo-l);}
.ucheck input[type="checkbox"]{width:16px;height:16px;accent-color:var(--indigo);flex-shrink:0;}
.ucheck label{font-size:13px;font-weight:600;color:var(--text);cursor:pointer;flex:1;}
#selectAllBtn{font-size:12px;font-weight:700;color:var(--indigo);background:none;border:none;cursor:pointer;text-align:right;padding:4px 0;font-family:inherit;display:block;width:100%;}

/* â”€â”€â”€ ACTIVITY â”€â”€â”€ */
.activity-item{display:flex;gap:11px;align-items:flex-start;padding:12px 16px;border-bottom:1px solid var(--border);}
.activity-item:last-child{border-bottom:none;}
.act-dot{width:34px;height:34px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:15px;flex-shrink:0;}
.act-text{font-size:13px;color:var(--text2);font-weight:500;line-height:1.5;}
.act-time{font-size:11px;color:var(--text3);margin-top:2px;font-family:'JetBrains Mono',monospace;}

/* â”€â”€â”€ NOTIF ROWS â”€â”€â”€ */
.notif-row{display:flex;gap:10px;align-items:flex-start;padding:12px 14px;border-bottom:1px solid var(--border);}
.notif-row:last-child{border-bottom:none;}
.notif-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0;margin-top:5px;}
.notif-body{flex:1;}
.notif-who{font-size:12px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:6px;flex-wrap:wrap;}
.notif-msg{font-size:13px;color:var(--text2);margin-top:2px;}
.notif-time{font-size:11px;color:var(--text3);margin-top:3px;font-family:'JetBrains Mono',monospace;}

/* â”€â”€â”€ FORM GRIDS â”€â”€â”€ */
.form-grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;}
.form-grid3{display:grid;grid-template-columns:1fr 1fr 1fr;gap:10px;}
@media(max-width:480px){.form-grid2{grid-template-columns:1fr;}.form-grid3{grid-template-columns:1fr 1fr;}}
.section-label{font-size:11px;font-weight:800;color:var(--indigo);text-transform:uppercase;letter-spacing:0.08em;display:flex;align-items:center;gap:6px;padding:4px 0 2px;border-bottom:1px solid var(--border);margin-bottom:2px;}
.section-label i{font-size:13px;}
/* â”€â”€â”€ PREVIEW BOX â”€â”€â”€ */
.preview-box{background:var(--bg);border:1px solid var(--border2);border-radius:var(--r-sm);padding:13px;font-size:13px;color:var(--text2);line-height:1.7;white-space:pre-wrap;word-break:break-word;max-height:220px;overflow-y:auto;}

/* â”€â”€â”€ TOAST â”€â”€â”€ */
.toast{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);background:var(--text);color:white;padding:11px 18px;border-radius:10px;display:flex;align-items:center;gap:9px;z-index:9999;box-shadow:var(--shadow-lg);animation:toastIn 0.3s cubic-bezier(0.34,1.04,0.64,1);max-width:calc(100vw - 32px);font-size:13px;font-weight:600;}
@keyframes toastIn{from{transform:translate(-50%,20px);opacity:0;}to{transform:translate(-50%,0);opacity:1;}}

/* â”€â”€â”€ STATES â”€â”€â”€ */
.empty-state{padding:44px 20px;text-align:center;}
.empty-state i{font-size:36px;color:var(--text3);display:block;margin-bottom:10px;opacity:0.5;}
.empty-state p{font-size:13px;color:var(--text3);font-weight:500;}
.loading-inner{padding:36px 20px;text-align:center;}
.spinner{width:30px;height:30px;border:2px solid var(--border2);border-top-color:var(--indigo);border-radius:50%;animation:spin 0.75s linear infinite;margin:0 auto 10px;}
.loading-inner p{font-size:13px;color:var(--text3);font-weight:500;}

/* â”€â”€â”€ RESPONSIVE â”€â”€â”€ */
@media(max-width:380px){
    .header-logo{font-size:17px;}
    #adminName{display:none;}
    .logout-btn span{display:none;}
    .logout-btn{padding:8px 10px;}
    .stat-value{font-size:22px;}
    .quick-actions{grid-template-columns:1fr;}
}
@media(min-width:768px){
    .stats-grid{padding:18px 20px 0;gap:14px;}
    .quick-actions{padding:14px 20px;gap:12px;}
    .panel{margin:14px 20px;}
    .tabs{padding:0 14px;}
    .header{padding:0 20px;}
}
</style>
</head>
<body>

<div id="loadingOverlay">
    <div class="load-logo">Keli</div>
    <div class="load-ring"></div>
    <p class="load-msg">Verifying admin accessâ€¦</p>
</div>

<div id="app" style="display:none;">

<header class="header">
    <span class="header-logo">Keli</span>
    <span class="header-chip">Admin</span>
    <span class="header-spacer"></span>
    <span id="adminName">Loadingâ€¦</span>
    <button class="logout-btn" onclick="handleLogout()">
        <i class="ri-logout-box-line"></i><span>Logout</span>
    </button>
</header>

<div class="stats-grid">
    <div class="stat-card s-indigo">
        <div class="stat-icon"><i class="ri-user-3-line"></i></div>
        <div class="stat-label">Users</div>
        <div class="stat-value" id="totalUsers">â€”</div>
        <div class="stat-sub" id="userSub">Loadingâ€¦</div>
    </div>
    <div class="stat-card s-emerald">
        <div class="stat-icon"><i class="ri-article-line"></i></div>
        <div class="stat-label">Posts</div>
        <div class="stat-value" id="totalPosts">â€”</div>
        <div class="stat-sub" id="postSub">Loadingâ€¦</div>
    </div>
    <div class="stat-card s-amber">
        <div class="stat-icon"><i class="ri-chat-3-line"></i></div>
        <div class="stat-label">Comments</div>
        <div class="stat-value" id="totalComments">â€”</div>
        <div class="stat-sub" id="commentSub">Loadingâ€¦</div>
    </div>
    <div class="stat-card s-rose">
        <div class="stat-icon"><i class="ri-heart-3-line"></i></div>
        <div class="stat-label">Likes</div>
        <div class="stat-value" id="totalLikes">â€”</div>
        <div class="stat-sub" id="likeSub">Loadingâ€¦</div>
    </div>
</div>

<div class="quick-actions">
    <div class="qaction" onclick="openBroadcastModal()">
        <i class="ri-megaphone-line"></i>
        <div><div class="qa-title">Announce</div><div class="qa-sub">Broadcast to users</div></div>
    </div>
    <div class="qaction" onclick="switchTab('users')">
        <i class="ri-user-settings-line"></i>
        <div><div class="qa-title">Manage Users</div><div class="qa-sub">Edit, promote, delete</div></div>
    </div>
    <div class="qaction" onclick="switchTab('posts')">
        <i class="ri-article-line"></i>
        <div><div class="qa-title">Manage Posts</div><div class="qa-sub">Edit, delete posts</div></div>
    </div>
</div>

<div class="tabs-wrap">
    <div class="tabs">
        <button class="tab active" data-tab="dashboard" onclick="switchTab('dashboard')"><i class="ri-dashboard-line"></i>Dashboard</button>
        <button class="tab" data-tab="users" onclick="switchTab('users')"><i class="ri-user-line"></i>Users</button>
        <button class="tab" data-tab="posts" onclick="switchTab('posts')"><i class="ri-article-line"></i>Posts</button>
        <button class="tab" data-tab="comments" onclick="switchTab('comments')"><i class="ri-chat-3-line"></i>Comments</button>
        <button class="tab" data-tab="announcements" onclick="switchTab('announcements')"><i class="ri-megaphone-line"></i>Announce</button>
        <button class="tab" data-tab="notifications" onclick="switchTab('notifications')"><i class="ri-bell-line"></i>Notifications</button>
    </div>
</div>

<div id="dashboard-tab" class="tab-content active">
    <div class="panel">
        <div style="padding:14px 16px;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:8px;">
            <i class="ri-pulse-line" style="color:var(--indigo);font-size:18px;"></i>
            <span style="font-size:15px;font-weight:700;">Recent Activity</span>
        </div>
        <div id="activityLog"><div class="loading-inner"><div class="spinner"></div><p>Loadingâ€¦</p></div></div>
    </div>
</div>

<div id="users-tab" class="tab-content">
    <div class="panel">
        <div class="toolbar">
            <div class="search-bar"><input type="text" id="userSearch" placeholder="ðŸ” Search usersâ€¦"></div>
            <button class="btn btn-secondary" onclick="loadUsers()"><i class="ri-refresh-line"></i>Refresh</button>
        </div>
        <div class="table-wrap"><div id="usersContainer"><div class="loading-inner"><div class="spinner"></div><p>Loadingâ€¦</p></div></div></div>
    </div>
</div>

<div id="posts-tab" class="tab-content">
    <div class="panel">
        <div class="toolbar">
            <div class="search-bar"><input type="text" id="postSearch" placeholder="ðŸ” Search postsâ€¦"></div>
            <button class="btn btn-secondary" onclick="loadPosts()"><i class="ri-refresh-line"></i>Refresh</button>
        </div>
        <div class="table-wrap"><div id="postsContainer"><div class="loading-inner"><div class="spinner"></div><p>Loadingâ€¦</p></div></div></div>
    </div>
</div>

<div id="comments-tab" class="tab-content">
    <div class="panel">
        <div class="toolbar">
            <div class="search-bar"><input type="text" id="commentSearch" placeholder="ðŸ” Search commentsâ€¦"></div>
            <button class="btn btn-secondary" onclick="loadComments()"><i class="ri-refresh-line"></i>Refresh</button>
        </div>
        <div class="table-wrap"><div id="commentsContainer"><div class="loading-inner"><div class="spinner"></div><p>Loadingâ€¦</p></div></div></div>
    </div>
</div>

<div id="announcements-tab" class="tab-content">
    <div class="panel">
        <div class="toolbar">
            <button class="btn btn-primary" onclick="openBroadcastModal()"><i class="ri-add-line"></i>New</button>
            <button class="btn btn-secondary" onclick="loadAnnouncements()"><i class="ri-refresh-line"></i>Refresh</button>
        </div>
        <div id="announcementsContainer"><div class="loading-inner"><div class="spinner"></div><p>Loadingâ€¦</p></div></div>
    </div>
</div>

<div id="notifications-tab" class="tab-content">
    <div class="panel">
        <div class="toolbar">
            <div class="search-bar"><input type="text" id="notificationSearch" placeholder="ðŸ” Search notificationsâ€¦"></div>
            <button class="btn btn-secondary" onclick="loadAllNotifications()"><i class="ri-refresh-line"></i>Refresh</button>
        </div>
        <div id="notificationsContainer"><div class="loading-inner"><div class="spinner"></div><p>Loadingâ€¦</p></div></div>
    </div>
</div>

</div>

<!-- MODALS -->
<div id="broadcastModal" class="modal">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-hdr"><i class="ri-megaphone-line modal-icon"></i><h3>Post Announcement</h3><button class="close-btn" onclick="closeBroadcastModal()">âœ•</button></div>
        <div class="form-grp"><label>Message</label><textarea id="broadcastContent" placeholder="Write your announcementâ€¦ (include https:// links for clickable)"></textarea></div>
        <div class="form-grp" style="padding-top:0;">
            <label>Recipients</label>
            <div class="form-grp">
                <label>Filter by Type</label>
                <select id="filterType">
                    <option value="">All</option>
                    <option value="User">User</option>
                    <option value="Artist">Artist</option>
                    <option value="Admin">Admin</option>
                </select>
            </div>
            <div class="form-grp" style="padding-top:0;">
                <label>Filter by Role</label>
                <select id="filterRole">
                    <option value="">All</option>
                    <option value="user">user</option>
                    <option value="artist">artist</option>
                    <option value="admin">admin</option>
                    <option value="moderator">moderator</option>
                </select>
            </div>
            <div class="form-grp" style="padding-top:0;">
                <label>Max Recipients (0 for all)</label>
                <input type="number" id="maxRecipients" min="0" value="0">
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeBroadcastModal()">Cancel</button>
            <button class="btn btn-primary" onclick="postAnnouncement()"><i class="ri-send-plane-line"></i>Send</button>
        </div>
    </div>
</div>

<div id="viewModal" class="modal">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-hdr"><i class="ri-eye-line modal-icon"></i><h3 id="viewModalTitle">Preview</h3><button class="close-btn" onclick="closeViewModal()">âœ•</button></div>
        <div class="form-grp"><div id="viewModalContent" class="preview-box"></div></div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeViewModal()">Close</button></div>
    </div>
</div>

<div id="editUserModal" class="modal">
    <div class="modal-sheet" style="max-width:680px;">
        <div class="modal-handle"></div>
        <div class="modal-hdr"><i class="ri-user-settings-line modal-icon"></i><h3>Edit User</h3><button class="close-btn" onclick="closeEditUserModal()">âœ•</button></div>
        <input type="hidden" id="editUserId">

        <!-- Section: Identity -->
        <div style="padding:12px 16px 4px;"><p class="section-label"><i class="ri-user-line"></i> Identity</p></div>
        <div class="form-grp form-grid2">
            <div><label>Stage Name</label><input type="text" id="editStageName" placeholder="Stage name"></div>
            <div><label>Email</label><input type="email" id="editEmail" placeholder="Email"></div>
        </div>
        <div class="form-grp form-grid2" style="padding-top:0;">
            <div><label>User Type</label>
                <select id="editUserType"><option value="User">User</option><option value="Artist">Artist</option><option value="Admin">Admin</option></select>
            </div>
            <div><label>Role</label>
                <select id="editRole"><option value="user">user</option><option value="artist">artist</option><option value="admin">admin</option><option value="moderator">moderator</option></select>
            </div>
        </div>
        <div class="form-grp" style="padding-top:0;">
            <label>Bio</label>
            <textarea id="editBio" placeholder="User bioâ€¦" style="min-height:70px;"></textarea>
        </div>
        <div class="form-grp form-grid2" style="padding-top:0;">
            <div><label>Profile Picture URL</label><input type="text" id="editProfilePicture" placeholder="https://â€¦"></div>
            <div><label>Search Key</label><input type="text" id="editSearchKey" placeholder="search_key"></div>
        </div>
        <div class="form-grp" style="padding-top:0;">
            <label>Status Badge</label>
            <input type="text" id="editStatusBadge" placeholder="e.g. ðŸŽ¤ Verified Artist">
        </div>

        <!-- Section: Tier & Payments -->
        <div style="padding:12px 16px 4px;"><p class="section-label"><i class="ri-vip-crown-line"></i> Tier & Payments</p></div>
        <div class="form-grp form-grid2">
            <div><label>Tier</label>
                <select id="editTier"><option value="basic">basic</option><option value="pro">pro</option><option value="premium">premium</option></select>
            </div>
            <div><label>Payment ID</label><input type="text" id="editPaymentId" placeholder="payment_id"></div>
        </div>
        <div class="form-grp form-grid2" style="padding-top:0;">
            <div><label>Coins</label><input type="number" id="editCoins" placeholder="0" min="0"></div>
            <div><label>Score</label><input type="number" id="editScore" placeholder="0" min="0"></div>
        </div>
        <div class="form-grp" style="padding-top:0;">
            <label>Upgraded At</label>
            <input type="datetime-local" id="editUpgradedAt">
        </div>

        <!-- Section: Limits -->
        <div style="padding:12px 16px 4px;"><p class="section-label"><i class="ri-settings-3-line"></i> Limits & Counts</p></div>
        <div class="form-grp form-grid3">
            <div><label>Max Audio Previews</label><input type="number" id="editMaxAudioPreviews" min="0"></div>
            <div><label>Max Releases</label><input type="number" id="editMaxReleases" min="0"></div>
            <div><label>Max Edits</label><input type="number" id="editMaxEdits" min="0"></div>
        </div>
        <div class="form-grp form-grid3" style="padding-top:0;">
            <div><label>Current Audio Count</label><input type="number" id="editCurrentAudioCount" min="0"></div>
            <div><label>Current Release Count</label><input type="number" id="editCurrentReleaseCount" min="0"></div>
            <div><label>Edits Remaining</label><input type="number" id="editEditsRemaining" min="0"></div>
        </div>
        <div class="form-grp form-grid3" style="padding-top:0;">
            <div><label>Track Count</label><input type="number" id="editTrackCount" min="0"></div>
            <div><label>Collab Count</label><input type="number" id="editCollabCount" min="0"></div>
            <div><label>Invite Count</label><input type="number" id="editInviteCount" min="0"></div>
        </div>
        <div class="form-grp form-grid2" style="padding-top:0;">
            <div><label>Invite Pro</label><input type="number" id="editInvitePro" min="0" placeholder="0"></div>
            <div><label>Invite Code</label><input type="text" id="editInviteCode" placeholder="invite_code"></div>
        </div>
        <div class="form-grp" style="padding-top:0;">
            <label>Invited By Code</label>
            <input type="text" id="editInvitedByCode" placeholder="Code used at signup">
        </div>

        <!-- Section: Access Flags -->
        <div style="padding:12px 16px 4px;"><p class="section-label"><i class="ri-shield-check-line"></i> Access Flags</p></div>
        <div class="form-grp" style="display:flex;flex-direction:column;gap:8px;">
            <div class="toggle-row" onclick="document.getElementById('editIsAdmin').click()">
                <label for="editIsAdmin">Admin access (is_admin)</label>
                <input type="checkbox" id="editIsAdmin">
            </div>
            <div class="toggle-row" onclick="document.getElementById('editCanSeeInvite').click()">
                <label for="editCanSeeInvite">Can see invite page (can_see_invite)</label>
                <input type="checkbox" id="editCanSeeInvite">
            </div>
        </div>

        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeEditUserModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveUserEdit()"><i class="ri-save-line"></i>Save Changes</button>
        </div>
    </div>
</div>

<div id="editPostModal" class="modal">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-hdr"><i class="ri-edit-line modal-icon"></i><h3>Edit Post</h3><button class="close-btn" onclick="closeEditPostModal()">âœ•</button></div>
        <input type="hidden" id="editPostId">
        <div class="form-grp"><label>Content</label><textarea id="editPostContent" placeholder="Post contentâ€¦" style="min-height:130px;"></textarea></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeEditPostModal()">Cancel</button>
            <button class="btn btn-primary" onclick="savePostEdit()"><i class="ri-save-line"></i>Save</button>
        </div>
    </div>
</div>

<div id="editCommentModal" class="modal">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-hdr"><i class="ri-edit-line modal-icon"></i><h3>Edit Comment</h3><button class="close-btn" onclick="closeEditCommentModal()">âœ•</button></div>
        <input type="hidden" id="editCommentId">
        <div class="form-grp"><label>Content</label><textarea id="editCommentContent" placeholder="Comment contentâ€¦"></textarea></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeEditCommentModal()">Cancel</button>
            <button class="btn btn-primary" onclick="saveCommentEdit()"><i class="ri-save-line"></i>Save</button>
        </div>
    </div>
</div>

<div id="adminCommentModal" class="modal">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-hdr"><i class="ri-shield-star-line modal-icon"></i><h3>Comment as Admin</h3><button class="close-btn" onclick="closeAdminCommentModal()">âœ•</button></div>
        <div id="postCommentsContainer" style="max-height:200px;overflow-y:auto;border-bottom:1px solid var(--border);"><div class="loading-inner" style="padding:16px;"><div class="spinner" style="width:22px;height:22px;border-width:2px;"></div></div></div>
        <div class="form-grp"><label>Your Comment</label><textarea id="adminCommentText" placeholder="Write your commentâ€¦"></textarea></div>
        <div class="modal-footer">
            <button class="btn btn-secondary" onclick="closeAdminCommentModal()">Cancel</button>
            <button class="btn btn-primary" onclick="postAdminComment()"><i class="ri-send-plane-line"></i>Post</button>
        </div>
    </div>
</div>

<div id="announcementModal" class="modal">
    <div class="modal-sheet">
        <div class="modal-handle"></div>
        <div class="modal-hdr"><i class="ri-megaphone-line modal-icon"></i><h3>Announcement</h3><button class="close-btn" onclick="closeAnnouncementModal()">âœ•</button></div>
        <div class="form-grp" id="announcementModalContent"></div>
        <div class="modal-footer"><button class="btn btn-secondary" onclick="closeAnnouncementModal()">Close</button></div>
    </div>
</div>

<script type="module">
import { createClient } from "https://esm.sh/@supabase/supabase-js@2";

const SUPABASE_URL = 'https://xaudpqhyyxburjazfips.supabase.co';
const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhhdWRwcWh5eXhidXJqYXpmaXBzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjIzMTY1NDUsImV4cCI6MjA3Nzg5MjU0NX0.LxRbfT0TsxJ38dwTQyKhn_Hi1cuZXZ6tpE04YPatGkQ';
const supabase = createClient(SUPABASE_URL, SUPABASE_KEY);
window.supabase = supabase;

let currentAdmin = null, currentPostForComment = null;
let allUsers = [], allPosts = [], allComments = [], allNotifications = [];

/* AUTH */
async function checkAdmin() {
    const { data:{session} } = await supabase.auth.getSession();
    if (!session) { window.location.href='login.html'; return false; }
    const { data:p, error } = await supabase.from('profiles').select('*').eq('id',session.user.id).single();
    if (error||!p) { showToast('Error loading profile','rose'); return false; }
    currentAdmin = p;
    document.getElementById('adminName').textContent = `Hi, ${p.stage_name||'Admin'}`;
    if (p.user_type!=='Admin' && !p.is_admin) { showToast('Access denied','rose'); setTimeout(()=>window.location.href='home.html',2000); return false; }
    return true;
}

/* STATS */
async function loadStats() {
    try {
        const [u,po,c,l] = await Promise.all([
            supabase.from('profiles').select('id',{count:'exact',head:true}),
            supabase.from('posts').select('id',{count:'exact',head:true}),
            supabase.from('comments').select('id',{count:'exact',head:true}),
            supabase.from('post_likes').select('id',{count:'exact',head:true})
        ]);
        document.getElementById('totalUsers').textContent=u.count??0;
        document.getElementById('totalPosts').textContent=po.count??0;
        document.getElementById('totalComments').textContent=c.count??0;
        document.getElementById('totalLikes').textContent=l.count??0;
        document.getElementById('userSub').textContent=`${u.count??0} registered`;
        document.getElementById('postSub').textContent=`${po.count??0} published`;
        document.getElementById('commentSub').textContent=`${c.count??0} total`;
        document.getElementById('likeSub').textContent=`${l.count??0} total`;
    } catch(e){console.error(e);}
}

/* ACTIVITY */
async function loadActivityLog() {
    const el = document.getElementById('activityLog');
    try {
        const [{data:posts},{data:comments},{data:users}] = await Promise.all([
            supabase.from('posts').select('*,profiles(stage_name)').order('created_at',{ascending:false}).limit(6),
            supabase.from('comments').select('*,profiles(stage_name)').order('created_at',{ascending:false}).limit(6),
            supabase.from('profiles').select('*').order('created_at',{ascending:false}).limit(5)
        ]);
        const items = [
            ...(posts||[]).map(p=>({type:'post',name:p.profiles?.stage_name||'User',time:p.created_at})),
            ...(comments||[]).map(c=>({type:'comment',name:c.profiles?.stage_name||'User',time:c.created_at})),
            ...(users||[]).map(u=>({type:'user',name:u.stage_name||'Someone',time:u.created_at}))
        ].sort((a,b)=>new Date(b.time)-new Date(a.time)).slice(0,18);
        if(!items.length){el.innerHTML='<div class="empty-state"><i class="ri-inbox-line"></i><p>No activity yet</p></div>';return;}
        el.innerHTML=items.map(a=>{
            const [ico,bg,clr,lbl]=a.type==='post'?['ri-article-line','var(--emerald-l)','var(--emerald)','created a post']:
                a.type==='comment'?['ri-chat-3-line','var(--amber-l)','var(--amber)','posted a comment']:
                ['ri-user-add-line','var(--indigo-l)','var(--indigo)','just joined'];
            return `<div class="activity-item"><div class="act-dot" style="background:\( {bg};color: \){clr};"><i class="\( {ico}"></i></div><div><div class="act-text"><strong> \){a.name}</strong> \( {lbl}</div><div class="act-time"> \){timeAgo(a.time)}</div></div></div>`;
        }).join('');
    } catch(e){el.innerHTML='<div class="empty-state"><p>Error loading activity</p></div>';}
}

/* USERS */
window.loadUsers = async function() {
    const c=document.getElementById('usersContainer'); c.innerHTML=loading();
    const s=(document.getElementById('userSearch')?.value||'').toLowerCase();
    const {data,error}=await supabase.from('profiles').select('*').order('created_at',{ascending:false});
    if(error){c.innerHTML=err();return;}
    allUsers=data||[];
    let f=allUsers; if(s) f=allUsers.filter(u=>
        u.stage_name?.toLowerCase().includes(s)||
        u.email?.toLowerCase().includes(s)||
        u.user_type?.toLowerCase().includes(s)||
        u.tier?.toLowerCase().includes(s)||
        u.role?.toLowerCase().includes(s)
    );
    if(!f.length){c.innerHTML='<div class="empty-state"><i class="ri-user-line"></i><p>No users found</p></div>';return;}
    c.innerHTML=`<table class="data-table"><thead><tr>
        <th>User</th><th>Type / Role</th><th>Tier</th><th>Admin</th>
        <th>Score</th><th>Coins</th><th>Tracks</th><th>Invites</th><th>Joined</th><th>Actions</th>
    </tr></thead><tbody>${
        f.map(u=>`<tr>
        <td data-label="User" class="no-label"><div class="user-cell">
            <img src="\( {u.profile_picture||'user.webp'}" class="user-avatar" onerror="this.src='https://ui-avatars.com/api/?name= \){encodeURIComponent(u.stage_name||'U')}&background=4f46e5&color=fff'">
            <div><div class="user-name">\( {u.stage_name||'â€”'}</div><div class="user-sub"> \){u.email||u.id.substring(0,10)+'â€¦'}</div></div>
        </div></td>
        <td data-label="Type/Role"><div style="display:flex;flex-direction:column;gap:3px;">
            <span class="badge \( {u.user_type==='Admin'?'badge-admin':'badge-user'}"> \){u.user_type||'User'}</span>
            <span style="font-size:11px;color:var(--text3);">${u.role||'user'}</span>
        </div></td>
        <td data-label="Tier"><span class="badge \( {u.tier==='pro'?'badge-amber':u.tier==='premium'?'badge-admin':'badge-user'}"> \){u.tier||'basic'}</span></td>
        <td data-label="Admin">${u.is_admin?'<span class="badge badge-active"><i class="ri-shield-check-line"></i> Yes</span>':'<span class="badge badge-user">No</span>'}</td>
        <td data-label="Score"><strong>${u.score??0}</strong></td>
        <td data-label="Coins"><strong>${u.coins??0}</strong></td>
        <td data-label="Tracks"><strong>${u.track_count??0}</strong></td>
        <td data-label="Invites"><strong>${u.invite_count??0}</strong></td>
        <td data-label="Joined">${new Date(u.created_at).toLocaleDateString()}</td>
        <td class="no-label" style="padding-top:6px;"><div class="act-group">
            <button class="act-btn edit" title="Edit" onclick="openEditUser('${u.id}')"><i class="ri-edit-line"></i></button>
            <button class="act-btn promote" title="\( {u.is_admin?'Revoke admin':'Make admin'}" onclick="toggleAdmin(' \){u.id}',\( {u.is_admin})"><i class="ri- \){u.is_admin?'user-line':'shield-star-line'}"></i></button>
            <button class="act-btn del" title="Delete" onclick="deleteUser('\( {u.id}',' \){(u.stage_name||'').replace(/'/g,"\\'")}')"><i class="ri-delete-bin-line"></i></button>
        </div></td></tr>`).join('')
    }</tbody></table>`;
};

window.openEditUser=function(id){
    const u=allUsers.find(x=>x.id===id); if(!u) return;
    // Identity
    document.getElementById('editUserId').value          = u.id;
    document.getElementById('editStageName').value       = u.stage_name||'';
    document.getElementById('editEmail').value           = u.email||'';
    document.getElementById('editUserType').value        = u.user_type||'User';
    document.getElementById('editRole').value            = u.role||'user';
    document.getElementById('editBio').value             = u.bio||'';
    document.getElementById('editProfilePicture').value  = u.profile_picture||'';
    document.getElementById('editSearchKey').value       = u.search_key||'';
    document.getElementById('editStatusBadge').value     = u.status_badge||'';
    // Tier & payments
    document.getElementById('editTier').value            = u.tier||'basic';
    document.getElementById('editPaymentId').value       = u.payment_id||'';
    document.getElementById('editCoins').value           = u.coins??0;
    document.getElementById('editScore').value           = u.score??0;
    document.getElementById('editUpgradedAt').value      = u.upgraded_at ? u.upgraded_at.substring(0,16) : '';
    // Limits & counts
    document.getElementById('editMaxAudioPreviews').value   = u.max_audio_previews??10;
    document.getElementById('editMaxReleases').value        = u.max_releases??6;
    document.getElementById('editMaxEdits').value           = u.max_edits??1;
    document.getElementById('editCurrentAudioCount').value  = u.current_audio_count??0;
    document.getElementById('editCurrentReleaseCount').value= u.current_release_count??0;
    document.getElementById('editEditsRemaining').value     = u.edits_remaining??1;
    document.getElementById('editTrackCount').value         = u.track_count??0;
    document.getElementById('editCollabCount').value        = u.collab_count??0;
    document.getElementById('editInviteCount').value        = u.invite_count??0;
    document.getElementById('editInvitePro').value          = u.invite_pro??0;
    document.getElementById('editInviteCode').value         = u.invite_code||'';
    document.getElementById('editInvitedByCode').value      = u.invited_by_code||'';
    // Flags
    document.getElementById('editIsAdmin').checked      = !!u.is_admin;
    document.getElementById('editCanSeeInvite').checked = !!u.can_see_invite;
    document.getElementById('editUserModal').classList.add('active');
};

window.closeEditUserModal=()=>document.getElementById('editUserModal').classList.remove('active');

window.saveUserEdit=async function(){
    const id=document.getElementById('editUserId').value;
    const upgAt=document.getElementById('editUpgradedAt').value;
    const payload={
        stage_name:           document.getElementById('editStageName').value,
        email:                document.getElementById('editEmail').value,
        user_type:            document.getElementById('editUserType').value,
        role:                 document.getElementById('editRole').value,
        bio:                  document.getElementById('editBio').value,
        profile_picture:      document.getElementById('editProfilePicture').value,
        search_key:           document.getElementById('editSearchKey').value,
        status_badge:         document.getElementById('editStatusBadge').value,
        tier:                 document.getElementById('editTier').value,
        payment_id:           document.getElementById('editPaymentId').value||null,
        coins:         parseInt(document.getElementById('editCoins').value)||0,
        score:         parseInt(document.getElementById('editScore').value)||0,
        upgraded_at:          upgAt ? new Date(upgAt).toISOString() : null,
        max_audio_previews:   parseInt(document.getElementById('editMaxAudioPreviews').value)||10,
        max_releases:         parseInt(document.getElementById('editMaxReleases').value)||6,
        max_edits:            parseInt(document.getElementById('editMaxEdits').value)||1,
        current_audio_count:  parseInt(document.getElementById('editCurrentAudioCount').value)||0,
        current_release_count:parseInt(document.getElementById('editCurrentReleaseCount').value)||0,
        edits_remaining:      parseInt(document.getElementById('editEditsRemaining').value)||0,
        track_count:          parseInt(document.getElementById('editTrackCount').value)||0,
        collab_count:         parseInt(document.getElementById('editCollabCount').value)||0,
        invite_count:         parseInt(document.getElementById('editInviteCount').value)||0,
        invite_pro:           parseInt(document.getElementById('editInvitePro').value)||0,
        invite_code:          document.getElementById('editInviteCode').value||null,
        invited_by_code:      document.getElementById('editInvitedByCode').value||null,
        is_admin:             document.getElementById('editIsAdmin').checked,
        can_see_invite:       document.getElementById('editCanSeeInvite').checked,
        last_profile_update:  new Date().toISOString(),
    };
    const{error}=await supabase.from('profiles').update(payload).eq('id',id);
    if(error){showToast('Error: '+error.message,'rose');return;}
    showToast('User updated!','emerald');
    closeEditUserModal();
    loadUsers();
};
window.toggleAdmin=async function(id,cur){if(!confirm(`${cur?'Revoke':'Grant'} admin for this user?`))return;const{error}=await supabase.from('profiles').update({is_admin:!cur}).eq('id',id);if(error){showToast('Error: '+error.message,'rose');return;}showToast(cur?'Admin revoked':'Admin granted!',cur?'amber':'emerald');loadUsers();};
window.deleteUser=async function(id,name){if(!confirm(`Delete \( {name}? This permanently removes all their data!`))return;await Promise.all([supabase.from('posts').delete().eq('user_id',id),supabase.from('comments').delete().eq('user_id',id),supabase.from('post_likes').delete().eq('user_id',id),supabase.from('post_shares').delete().eq('user_id',id),supabase.from('post_bookmarks').delete().eq('user_id',id),supabase.from('notifications').delete().eq('user_id',id)]);await supabase.from('profiles').delete().eq('id',id);showToast(` \){name} deleted`,'rose');loadUsers();loadStats();};

/* POSTS */
window.loadPosts=async function(){const c=document.getElementById('postsContainer');c.innerHTML=loading();const s=(document.getElementById('postSearch')?.value||'').toLowerCase();const{data,error}=await supabase.from('posts').select('*,profiles(stage_name,profile_picture)').order('created_at',{ascending:false});if(error){c.innerHTML=err();return;}allPosts=data||[];let f=allPosts;if(s)f=allPosts.filter(p=>p.content?.toLowerCase().includes(s)||p.profiles?.stage_name?.toLowerCase().includes(s));if(!f.length){c.innerHTML='<div class="empty-state"><i class="ri-article-line"></i><p>No posts found</p></div>';return;}
c.innerHTML=`<table class="data-table"><thead><tr><th>Author</th><th>Content</th><th>â¤ï¸</th><th>ðŸ’¬</th><th>Date</th><th>Actions</th></tr></thead><tbody>${
    f.map(p=>{const prev=(p.content||'').substring(0,70)+(p.content?.length>70?'â€¦':'');return`<tr>
    <td class="no-label"><div class="user-cell"><img src="\( {p.profiles?.profile_picture||'user.webp'}" class="user-avatar" onerror="this.src='https://ui-avatars.com/api/?name= \){encodeURIComponent(p.profiles?.stage_name||'U')}&background=4f46e5&color=fff'"><span class="user-name">${p.profiles?.stage_name||'â€”'}</span></div></td>
    <td data-label="Content" style="max-width:200px;">${prev}</td>
    <td data-label="Likes"><strong>${p.likes||0}</strong></td>
    <td data-label="Comments"><strong>${p.comments||0}</strong></td>
    <td data-label="Date">${new Date(p.created_at).toLocaleDateString()}</td>
    <td class="no-label" style="padding-top:6px;"><div class="act-group">
        <button class="act-btn view" title="View" onclick="viewContent('Post',\`${(p.content||'').replace(/`/g,'\\`')}\`)"><i class="ri-eye-line"></i></button>
        <button class="act-btn edit" title="Edit" onclick="openEditPost('${p.id}')"><i class="ri-edit-line"></i></button>
        <button class="act-btn promote" title="Admin comment" onclick="openAdminComment('${p.id}')"><i class="ri-chat-3-line"></i></button>
        <button class="act-btn del" title="Delete" onclick="deletePost('${p.id}')"><i class="ri-delete-bin-line"></i></button>
    </div></td></tr>`;}).join('')
}</tbody></table>`;};
window.openEditPost=function(id){const p=allPosts.find(x=>x.id===id);if(!p)return;document.getElementById('editPostId').value=p.id;document.getElementById('editPostContent').value=p.content||'';document.getElementById('editPostModal').classList.add('active');};
window.closeEditPostModal=()=>document.getElementById('editPostModal').classList.remove('active');
window.savePostEdit=async function(){const id=document.getElementById('editPostId').value;const content=document.getElementById('editPostContent').value;const{error}=await supabase.from('posts').update({content}).eq('id',id);if(error){showToast('Error: '+error.message,'rose');return;}showToast('Post updated!','emerald');closeEditPostModal();loadPosts();};
window.deletePost=async function(id){if(!confirm('Delete this post and all comments?'))return;await Promise.all([supabase.from('comments').delete().eq('post_id',id),supabase.from('post_likes').delete().eq('post_id',id),supabase.from('post_shares').delete().eq('post_id',id),supabase.from('post_bookmarks').delete().eq('post_id',id)]);await supabase.from('posts').delete().eq('id',id);showToast('Post deleted','rose');loadPosts();loadStats();};
window.openAdminComment=async function(id){currentPostForComment=id;document.getElementById('adminCommentText').value='';document.getElementById('adminCommentModal').classList.add('active');await loadPostComments(id);};
window.closeAdminCommentModal=function(){document.getElementById('adminCommentModal').classList.remove('active');currentPostForComment=null;};
async function loadPostComments(postId){const el=document.getElementById('postCommentsContainer');const{data}=await supabase.from('comments').select('*,profiles(stage_name,profile_picture,is_admin)').eq('post_id',postId).order('created_at',{ascending:false});if(!data?.length){el.innerHTML='<p style="padding:12px 16px;color:var(--text3);font-size:13px;">No comments yet.</p>';return;}el.innerHTML=data.map(cc=>`<div class="notif-row"><img src="\( {cc.profiles?.profile_picture||'user.webp'}" class="user-avatar" style="width:28px;height:28px;" onerror="this.src='https://ui-avatars.com/api/?name= \){encodeURIComponent(cc.profiles?.stage_name||'U')}&background=4f46e5&color=fff'"><div class="notif-body"><div class="notif-who">\( {cc.profiles?.stage_name||'â€”'} \){cc.profiles?.is_admin?'<span class="badge badge-admin">Admin</span>':''}</div><div class="notif-msg">\( {cc.content}</div><div class="notif-time"> \){timeAgo(cc.created_at)}</div></div></div>`).join('');}
window.postAdminComment=async function(){const content=document.getElementById('adminCommentText').value.trim();if(!content){showToast('Write something first','amber');return;}const{error}=await supabase.from('comments').insert({post_id:currentPostForComment,user_id:currentAdmin.id,content});if(error){showToast('Error: '+error.message,'rose');return;}const{data:post}=await supabase.from('posts').select('comments').eq('id',currentPostForComment).single();await supabase.from('posts').update({comments:(post?.comments||0)+1}).eq('id',currentPostForComment);showToast('Comment posted!','emerald');document.getElementById('adminCommentText').value='';await loadPostComments(currentPostForComment);loadPosts();loadStats();};

/* COMMENTS */
window.loadComments=async function(){const c=document.getElementById('commentsContainer');c.innerHTML=loading();const s=(document.getElementById('commentSearch')?.value||'').toLowerCase();const{data,error}=await supabase.from('comments').select('*,profiles(stage_name,profile_picture),posts(content)').order('created_at',{ascending:false}).limit(200);if(error){c.innerHTML=err();return;}allComments=data||[];let f=allComments;if(s)f=allComments.filter(x=>x.content?.toLowerCase().includes(s)||x.profiles?.stage_name?.toLowerCase().includes(s));if(!f.length){c.innerHTML='<div class="empty-state"><i class="ri-chat-3-line"></i><p>No comments found</p></div>';return;}
c.innerHTML=`<table class="data-table"><thead><tr><th>Author</th><th>Comment</th><th>Post</th><th>Date</th><th>Actions</th></tr></thead><tbody>${
    f.map(x=>`<tr>
    <td class="no-label"><div class="user-cell"><img src="\( {x.profiles?.profile_picture||'user.webp'}" class="user-avatar" onerror="this.src='https://ui-avatars.com/api/?name= \){encodeURIComponent(x.profiles?.stage_name||'U')}&background=4f46e5&color=fff'"><span class="user-name">${x.profiles?.stage_name||'â€”'}</span></div></td>
    <td data-label="Comment" style="max-width:180px;">\( {(x.content||'').substring(0,70)} \){x.content?.length>70?'â€¦':''}</td>
    <td data-label="Post" style="max-width:120px;color:var(--text3);font-size:12px;">${(x.posts?.content||'').substring(0,40)}â€¦</td>
    <td data-label="Date">${new Date(x.created_at).toLocaleDateString()}</td>
    <td class="no-label" style="padding-top:6px;"><div class="act-group">
        <button class="act-btn edit" title="Edit" onclick="openEditComment('${x.id}')"><i class="ri-edit-line"></i></button>
        <button class="act-btn del" title="Delete" onclick="deleteComment('\( {x.id}',' \){x.post_id}')"><i class="ri-delete-bin-line"></i></button>
    </div></td></tr>`).join('')
}</tbody></table>`;};
window.openEditComment=function(id){const x=allComments.find(c=>c.id===id);if(!x)return;document.getElementById('editCommentId').value=x.id;document.getElementById('editCommentContent').value=x.content||'';document.getElementById('editCommentModal').classList.add('active');};
window.closeEditCommentModal=()=>document.getElementById('editCommentModal').classList.remove('active');
window.saveCommentEdit=async function(){const id=document.getElementById('editCommentId').value;const content=document.getElementById('editCommentContent').value;const{error}=await supabase.from('comments').update({content}).eq('id',id);if(error){showToast('Error: '+error.message,'rose');return;}showToast('Comment updated!','emerald');closeEditCommentModal();loadComments();};
window.deleteComment=async function(id,postId){if(!confirm('Delete this comment?'))return;await supabase.from('comments').delete().eq('id',id);const{data:post}=await supabase.from('posts').select('comments').eq('id',postId).single();await supabase.from('posts').update({comments:Math.max(0,(post?.comments||1)-1)}).eq('id',postId);showToast('Comment deleted','rose');loadComments();loadStats();};

/* ANNOUNCEMENTS */
window.openBroadcastModal=async function(){document.getElementById('broadcastContent').value='';document.getElementById('filterType').value='';document.getElementById('filterRole').value='';document.getElementById('maxRecipients').value=0;document.getElementById('broadcastModal').classList.add('active');};
window.closeBroadcastModal=()=>document.getElementById('broadcastModal').classList.remove('active');
window.postAnnouncement=async function(){const content=document.getElementById('broadcastContent').value.trim();if(!content){showToast('Write a message first','amber');return;}const type=document.getElementById('filterType').value;const role=document.getElementById('filterRole').value;const max=parseInt(document.getElementById('maxRecipients').value)||0;let query=supabase.from('profiles').select('id').neq('id',currentAdmin.id);if(type)query=query.eq('user_type',type);if(role)query=query.eq('role',role);query=query.order('created_at',{ascending:false});if(max>0)query=query.limit(max);const{data:users,error}=await query;if(error){showToast('Error: '+error.message,'rose');return;}const ids=users?.map(u=>u.id)||[];if(!ids.length){showToast('No users match filters','amber');return;}const{error:insErr}=await supabase.from('notifications').insert(ids.map(uid=>({user_id:uid,actor_id:currentAdmin.id,type:'announcement',content})));if(insErr){showToast('Error: '+insErr.message,'rose');return;}showToast(`Sent to ${ids.length} users!`,'emerald');closeBroadcastModal();if(document.getElementById('announcements-tab').classList.contains('active'))loadAnnouncements();};
window.loadAnnouncements=async function(){const c=document.getElementById('announcementsContainer');c.innerHTML=loading();const{data,error}=await supabase.from('notifications').select('id,content,created_at,actor_id').eq('actor_id',currentAdmin?.id).neq('user_id',currentAdmin?.id).order('created_at',{ascending:false});if(error){c.innerHTML=err();return;}const seen=new Set();const unique=(data||[]).filter(n=>{const k=n.content+n.created_at;if(seen.has(k))return false;seen.add(k);return true;});if(!unique.length){c.innerHTML='<div class="empty-state"><i class="ri-megaphone-line"></i><p>No announcements yet</p></div>';return;}c.innerHTML=unique.map(a=>`<div class="notif-row"><div class="notif-dot" style="background:var(--indigo);"></div><div class="notif-body"><div class="notif-who"><span class="badge badge-admin">Announcement</span></div><div class="notif-msg">\( {linkify((a.content||'').substring(0,100))} \){a.content?.length>100?'â€¦':''}</div><div class="notif-time">\( {new Date(a.created_at).toLocaleString()}</div></div><div class="act-group" style="flex-direction:column;gap:4px;"><button class="act-btn view" title="View" onclick="viewAnnouncement(' \){a.id}')"><i class="ri-eye-line"></i></button><button class="act-btn del" title="Delete" onclick="deleteAnnouncement(\`\( {a.content.replace(/`/g,'\\`')}\`,' \){a.created_at}')"><i class="ri-delete-bin-line"></i></button></div></div>`).join('');};
window.viewAnnouncement=async function(id){const{data}=await supabase.from('notifications').select('content,created_at').eq('id',id).single();if(!data)return;document.getElementById('announcementModalContent').innerHTML=`<p style="font-size:12px;color:var(--text3);margin-bottom:10px;">Sent: \( {new Date(data.created_at).toLocaleString()}</p><div class="preview-box"> \){linkify(data.content)}</div>`;document.getElementById('announcementModal').classList.add('active');};
window.closeAnnouncementModal=()=>document.getElementById('announcementModal').classList.remove('active');
window.deleteAnnouncement=async function(content,createdAt){if(!confirm('Delete for all recipients?'))return;const{error}=await supabase.from('notifications').delete().eq('content',content).eq('created_at',createdAt).eq('actor_id',currentAdmin.id);if(error){showToast('Error: '+error.message,'rose');return;}showToast('Announcement deleted','rose');loadAnnouncements();};

/* NOTIFICATIONS */
window.loadAllNotifications=async function(){const c=document.getElementById('notificationsContainer');c.innerHTML=loading();const s=(document.getElementById('notificationSearch')?.value||'').toLowerCase();const{data,error}=await supabase.from('notifications').select('*,profiles!notifications_user_id_fkey(stage_name)').order('created_at',{ascending:false}).limit(200);if(error){c.innerHTML=err();return;}allNotifications=data||[];let f=allNotifications;if(s)f=allNotifications.filter(n=>n.content?.toLowerCase().includes(s)||n.profiles?.stage_name?.toLowerCase().includes(s));if(!f.length){c.innerHTML='<div class="empty-state"><i class="ri-bell-line"></i><p>No notifications</p></div>';return;}c.innerHTML=f.map(n=>`<div class="notif-row"><div class="notif-dot" style="background:\( {n.type==='announcement'?'var(--indigo)':'var(--emerald)'};"></div><div class="notif-body"><div class="notif-who"> \){n.profiles?.stage_name||'â€”'}<span class="badge \( {n.type==='announcement'?'badge-admin':'badge-active'}"> \){n.type||'notif'}</span></div><div class="notif-msg">\( {n.type==='announcement'?linkify((n.content||'').substring(0,100)):(n.content||'').substring(0,100)} \){n.content?.length>100?'â€¦':''}</div><div class="notif-time">\( {timeAgo(n.created_at)}</div></div><button class="act-btn del" title="Delete" onclick="deleteNotification(' \){n.id}')"><i class="ri-delete-bin-line"></i></button></div>`).join('');};
window.deleteNotification=async function(id){if(!confirm('Delete this notification?'))return;const{error}=await supabase.from('notifications').delete().eq('id',id);if(error){showToast('Error: '+error.message,'rose');return;}showToast('Deleted','rose');loadAllNotifications();};

/* GENERIC VIEW */
window.viewContent=function(title,content){document.getElementById('viewModalTitle').textContent=title;document.getElementById('viewModalContent').textContent=content;document.getElementById('viewModal').classList.add('active');};
window.closeViewModal=()=>document.getElementById('viewModal').classList.remove('active');

/* TABS */
window.switchTab=function(tab){document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));document.querySelector(`[data-tab="\( {tab}"]`)?.classList.add('active');document.getElementById(` \){tab}-tab`)?.classList.add('active');if(tab==='dashboard')loadActivityLog();else if(tab==='users')loadUsers();else if(tab==='posts')loadPosts();else if(tab==='comments')loadComments();else if(tab==='announcements')loadAnnouncements();else if(tab==='notifications')loadAllNotifications();};

/* LOGOUT */
window.handleLogout=async function(){if(confirm('Log out?')){await supabase.auth.signOut();window.location.href='login.html';}};

/* TOAST */
window.showToast=function(msg,type='emerald'){const clr={emerald:'#059669',rose:'#e11d48',amber:'#d97706',indigo:'#4f46e5'};const ico={emerald:'ri-check-line',rose:'ri-error-warning-line',amber:'ri-alert-line',indigo:'ri-information-line'};const t=document.createElement('div');t.className='toast';t.style.borderLeft=`3px solid \( {clr[type]||clr.emerald}`;t.innerHTML=`<i class=" \){ico[type]||ico.emerald}" style="color:\( {clr[type]||clr.emerald}"></i><span> \){msg}</span>`;document.body.appendChild(t);setTimeout(()=>{t.style.opacity='0';t.style.transition='opacity 0.3s';setTimeout(()=>t.remove(),300);},3000);};

/* HELPERS */
function loading(){return'<div class="loading-inner"><div class="spinner"></div><p>Loadingâ€¦</p></div>';}
function err(){return'<div class="empty-state"><i class="ri-error-warning-line"></i><p>Error loading data</p></div>';}
function timeAgo(d){const s=Math.floor((Date.now()-new Date(d))/1000);if(s<60)return`\( {s}s ago`;if(s<3600)return` \){Math.floor(s/60)}m ago`;if(s<86400)return`\( {Math.floor(s/3600)}h ago`;if(s<2592000)return` \){Math.floor(s/86400)}d ago`;return new Date(d).toLocaleDateString();}
function debounce(fn,ms){let t;return(...a)=>{clearTimeout(t);t=setTimeout(()=>fn(...a),ms);};}
function linkify(text){return text.replace(/(https?:\/\/[^\s<]+)/g,'<a href="$1" target="_blank" style="color:var(--indigo);text-decoration:underline;">$1</a>');}

/* REALTIME */
function wireRealtime(){
    supabase.channel('keli-admin').on('postgres_changes',{event:'*',schema:'public',table:'profiles'},()=>{loadStats();if(document.getElementById('users-tab').classList.contains('active'))loadUsers();}).on('postgres_changes',{event:'*',schema:'public',table:'posts'},()=>{loadStats();if(document.getElementById('posts-tab').classList.contains('active'))loadPosts();}).on('postgres_changes',{event:'*',schema:'public',table:'comments'},()=>{loadStats();if(document.getElementById('comments-tab').classList.contains('active'))loadComments();}).on('postgres_changes',{event:'*',schema:'public',table:'notifications'},()=>{if(document.getElementById('announcements-tab').classList.contains('active'))loadAnnouncements();if(document.getElementById('notifications-tab').classList.contains('active'))loadAllNotifications();}).subscribe();
    setInterval(loadStats,30000);
}

/* INIT */
async function init(){
    const ok=await checkAdmin();
    const overlay=document.getElementById('loadingOverlay');
    if(!ok){overlay.querySelector('.load-msg').textContent='Access denied. Redirectingâ€¦';return;}
    overlay.style.opacity='0';overlay.style.transition='opacity 0.35s';
    setTimeout(()=>overlay.remove(),350);
    document.getElementById('app').style.display='block';
    await Promise.all([loadStats(),loadActivityLog()]);
    document.getElementById('userSearch')?.addEventListener('input',debounce(loadUsers,400));
    document.getElementById('postSearch')?.addEventListener('input',debounce(loadPosts,400));
    document.getElementById('commentSearch')?.addEventListener('input',debounce(loadComments,400));
    document.getElementById('notificationSearch')?.addEventListener('input',debounce(loadAllNotifications,400));
    wireRealtime();
    showToast('Dashboard ready ðŸ‘‹','indigo');
}
init();
</script>
</body>
</html>